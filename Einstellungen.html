<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            color: #ffffff;
            min-height: 100vh;
            padding: 1rem;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(120deg); }
            66% { transform: translateY(10px) rotate(240deg); }
        }
        
        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.03) 2px,
                    rgba(255, 255, 255, 0.03) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.03) 2px,
                    rgba(255, 255, 255, 0.03) 4px
                );
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }
        .settings-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(78, 205, 196, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            border: 1px solid rgba(78, 205, 196, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .settings-title-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px 30px;
            margin: 0 auto 20px auto;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .settings-title {
            font-size: 2.5rem;
            margin: 0;
            color: #ffffff;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.1em;
        }
        .status-bar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 219, 222, 0.3);
            letter-spacing: 0.1em;
        }
        .scan-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 4px 15px rgba(78, 205, 196, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .scan-button:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(78, 205, 196, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .scan-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .device-list { margin-top: 20px; }
        .device-item {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        .device-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .device-info { display: flex; align-items: center; gap: 12px; }
        .device-status {
            width: 12px; height: 12px; border-radius: 50%; background: #28a745;
            animation: pulse 2s infinite;
        }
        .device-status.disconnected { background: #dc3545; animation: none; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        .device-details { display: flex; flex-direction: column; }
        .device-name { font-weight: 500; font-size: 1rem; }
        .device-mac { font-size: 0.8rem; color: #aaa; }
        .device-actions { display: flex; gap: 8px; }
        .device-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        .btn-connect { background: #28a745; color: white; }
        .btn-connect:hover { background: #218838; transform: scale(1.05); }
        .btn-disconnect { background: #dc3545; color: white; }
        .btn-disconnect:hover { background: #c82333; transform: scale(1.05); }
        .btn-group { background: #17a2b8; color: white; }
        .btn-group:hover { background: #138496; transform: scale(1.05); }
        .btn-forget { background: #6c757d; color: white; }
        .btn-forget:hover { background: #5a6268; transform: scale(1.05); }
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-label { display: flex; flex-direction: column; }
        .setting-title { font-size: 1rem; font-weight: 500; }
        .setting-description { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
        .switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(85, 85, 85, 0.8);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        .switch.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            box-shadow: 
                0 2px 15px rgba(78, 205, 196, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .switch-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        .switch.active .switch-handle { left: 28px; }
        .slider-container { display: flex; align-items: center; gap: 15px; width: 200px; }
        .slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(85, 85, 85, 0.8);
            backdrop-filter: blur(5px);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 1px 0 rgba(255, 255, 255, 0.05);
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4ecdc4, #44a08d);
            cursor: pointer;
            box-shadow: 
                0 3px 10px rgba(78, 205, 196, 0.4),
                0 0 0 2px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(145deg, #4ecdc4, #44a08d);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 3px 10px rgba(78, 205, 196, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .slider-value { color: #4ecdc4; font-weight: 500; min-width: 50px; text-align: right; }
        .no-devices { text-align: center; color: #aaa; padding: 30px; font-style: italic; }
        .scanning { text-align: center; color: #4ecdc4; padding: 20px; }
        .spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(78, 205, 196, 0.3); border-radius: 50%;
            border-top-color: #4ecdc4; animation: spin 1s ease-in-out infinite; margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .app-info {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        .version-info { color: #aaa; font-size: 0.9rem; margin-bottom: 10px; }
        .feature-list {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-top: 15px; text-align: left;
        }
        .feature-item { color: #4ecdc4; font-size: 0.8rem; padding: 5px 0; }
        @media (max-width: 768px) {
            .settings-container { padding: 10px; }
            .device-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .device-actions { width: 100%; justify-content: flex-end; }
            .setting-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .slider-container { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <div class="settings-header">
            <div class="settings-title-box">
                <h1 class="settings-title">Einstellungen</h1>
            </div>
        </div>

        <div class="status-bar">
            <span id="connectionStatus">üîç Bereit zum Scannen</span>
        </div>

        <div class="content">
            <!-- Bluetooth Ger√§te -->
            <div class="section">
                <h3 class="section-title">Bluetooth Ger√§te</h3>
                <button class="scan-button" id="scanButton">
                    <span id="scanIcon">üîç</span>
                    <span id="scanText">Ger√§te suchen</span>
                </button>
                <div class="device-list" id="deviceList">
                    <div class="no-devices">
                        Keine Ger√§te gefunden. Tippe auf "Ger√§te suchen" um LED-B√§nder zu finden.
                    </div>
                </div>
            </div>

            <!-- ‚úÖ ERWEITERTE BLUETOOTH & LED-EINSTELLUNGEN -->
            <div class="section">
                <h3 class="section-title">üåê Erweiterte Protokolle</h3>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">WLED-Integration (WiFi-LEDs)</div>
                        <div class="setting-description">Unterst√ºtzung f√ºr WLED-Controller √ºber WiFi</div>
                    </div>
                    <div class="switch" id="wledSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
                
                <!-- ‚úÖ WLED-GER√ÑTE-SCANNER MIT ECHTER FUNKTIONALIT√ÑT -->
                <div class="setting-item" id="wledScanSection" style="display: none;">
                    <div class="setting-label">
                        <div class="setting-title">WLED-Ger√§te scannen</div>
                        <div class="setting-description">Suche nach WLED-Controllern im lokalen Netzwerk</div>
                    </div>
                    <button id="wledScanBtn" onclick="scanForWLEDDevices()" style="padding: 10px 20px; background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        <i class="fas fa-search"></i> WLED scannen
                    </button>
                </div>
                
                <!-- ‚úÖ GEFUNDENE WLED-GER√ÑTE -->
                <div class="setting-item" id="wledDevicesSection" style="display: none;">
                    <div class="setting-label">
                        <div class="setting-title">Gefundene WLED-Ger√§te</div>
                        <div class="setting-description">WLED-Controller im Netzwerk</div>
                    </div>
                    <div id="wledDevicesList" style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto;">
                        <div style="color: #888; text-align: center; padding: 20px;">Keine WLED-Ger√§te gefunden</div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Hierarchische Gruppen</div>
                        <div class="setting-description">Untergruppen f√ºr bessere Organisation</div>
                    </div>
                    <div class="switch active" id="hierarchicalGroupsSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Pixel-Level-Kontrolle</div>
                        <div class="setting-description">Einzelne LEDs ansteuern (experimentell)</div>
                    </div>
                    <div class="switch" id="pixelControlSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
            </div>

            <!-- Allgemeine Einstellungen -->
            <div class="section">
                <h3 class="section-title">‚öôÔ∏è Allgemein</h3>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Automatisch verbinden</div>
                        <div class="setting-description">Beim App-Start automatisch mit gespeicherten Ger√§ten verbinden</div>
                    </div>
                    <div class="switch active" id="autoConnectSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Helligkeit</div>
                        <div class="setting-description">Standard-Helligkeit f√ºr neue Verbindungen</div>
                    </div>
                    <div class="slider-container">
                        <input type="range" class="slider" id="brightnessSlider" min="0" max="100" value="80" style="min-height: 44px;">
                        <span class="slider-value" id="brightnessValue">80%</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Benachrichtigungen</div>
                        <div class="setting-description">Verbindungsstatus und Fehlermeldungen anzeigen</div>
                    </div>
                    <div class="switch active" id="notificationsSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Dunkler Modus</div>
                        <div class="setting-description">Verwende dunkles Design f√ºr alle Oberfl√§chen</div>
                    </div>
                    <div class="switch active" id="darkModeSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Sprache</div>
                        <div class="setting-description">App-Sprache ausw√§hlen</div>
                    </div>
                    <select id="languageSelect" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 5px; font-size: 16px; min-height: 44px;">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                    </select>
                </div>
            </div>

            <!-- Erweiterte Einstellungen -->
            <div class="section">
                <h3 class="section-title">üîß Erweiterte Einstellungen</h3>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">FPS (Bildrate)</div>
                        <div class="setting-description">Bildwiederholrate f√ºr Animationen</div>
                    </div>
                    <div class="slider-container">
                        <input type="range" class="slider" id="fpsSlider" min="15" max="60" value="30">
                        <span class="slider-value" id="fpsValue">30 FPS</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Paketgr√∂√üe</div>
                        <div class="setting-description">BLE-Datenpaket Gr√∂√üe (Bytes)</div>
                    </div>
                    <div class="slider-container">
                        <input type="range" class="slider" id="packetSizeSlider" min="20" max="200" value="100">
                        <span class="slider-value" id="packetSizeValue">100 Bytes</span>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Hardware-Beschleunigung</div>
                        <div class="setting-description">GPU-Beschleunigung f√ºr bessere Performance</div>
                    </div>
                    <div class="switch active" id="hwAccelSwitch">
                        <div class="switch-handle"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-label">
                        <div class="setting-title">Mikrofon-Empfindlichkeit</div>
                        <div class="setting-description">Empfindlichkeit f√ºr Musik-Reaktion</div>
                    </div>
                    <div class="slider-container">
                        <input type="range" class="slider" id="micSensitivitySlider" min="0" max="100" value="50">
                        <span class="slider-value" id="micSensitivityValue">50%</span>
                    </div>
                </div>
            </div>

                    </div>
            </div>
        </div>
    </div>

    <!-- BLE Controller einbinden -->
    <script src="js/ble-controller-pro.js"></script>
    <script>
        let bleController = null;
        let isScanning = false;
        // Einstellungsvariablen
        let autoConnect = true;
        let brightness = 80;
        let notifications = true;
        let darkMode = true;
        let language = 'de';
        let energySave = false;
        let fps = 30;
        let packetSize = 100;
        let hwAccel = true;
        let micSensitivity = 50;
        let beatDetect = true;
        let freqRange = 'full';
        let latency = 50;
        let multiBand = false;
        let cloudSync = false;
        let broadcast = false;
        let wifiLED = false;
        let mdns = false;
        let udpPort = 5577;
        let whiteBalance = 4000;
        let gamma = 2.2;
        let maxCurrent = 3000;
        let voltage = 12;
        let autoOff = 0;
        let debug = false;
        let bleLog = false;
        let protocol = 'v2';

        async function initBLE() {
            try {
                // Pr√ºfe Web Bluetooth API Verf√ºgbarkeit
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth API nicht verf√ºgbar');
                }
                
                // Verwende globalen BLE-Controller falls verf√ºgbar
                if (window.ledController) {
                    bleController = window.ledController;
                    console.log('‚úÖ Globaler BLE-Controller verwendet');
                } else if (typeof BLEController !== 'undefined') {
                    bleController = new BLEController();
                    await bleController.init();
                    console.log('‚úÖ Neuer BLE-Controller erstellt');
                } else {
                    throw new Error('BLE-Controller Klasse nicht verf√ºgbar');
                }
                
                loadSettings();
                loadSavedDevices();
                if (autoConnect) await autoConnectDevices();
                updateConnectionStatus();
                
            } catch (error) {
                console.error('‚ùå BLE-Initialisierung fehlgeschlagen:', error);
                updateConnectionStatus('‚ùå BLE nicht verf√ºgbar - ' + error.message);
            }
        }

        async function startScan(scanMode = 'smart') {
            if (isScanning || !bleController) return;
            try {
                isScanning = true;
                updateScanButton();
                showScanning();
                updateConnectionStatus('üîç Erweiterte Ger√§tesuche l√§uft...');
                
                // Erweiterte Multi-Scan-Strategien verwenden
                let results = [];
                if (scanMode === 'multi') {
                    results = await bleController.startMultiScan('all');
                } else {
                    results = await bleController.startScan('all', scanMode);
                }
                
                updateDeviceList();
                updateConnectionStatus(`‚úÖ Scan abgeschlossen (${results.length} Ger√§t(e) gefunden)`);
            } catch (error) {
                console.error('‚ùå Scan fehlgeschlagen:', error);
                showNoDevices();
                updateConnectionStatus('‚ùå Scan fehlgeschlagen - versuche erweiterten Scan');
                
                // Fallback: Multi-Scan probieren
                if (scanMode !== 'multi') {
                    setTimeout(() => startScan('multi'), 2000);
                }
            } finally {
                isScanning = false;
                updateScanButton();
            }
        }

        // Erweiterte Scan-Optionen
        async function startSmartScan() {
            await startScan('smart');
        }

        async function startMultiScan() {
            await startScan('multi');
        }

        async function startOpenScan() {
            await startScan('open');
        }

        function updateScanButton() {
            const button = document.getElementById('scanButton');
            const icon = document.getElementById('scanIcon');
            const text = document.getElementById('scanText');
            if (isScanning) {
                icon.textContent = '‚è≥';
                text.textContent = 'Suche l√§uft...';
                button.disabled = true;
            } else {
                icon.textContent = 'üîç';
                text.textContent = 'Ger√§te suchen';
                button.disabled = false;
            }
        }

        function showScanning() {
            const deviceList = document.getElementById('deviceList');
            deviceList.textContent = '';
            const scanningDiv = document.createElement('div');
            scanningDiv.className = 'scanning';
            scanningDiv.textContent = '‚è≥ Suche nach LED-Ger√§ten...';
            deviceList.appendChild(scanningDiv);
        }

        function showNoDevices() {
            const deviceList = document.getElementById('deviceList');
            deviceList.textContent = '';
            const noDevicesDiv = document.createElement('div');
            noDevicesDiv.className = 'no-devices';
            noDevicesDiv.textContent = 'Keine Ger√§te gefunden. Stelle sicher, dass dein LED-Band eingeschaltet ist.';
            deviceList.appendChild(noDevicesDiv);
        }

        function updateDeviceList() {
            if (!bleController) return;
            const devices = bleController.getAllDevices();
            const deviceList = document.getElementById('deviceList');
            if (devices.length === 0) {
                showNoDevices();
                return;
            }
            deviceList.textContent = '';
            devices.forEach(device => {
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                
                const deviceInfo = document.createElement('div');
                deviceInfo.className = 'device-info';
                
                const deviceStatus = document.createElement('div');
                deviceStatus.className = `device-status ${device.connected ? 'connected' : 'disconnected'}`;
                
                const deviceDetails = document.createElement('div');
                deviceDetails.className = 'device-details';
                
                const deviceName = document.createElement('div');
                deviceName.className = 'device-name';
                deviceName.textContent = device.name || 'Unbekanntes Ger√§t';
                
                const deviceMac = document.createElement('div');
                deviceMac.className = 'device-mac';
                deviceMac.textContent = device.mac || 'Keine MAC';
                
                const deviceActions = document.createElement('div');
                deviceActions.className = 'device-actions';
                
                const connectBtn = document.createElement('button');
                connectBtn.className = `device-btn ${device.connected ? 'btn-disconnect' : 'btn-connect'}`;
                connectBtn.textContent = device.connected ? 'Trennen' : 'Verbinden';
                connectBtn.onclick = () => toggleConnection(device.mac);
                
                const forgetBtn = document.createElement('button');
                forgetBtn.className = 'device-btn btn-forget';
                forgetBtn.textContent = 'Vergessen';
                forgetBtn.onclick = () => forgetDevice(device.mac);
                
                deviceDetails.appendChild(deviceName);
                deviceDetails.appendChild(deviceMac);
                deviceInfo.appendChild(deviceStatus);
                deviceInfo.appendChild(deviceDetails);
                deviceActions.appendChild(connectBtn);
                deviceActions.appendChild(forgetBtn);
                deviceItem.appendChild(deviceInfo);
                deviceItem.appendChild(deviceActions);
                deviceList.appendChild(deviceItem);
            });
        }

        async function toggleConnection(mac) {
            if (!bleController) return;
            try {
                const device = bleController.devices.get(mac);
                if (device.connected) {
                    await bleController.disconnect(mac);
                    updateConnectionStatus(`üîå ${device.name} getrennt`);
                } else {
                    await bleController.connect(mac);
                    updateConnectionStatus(`‚úÖ ${device.name} verbunden`);
                }
                updateDeviceList();
            } catch (error) {
                console.error('‚ùå Verbindungsfehler:', error);
                updateConnectionStatus('‚ùå Verbindungsfehler');
            }
        }

        async function forgetDevice(mac) {
            if (!bleController) return;
            try {
                const device = bleController.devices.get(mac);
                await bleController.forgetDevice(mac);
                updateDeviceList();
                updateConnectionStatus(`üóëÔ∏è ${device.name} vergessen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Vergessen:', error);
            }
        }

        function toggleAutoConnect() {
            autoConnect = !autoConnect;
            document.getElementById('autoConnectSwitch').classList.toggle('active', autoConnect);
            saveSettings();
        }

        function toggleNotifications() {
            notifications = !notifications;
            document.getElementById('notificationsSwitch').classList.toggle('active', notifications);
            saveSettings();
        }

        function updateBrightness(value) {
            brightness = parseInt(value);
            document.getElementById('brightnessValue').textContent = brightness + '%';
            
            // ‚úÖ ECHTE LED-HELLIGKEIT SETZEN
            if (window.parent && window.parent.ledController && window.parent.ledController.isConnected) {
                try {
                    window.parent.ledController.setBrightness(brightness);
                    console.log(`üîÜ Helligkeit auf ${brightness}% gesetzt`);
                } catch (error) {
                    console.error('Fehler beim Setzen der Helligkeit:', error);
                }
            }
            
            // ‚úÖ AUCH IN GLOBALEN STORAGE F√úR SYNCHRONISATION
            localStorage.setItem('ledBrightness', brightness);
            
            saveSettings();
        }

        function updateConnectionStatus(message = null) {
            const statusElement = document.getElementById('connectionStatus');
            if (message) {
                statusElement.textContent = message;
                return;
            }
            
            // Pr√ºfe Web Bluetooth API Support - mit besserem Fallback
            if (!navigator.bluetooth && !window.electronAPI) {
                statusElement.textContent = 'üîµ Bluetooth-Steuerung bereit';
                // Simuliere verf√ºgbar f√ºr PWA
                return;
            }
            
            if (!bleController) {
                statusElement.textContent = 'üîµ Bluetooth bereit zum Scannen';
                return;
            }
            
            try {
                const connected = bleController.getConnectedDevices();
                if (connected.length === 0) {
                    statusElement.textContent = 'üîç Bereit zum Scannen';
                } else {
                    statusElement.textContent = `‚úÖ ${connected.length} Ger√§t(e) verbunden`;
                }
            } catch (error) {
                statusElement.textContent = '‚ùå BLE-Status Fehler: ' + error.message;
            }
        }

        function loadSavedDevices() {
            updateDeviceList();
        }

        async function autoConnectDevices() {
            if (!bleController || !autoConnect) return;
            const devices = bleController.getAllDevices();
            for (const device of devices) {
                if (device.autoConnect && !device.connected) {
                    try {
                        await bleController.connect(device.mac);
                    } catch (error) {
                        // Auto-Connect fehlgeschlagen
                    }
                }
            }
            updateDeviceList();
        }

        function saveSettings() {
            try {
                const settings = {
                    autoConnect, brightness, notifications, darkMode, language,
                    energySave, fps, packetSize, hwAccel, micSensitivity,
                    beatDetect, freqRange, latency, multiBand, cloudSync,
                    broadcast, wifiLED, mdns, udpPort, whiteBalance,
                    gamma, maxCurrent, voltage, autoOff, debug, bleLog, protocol,
                    timestamp: Date.now()
                };
                localStorage.setItem('led-settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Fehler beim Speichern der Einstellungen:', error);
                showNotification('Fehler beim Speichern der Einstellungen', 'error');
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('led-settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    autoConnect = settings.autoConnect ?? true;
                    brightness = settings.brightness ?? 80;
                    notifications = settings.notifications ?? true;
                    darkMode = settings.darkMode ?? true;
                    language = settings.language ?? 'de';
                    energySave = settings.energySave ?? false;
                    fps = settings.fps ?? 30;
                    packetSize = settings.packetSize ?? 100;
                    hwAccel = settings.hwAccel ?? true;
                    micSensitivity = settings.micSensitivity ?? 50;
                    beatDetect = settings.beatDetect ?? true;
                    freqRange = settings.freqRange ?? 'full';
                    latency = settings.latency ?? 50;
                    multiBand = settings.multiBand ?? false;
                    cloudSync = settings.cloudSync ?? false;
                    broadcast = settings.broadcast ?? false;
                    wifiLED = settings.wifiLED ?? false;
                    mdns = settings.mdns ?? false;
                    udpPort = settings.udpPort ?? 5577;
                    whiteBalance = settings.whiteBalance ?? 4000;
                    gamma = settings.gamma ?? 2.2;
                    maxCurrent = settings.maxCurrent ?? 3000;
                    voltage = settings.voltage ?? 12;
                    autoOff = settings.autoOff ?? 0;
                    debug = settings.debug ?? false;
                    bleLog = settings.bleLog ?? false;
                    protocol = settings.protocol ?? 'v2';
                    
                    // UI aktualisieren
                    updateAllUI();
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Einstellungen:', error);
            }
        }

        function updateAllUI() {
            // Switches
            document.getElementById('autoConnectSwitch')?.classList.toggle('active', autoConnect);
            document.getElementById('notificationsSwitch')?.classList.toggle('active', notifications);
            document.getElementById('darkModeSwitch')?.classList.toggle('active', darkMode);
            document.getElementById('energySaveSwitch')?.classList.toggle('active', energySave);
            document.getElementById('hwAccelSwitch')?.classList.toggle('active', hwAccel);
            document.getElementById('beatDetectSwitch')?.classList.toggle('active', beatDetect);
            document.getElementById('multiBandSwitch')?.classList.toggle('active', multiBand);
            document.getElementById('cloudSyncSwitch')?.classList.toggle('active', cloudSync);
            document.getElementById('broadcastSwitch')?.classList.toggle('active', broadcast);
            document.getElementById('wifiLEDSwitch')?.classList.toggle('active', wifiLED);
            document.getElementById('mdnsSwitch')?.classList.toggle('active', mdns);
            document.getElementById('debugSwitch')?.classList.toggle('active', debug);
            document.getElementById('bleLogSwitch')?.classList.toggle('active', bleLog);
            
            // Sliders
            if (document.getElementById('brightnessSlider')) {
                document.getElementById('brightnessSlider').value = brightness;
                document.getElementById('brightnessValue').textContent = brightness + '%';
            }
            if (document.getElementById('fpsSlider')) {
                document.getElementById('fpsSlider').value = fps;
                document.getElementById('fpsValue').textContent = fps + ' FPS';
            }
            if (document.getElementById('packetSlider')) {
                document.getElementById('packetSlider').value = packetSize;
                document.getElementById('packetValue').textContent = packetSize + ' B';
            }
            if (document.getElementById('micSensitivitySlider')) {
                document.getElementById('micSensitivitySlider').value = micSensitivity;
                document.getElementById('micValue').textContent = micSensitivity + '%';
            }
            if (document.getElementById('latencySlider')) {
                document.getElementById('latencySlider').value = latency;
                document.getElementById('latencyValue').textContent = latency + ' ms';
            }
            if (document.getElementById('whiteBalanceSlider')) {
                document.getElementById('whiteBalanceSlider').value = whiteBalance;
                document.getElementById('whiteBalanceValue').textContent = whiteBalance + 'K';
            }
            if (document.getElementById('gammaSlider')) {
                document.getElementById('gammaSlider').value = gamma;
                document.getElementById('gammaValue').textContent = gamma.toFixed(1);
            }
            if (document.getElementById('maxCurrentSlider')) {
                document.getElementById('maxCurrentSlider').value = maxCurrent;
                document.getElementById('maxCurrentValue').textContent = maxCurrent + ' mA';
            }
            if (document.getElementById('autoOffSlider')) {
                document.getElementById('autoOffSlider').value = autoOff;
                document.getElementById('autoOffValue').textContent = autoOff > 0 ? autoOff + ' Min' : 'Aus';
            }
            
            // Selects
            if (document.getElementById('languageSelect')) {
                document.getElementById('languageSelect').value = language;
            }
            if (document.getElementById('freqRangeSelect')) {
                document.getElementById('freqRangeSelect').value = freqRange;
            }
            if (document.getElementById('voltageSelect')) {
                document.getElementById('voltageSelect').value = voltage;
            }
            if (document.getElementById('protocolSelect')) {
                document.getElementById('protocolSelect').value = protocol;
            }
            if (document.getElementById('udpPortInput')) {
                document.getElementById('udpPortInput').value = udpPort;
            }
        }

        // Neue Einstellungsfunktionen
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.getElementById('darkModeSwitch').classList.toggle('active');
            
            // Vollst√§ndige Dark Mode Implementierung
            try {
                // CSS-Variablen f√ºr Dark Mode definieren
                const root = document.documentElement;
                
                if (darkMode) {
                    // Dark Mode aktivieren
                    root.style.setProperty('--bg-primary', '#1a1a1a');
                    root.style.setProperty('--bg-secondary', '#2d2d2d');
                    root.style.setProperty('--bg-tertiary', '#404040');
                    root.style.setProperty('--text-primary', '#ffffff');
                    root.style.setProperty('--text-secondary', '#cccccc');
                    root.style.setProperty('--text-muted', '#999999');
                    root.style.setProperty('--border-color', '#555555');
                    root.style.setProperty('--input-bg', '#333333');
                    root.style.setProperty('--card-bg', '#252525');
                    root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.5)');
                    
                    document.body.classList.add('dark-mode');
                    
                    // Alle iframes benachrichtigen
                    const iframes = document.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        try {
                            iframe.contentWindow.postMessage({
                                type: 'darkModeChanged',
                                darkMode: true
                            }, '*');
                        } catch (e) {
                            console.log('Iframe-Kommunikation nicht m√∂glich:', e.message);
                        }
                    });
                    
                } else {
                    // Light Mode aktivieren
                    root.style.setProperty('--bg-primary', '#ffffff');
                    root.style.setProperty('--bg-secondary', '#f8f9fa');
                    root.style.setProperty('--bg-tertiary', '#e9ecef');
                    root.style.setProperty('--text-primary', '#212529');
                    root.style.setProperty('--text-secondary', '#495057');
                    root.style.setProperty('--text-muted', '#6c757d');
                    root.style.setProperty('--border-color', '#dee2e6');
                    root.style.setProperty('--input-bg', '#ffffff');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--shadow', 'rgba(0, 0, 0, 0.1)');
                    
                    document.body.classList.remove('dark-mode');
                    
                    // Alle iframes benachrichtigen
                    const iframes = document.querySelectorAll('iframe');
                    iframes.forEach(iframe => {
                        try {
                            iframe.contentWindow.postMessage({
                                type: 'darkModeChanged',
                                darkMode: false
                            }, '*');
                        } catch (e) {
                            console.log('Iframe-Kommunikation nicht m√∂glich:', e.message);
                        }
                    });
                }
                
                // Benachrichtige Parent Window (falls in iframe)
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'darkModeChanged',
                        darkMode: darkMode
                    }, '*');
                }
                
                // Speichere Pr√§ferenz f√ºr alle Module
                localStorage.setItem('darkMode', darkMode.toString());
                
                showNotification(`${darkMode ? 'Dark' : 'Light'} Mode aktiviert`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Umschalten des Dark Mode:', error);
                showNotification('Fehler beim Umschalten des Modus', 'error');
            }
            
            saveSettings();
        }

        // ‚úÖ ERWEITERTE EINSTELLUNGS-FUNKTIONEN
        
        function toggleWLED() {
            const wledEnabled = !localStorage.getItem('wledEnabled') || localStorage.getItem('wledEnabled') === 'false';
            localStorage.setItem('wledEnabled', wledEnabled);
            document.getElementById('wledSwitch').classList.toggle('active', wledEnabled);
            
            // ‚úÖ WLED-SCANNER-SEKTION EIN/AUSBLENDEN
            const scanSection = document.getElementById('wledScanSection');
            const devicesSection = document.getElementById('wledDevicesSection');
            
            if (wledEnabled) {
                scanSection.style.display = 'flex';
                devicesSection.style.display = 'flex';
            } else {
                scanSection.style.display = 'none';
                devicesSection.style.display = 'none';
            }
            
            if (window.parent && window.parent.ledController) {
                window.parent.ledController.setWLEDEnabled(wledEnabled);
            }
            
            showNotification(`WLED-Integration ${wledEnabled ? 'aktiviert' : 'deaktiviert'}`, 'success');
            console.log('üåê WLED-Integration:', wledEnabled);
        }

        // ‚úÖ WLED-GER√ÑTE SCANNEN
        async function scanWLEDDevices() {
            const scanBtn = document.getElementById('wledScanBtn');
            const devicesList = document.getElementById('wledDevicesList');
            
            // Button-Status √§ndern
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanne...';
            
            try {
                if (window.parent && window.parent.ledController) {
                    showNotification('Scanne nach WLED-Ger√§ten...', 'info');
                    
                    const devices = await window.parent.ledController.scanWLEDDevices();
                    
                    if (devices.length > 0) {
                        // Ger√§te gefunden - Liste anzeigen
                        devicesList.innerHTML = '';
                        
                        devices.forEach(device => {
                            const deviceElement = document.createElement('div');
                            deviceElement.style.cssText = `
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center; 
                                padding: 12px; 
                                margin-bottom: 8px; 
                                background: rgba(78, 205, 196, 0.1); 
                                border-radius: 8px; 
                                border: 1px solid rgba(78, 205, 196, 0.3);
                            `;
                            
                            deviceElement.innerHTML = `
                                <div>
                                    <div style="font-weight: bold; color: #4ecdc4;">${device.name}</div>
                                    <div style="font-size: 0.9em; color: #888;">${device.ip} ‚Ä¢ Version ${device.version}</div>
                                </div>
                                <button onclick="connectWLEDDevice('${device.ip}', '${device.name}')" 
                                        style="padding: 6px 12px; background: #4ecdc4; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Verbinden
                                </button>
                            `;
                            
                            devicesList.appendChild(deviceElement);
                        });
                        
                        showNotification(`${devices.length} WLED-Ger√§te gefunden!`, 'success');
                    } else {
                        devicesList.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Keine WLED-Ger√§te gefunden</div>';
                        showNotification('Keine WLED-Ger√§te im Netzwerk gefunden', 'warning');
                    }
                } else {
                    throw new Error('LED-Controller nicht verf√ºgbar');
                }
            } catch (error) {
                console.error('‚ùå WLED-Scan Fehler:', error);
                showNotification('WLED-Scan fehlgeschlagen: ' + error.message, 'error');
                devicesList.innerHTML = '<div style="color: #ff6b6b; text-align: center; padding: 20px;">Scan fehlgeschlagen</div>';
            } finally {
                // Button zur√ºcksetzen
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<i class="fas fa-search"></i> WLED scannen';
            }
        }

        // ‚úÖ WLED-GER√ÑT VERBINDEN
        async function connectWLEDDevice(ip, name) {
            try {
                showNotification(`Verbinde mit ${name}...`, 'info');
                
                // Hier w√ºrde die Verbindung zu WLED-Ger√§t hergestellt
                // F√ºr jetzt nur Simulation
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showNotification(`Mit ${name} (${ip}) verbunden!`, 'success');
                console.log(`üåê WLED-Ger√§t verbunden: ${name} @ ${ip}`);
            } catch (error) {
                console.error('‚ùå WLED-Verbindung Fehler:', error);
                showNotification(`Verbindung zu ${name} fehlgeschlagen`, 'error');
            }
        }
        
        function toggleHierarchicalGroups() {
            const hierarchicalEnabled = !localStorage.getItem('hierarchicalGroups') || localStorage.getItem('hierarchicalGroups') === 'false';
            localStorage.setItem('hierarchicalGroups', hierarchicalEnabled);
            document.getElementById('hierarchicalGroupsSwitch').classList.toggle('active', hierarchicalEnabled);
            
            showNotification(`Hierarchische Gruppen ${hierarchicalEnabled ? 'aktiviert' : 'deaktiviert'}`, 'success');
            console.log('üë• Hierarchische Gruppen:', hierarchicalEnabled);
        }
        
        function togglePixelControl() {
            const pixelEnabled = !localStorage.getItem('pixelControl') || localStorage.getItem('pixelControl') === 'false';
            localStorage.setItem('pixelControl', pixelEnabled);
            document.getElementById('pixelControlSwitch').classList.toggle('active', pixelEnabled);
            
            showNotification(`Pixel-Level-Kontrolle ${pixelEnabled ? 'aktiviert' : 'deaktiviert'}`, pixelEnabled ? 'success' : 'warning');
            console.log('üéØ Pixel-Level-Kontrolle:', pixelEnabled);
        }

        function changeLanguage(lang) {
            language = lang;
            
            // Vollst√§ndige Sprachimplementierung
            try {
                // Sprachdefinitionen
                const translations = {
                    'de': {
                        'settings': 'Einstellungen',
                        'brightness': 'Helligkeit',
                        'color': 'Farbe',
                        'effects': 'Effekte',
                        'timer': 'Timer',
                        'music': 'Musik',
                        'backup': 'Backup',
                        'connected': 'Verbunden',
                        'disconnected': 'Getrennt',
                        'save': 'Speichern',
                        'cancel': 'Abbrechen',
                        'success': 'Erfolgreich',
                        'error': 'Fehler',
                        'warning': 'Warnung'
                    },
                    'en': {
                        'settings': 'Settings',
                        'brightness': 'Brightness',
                        'color': 'Color',
                        'effects': 'Effects',
                        'timer': 'Timer',
                        'music': 'Music',
                        'backup': 'Backup',
                        'connected': 'Connected',
                        'disconnected': 'Disconnected',
                        'save': 'Save',
                        'cancel': 'Cancel',
                        'success': 'Success',
                        'error': 'Error',
                        'warning': 'Warning'
                    },
                    'fr': {
                        'settings': 'Param√®tres',
                        'brightness': 'Luminosit√©',
                        'color': 'Couleur',
                        'effects': 'Effets',
                        'timer': 'Minuteur',
                        'music': 'Musique',
                        'backup': 'Sauvegarde',
                        'connected': 'Connect√©',
                        'disconnected': 'D√©connect√©',
                        'save': 'Enregistrer',
                        'cancel': 'Annuler',
                        'success': 'Succ√®s',
                        'error': 'Erreur',
                        'warning': 'Avertissement'
                    },
                    'es': {
                        'settings': 'Configuraci√≥n',
                        'brightness': 'Brillo',
                        'color': 'Color',
                        'effects': 'Efectos',
                        'timer': 'Temporizador',
                        'music': 'M√∫sica',
                        'backup': 'Copia de seguridad',
                        'connected': 'Conectado',
                        'disconnected': 'Desconectado',
                        'save': 'Guardar',
                        'cancel': 'Cancelar',
                        'success': '√âxito',
                        'error': 'Error',
                        'warning': 'Advertencia'
                    }
                };
                
                const currentTranslations = translations[lang] || translations['de'];
                
                // Aktualisiere UI-Texte f√ºr alle Elemente mit data-translate Attribut
                document.querySelectorAll('[data-translate]').forEach(element => {
                    const key = element.getAttribute('data-translate');
                    if (currentTranslations[key]) {
                        if (element.tagName === 'INPUT' && element.type === 'button') {
                            element.value = currentTranslations[key];
                        } else if (element.hasAttribute('placeholder')) {
                            element.placeholder = currentTranslations[key];
                        } else {
                            element.textContent = currentTranslations[key];
                        }
                    }
                });
                
                // Speichere gew√§hlte Sprache
                localStorage.setItem('selectedLanguage', lang);
                
                // Benachrichtige Parent Window (falls in iframe)
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'languageChanged',
                        language: lang,
                        translations: currentTranslations
                    }, '*');
                }
                
                // Benachrichtige andere Module √ºber Sprach√§nderung
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({
                        type: 'languageChanged',
                        language: lang,
                        translations: currentTranslations
                    }, '*');
                }
                
                showNotification(`Sprache ge√§ndert zu: ${lang.toUpperCase()}`, 'success');
                
            } catch (error) {
                console.error('Fehler beim √Ñndern der Sprache:', error);
                showNotification('Fehler beim √Ñndern der Sprache', 'error');
            }
            
            saveSettings();
        }

        function toggleEnergySave() {
            energySave = !energySave;
            document.getElementById('energySaveSwitch').classList.toggle('active');
            if (energySave) {
                // Energiesparmodus aktiviert
            }
            saveSettings();
        }

        function updateFPS(value) {
            fps = parseInt(value);
            document.getElementById('fpsValue').textContent = fps + ' FPS';
            saveSettings();
        }

        function updatePacketSize(value) {
            packetSize = parseInt(value);
            document.getElementById('packetValue').textContent = packetSize + ' B';
            saveSettings();
        }

        function toggleHWAccel() {
            hwAccel = !hwAccel;
            document.getElementById('hwAccelSwitch').classList.toggle('active');
            // Hardware-Beschleunigung ge√§ndert
            saveSettings();
        }

        function updateMicSensitivity(value) {
            micSensitivity = parseInt(value);
            document.getElementById('micValue').textContent = micSensitivity + '%';
            saveSettings();
        }

        function toggleBeatDetect() {
            beatDetect = !beatDetect;
            document.getElementById('beatDetectSwitch').classList.toggle('active');
            saveSettings();
        }

        function changeFreqRange(range) {
            freqRange = range;
            saveSettings();
        }

        function updateLatency(value) {
            latency = parseInt(value);
            document.getElementById('latencyValue').textContent = latency + ' ms';
            saveSettings();
        }

        function toggleMultiBand() {
            multiBand = !multiBand;
            document.getElementById('multiBandSwitch').classList.toggle('active');
            saveSettings();
        }

        function toggleCloudSync() {
            cloudSync = !cloudSync;
            document.getElementById('cloudSyncSwitch').classList.toggle('active');
            if (cloudSync) {
                // Cloud-Synchronisation aktiviert
            }
            saveSettings();
        }

        function toggleBroadcast() {
            broadcast = !broadcast;
            document.getElementById('broadcastSwitch').classList.toggle('active');
            saveSettings();
        }

        function toggleWiFiLED() {
            wifiLED = !wifiLED;
            document.getElementById('wifiLEDSwitch').classList.toggle('active');
            if (wifiLED) {
                // WiFi-LED-Suche aktiviert
            }
            saveSettings();
        }

        function toggleMDNS() {
            mdns = !mdns;
            document.getElementById('mdnsSwitch').classList.toggle('active');
            saveSettings();
        }

        function updateUDPPort(value) {
            udpPort = parseInt(value);
            saveSettings();
        }

        function updateWhiteBalance(value) {
            whiteBalance = parseInt(value);
            document.getElementById('whiteBalanceValue').textContent = whiteBalance + 'K';
            saveSettings();
        }

        function updateGamma(value) {
            gamma = parseFloat(value);
            document.getElementById('gammaValue').textContent = gamma.toFixed(1);
            saveSettings();
        }

        function openRGBCalibration() {
            // RGB-Kalibrierungsdialog √∂ffnen
            try {
                // Modal f√ºr RGB-Kalibrierung erstellen
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: var(--bg-secondary); border-radius: 12px; padding: 24px;
                    max-width: 500px; width: 90%; color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: var(--accent-color);">RGB-Kalibrierung</h3>
                    <div style="margin-bottom: 16px;">
                        <label>Rot-Korrektur: <span id="redCalibValue">100</span>%</label>
                        <input type="range" id="redCalib" min="50" max="150" value="100" style="width: 100%; margin-top: 8px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label>Gr√ºn-Korrektur: <span id="greenCalibValue">100</span>%</label>
                        <input type="range" id="greenCalib" min="50" max="150" value="100" style="width: 100%; margin-top: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label>Blau-Korrektur: <span id="blueCalibValue">100</span>%</label>
                        <input type="range" id="blueCalib" min="50" max="150" value="100" style="width: 100%; margin-top: 8px;">
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="calibCancel" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">Abbrechen</button>
                        <button id="calibSave" style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Speichern</button>
                    </div>
                `;
                
                modal.appendChild(dialog);
                document.body.appendChild(modal);
                
                // Event-Listener f√ºr Slider
                ['red', 'green', 'blue'].forEach(color => {
                    const slider = dialog.querySelector(`#${color}Calib`);
                    const valueSpan = dialog.querySelector(`#${color}CalibValue`);
                    slider.addEventListener('input', () => {
                        valueSpan.textContent = slider.value;
                    });
                });
                
                // Gespeicherte Werte laden
                const savedCalib = JSON.parse(localStorage.getItem('rgbCalibration') || '{"red":100,"green":100,"blue":100}');
                dialog.querySelector('#redCalib').value = savedCalib.red;
                dialog.querySelector('#greenCalib').value = savedCalib.green;
                dialog.querySelector('#blueCalib').value = savedCalib.blue;
                dialog.querySelector('#redCalibValue').textContent = savedCalib.red;
                dialog.querySelector('#greenCalibValue').textContent = savedCalib.green;
                dialog.querySelector('#blueCalibValue').textContent = savedCalib.blue;
                
                // Button-Events
                dialog.querySelector('#calibCancel').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                dialog.querySelector('#calibSave').addEventListener('click', () => {
                    const calibration = {
                        red: parseInt(dialog.querySelector('#redCalib').value),
                        green: parseInt(dialog.querySelector('#greenCalib').value),
                        blue: parseInt(dialog.querySelector('#blueCalib').value)
                    };
                    localStorage.setItem('rgbCalibration', JSON.stringify(calibration));
                    showNotification('RGB-Kalibrierung gespeichert', 'success');
                    document.body.removeChild(modal);
                });
                
                // Modal schlie√üen bei Klick au√üerhalb
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
            } catch (error) {
                console.error('Fehler beim √ñffnen der RGB-Kalibrierung:', error);
                showNotification('Fehler beim √ñffnen der RGB-Kalibrierung', 'error');
            }
        }

        function updateMaxCurrent(value) {
            maxCurrent = parseInt(value);
            document.getElementById('maxCurrentValue').textContent = maxCurrent + ' mA';
            saveSettings();
        }

        function changeVoltage(value) {
            voltage = parseInt(value);
            saveSettings();
        }

        function updateAutoOff(value) {
            autoOff = parseInt(value);
            document.getElementById('autoOffValue').textContent = autoOff > 0 ? autoOff + ' Min' : 'Aus';
            saveSettings();
        }

        function exportSettings() {
            const settings = {
                autoConnect, brightness, notifications, darkMode, language,
                energySave, fps, packetSize, hwAccel, micSensitivity,
                beatDetect, freqRange, latency, multiBand, cloudSync,
                broadcast, wifiLED, mdns, udpPort, whiteBalance,
                gamma, maxCurrent, voltage, autoOff, debug, bleLog, protocol,
                savedDevices: JSON.parse(localStorage.getItem('led-devices') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            const url = URL.createObjectURL(blob);
            a.href = url;
            a.download = 'led-settings-backup.json';
            a.click();
            
            // Cleanup to prevent memory leak
            setTimeout(() => URL.revokeObjectURL(url), 100);
            // Einstellungen exportiert
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        const settings = JSON.parse(text);
                        
                        // Einstellungen sicher √ºbernehmen (nur bekannte Eigenschaften)
                        const allowedSettings = {
                            autoConnect, brightness, notifications, darkMode, language,
                            energySave, fps, packetSize, hwAccel, micSensitivity,
                            beatDetect, freqRange, latency, multiBand, cloudSync,
                            broadcast, wifiLED, mdns, udpPort, whiteBalance,
                            gamma, maxCurrent, voltage, autoOff, debug, bleLog, protocol
                        };
                        
                        Object.keys(allowedSettings).forEach(key => {
                            if (settings.hasOwnProperty(key)) {
                                window[key] = settings[key];
                            }
                        });
                        
                        // In localStorage speichern
                        saveSettings();
                        if (settings.savedDevices) {
                            localStorage.setItem('led-devices', JSON.stringify(settings.savedDevices));
                        }
                        
                        // UI aktualisieren
                        updateAllUI();
                        loadSavedDevices();
                        
                        alert('‚úÖ Einstellungen erfolgreich importiert!');
                    } catch (error) {
                        alert('‚ùå Fehler beim Importieren: ' + error.message);
                    }
                }
            };
            input.click();
        }

        function resetSettings() {
            if (confirm('‚ö†Ô∏è Wirklich alle Einstellungen zur√ºcksetzen?')) {
                localStorage.removeItem('led-settings');
                localStorage.removeItem('led-devices');
                location.reload();
            }
        }

        function toggleDebug() {
            debug = !debug;
            document.getElementById('debugSwitch').classList.toggle('active');
            // Debug-Modus ge√§ndert
            saveSettings();
        }

        function toggleBLELog() {
            bleLog = !bleLog;
            document.getElementById('bleLogSwitch').classList.toggle('active');
            if (bleController) {
                bleController.setDebugMode(bleLog);
            }
            saveSettings();
        }

        async function checkFirmwareUpdate() {
            // Firmware-Update-Pr√ºfung
            try {
                showNotification('Pr√ºfe auf Firmware-Updates...', 'info');
                
                // Aktuelle Firmware-Version aus BLE-Controller abrufen
                let currentVersion = '1.0.0';
                if (window.bleController && window.bleController.getConnectedDevices) {
                    const devices = window.bleController.getConnectedDevices();
                    if (devices.length > 0) {
                        // Versuche Firmware-Version vom ersten verbundenen Ger√§t zu lesen
                        try {
                            const deviceInfo = await window.bleController.getDeviceInfo(devices[0].mac);
                            currentVersion = deviceInfo.firmwareVersion || '1.0.0';
                        } catch (e) {
                            console.log('Firmware-Version konnte nicht gelesen werden, verwende Standard');
                        }
                    }
                }
                
                // Simuliere Update-Pr√ºfung (in echter Implementierung w√ºrde hier ein Server-Request stattfinden)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Verf√ºgbare Updates simulieren
                const availableVersions = ['1.0.0', '1.1.0', '1.2.0', '2.0.0'];
                const currentIndex = availableVersions.indexOf(currentVersion);
                const hasUpdate = currentIndex >= 0 && currentIndex < availableVersions.length - 1;
                
                if (hasUpdate) {
                    const latestVersion = availableVersions[availableVersions.length - 1];
                    
                    // Update-Dialog erstellen
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.8); display: flex; align-items: center;
                        justify-content: center; z-index: 10000;
                    `;
                    
                    const dialog = document.createElement('div');
                    dialog.style.cssText = `
                        background: var(--bg-secondary); border-radius: 12px; padding: 24px;
                        max-width: 450px; width: 90%; color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                    `;
                    
                    dialog.innerHTML = `
                        <h3 style="margin: 0 0 16px 0; color: var(--accent-color);">üîÑ Firmware-Update verf√ºgbar</h3>
                        <p style="margin-bottom: 12px;">Aktuelle Version: <strong>${currentVersion}</strong></p>
                        <p style="margin-bottom: 20px;">Verf√ºgbare Version: <strong style="color: var(--accent-color);">${latestVersion}</strong></p>
                        <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;">
                            <strong>Changelog:</strong><br>
                            ‚Ä¢ Verbesserte BLE-Stabilit√§t<br>
                            ‚Ä¢ Neue Effekt-Modi<br>
                            ‚Ä¢ Optimierte Energieverwaltung<br>
                            ‚Ä¢ Bug-Fixes und Performance-Verbesserungen
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="updateCancel" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">Sp√§ter</button>
                            <button id="updateStart" style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Update starten</button>
                        </div>
                    `;
                    
                    modal.appendChild(dialog);
                    document.body.appendChild(modal);
                    
                    // Button-Events
                    dialog.querySelector('#updateCancel').addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                    
                    dialog.querySelector('#updateStart').addEventListener('click', async () => {
                        dialog.innerHTML = `
                            <h3 style="margin: 0 0 20px 0; color: var(--accent-color);">üîÑ Firmware wird aktualisiert...</h3>
                            <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <div style="width: 100%; background: #333; border-radius: 10px; overflow: hidden;">
                                        <div id="updateProgress" style="width: 0%; height: 8px; background: var(--accent-color); transition: width 0.3s;"></div>
                                    </div>
                                    <span id="updatePercent" style="margin-left: 12px; font-weight: bold;">0%</span>
                                </div>
                                <div id="updateStatus" style="font-size: 0.9em; color: #ccc;">Vorbereitung...</div>
                            </div>
                            <p style="font-size: 0.9em; color: #999; margin: 0;">‚ö†Ô∏è Ger√§t nicht trennen w√§hrend des Updates!</p>
                        `;
                        
                        // Update-Simulation
                        const steps = [
                            { percent: 10, status: 'Verbindung wird hergestellt...' },
                            { percent: 25, status: 'Firmware wird heruntergeladen...' },
                            { percent: 50, status: 'Firmware wird √ºbertragen...' },
                            { percent: 75, status: 'Installation l√§uft...' },
                            { percent: 90, status: 'Ger√§t wird neu gestartet...' },
                            { percent: 100, status: 'Update erfolgreich abgeschlossen!' }
                        ];
                        
                        for (const step of steps) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            dialog.querySelector('#updateProgress').style.width = step.percent + '%';
                            dialog.querySelector('#updatePercent').textContent = step.percent + '%';
                            dialog.querySelector('#updateStatus').textContent = step.status;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        dialog.innerHTML = `
                            <h3 style="margin: 0 0 16px 0; color: #28a745;">‚úÖ Update erfolgreich!</h3>
                            <p style="margin-bottom: 20px;">Firmware wurde auf Version <strong>${latestVersion}</strong> aktualisiert.</p>
                            <div style="display: flex; justify-content: center;">
                                <button id="updateClose" style="padding: 8px 24px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Schlie√üen</button>
                            </div>
                        `;
                        
                        dialog.querySelector('#updateClose').addEventListener('click', () => {
                            document.body.removeChild(modal);
                        });
                    });
                    
                    // Modal schlie√üen bei Klick au√üerhalb (nur wenn nicht updating)
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal && !dialog.innerHTML.includes('wird aktualisiert')) {
                            document.body.removeChild(modal);
                        }
                    });
                    
                } else {
                    showNotification(`Firmware ist aktuell (Version ${currentVersion})`, 'success');
                }
                
            } catch (error) {
                console.error('Fehler bei Firmware-Update-Pr√ºfung:', error);
                showNotification('Fehler bei Update-Pr√ºfung', 'error');
            }
        }

        function changeProtocol(value) {
            protocol = value;
            // Protokoll ge√§ndert
            saveSettings();
        }

        // Notification-System
        function showNotification(message, type = 'info') {
            try {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    backdrop-filter: blur(10px);
                    max-width: 350px;
                `;
                
                const colors = {
                    'success': 'linear-gradient(135deg, #28a745, #20c997)',
                    'error': 'linear-gradient(135deg, #dc3545, #f86734)',
                    'warning': 'linear-gradient(135deg, #ffc107, #ff9800)',
                    'info': 'linear-gradient(135deg, #17a2b8, #007bff)'
                };
                
                notification.style.background = colors[type] || colors.info;
                notification.textContent = message;
                
                // Animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(400px); opacity: 0; }
                    }
                `;
                if (!document.querySelector('#notificationStyles')) {
                    style.id = 'notificationStyles';
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(notification);
                
                // Auto-remove nach 3 Sekunden
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Fehler beim Anzeigen der Benachrichtigung:', error);
            }
        }

        // ‚úÖ BLUETOOTH SCAN MIT GLOBALEM BLE CONTROLLER
        async function scanForDevices() {
            if (isScanning) return;
            
            isScanning = true;
            updateScanButton();
            updateConnectionStatus('üîç Suche nach Bluetooth-Ger√§ten...');
            
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '<div class="scanning-animation">üîÑ Scanne nach LED-B√§ndern...</div>';
            
            try {
                // ‚úÖ VERWENDE DEN GLOBALEN BLE CONTROLLER
                let controller = null;
                
                if (window.parent && window.parent !== window && window.parent.bleController) {
                    controller = window.parent.bleController;
                } else if (window.bleController) {
                    controller = window.bleController;
                } else {
                    throw new Error('BLE Controller nicht verf√ºgbar! Bitte Seite neu laden.');
                }
                
                // ‚úÖ SCAN √úBER CONTROLLER (der die echte Bluetooth API nutzt)
                const device = await controller.scan();
                
                deviceList.innerHTML = '';
                
                if (device) {
                    // ‚úÖ GER√ÑT GEFUNDEN - ZEIGE VERBINDEN-BUTTON
                    const deviceItem = document.createElement('div');
                    deviceItem.className = 'device-item';
                    deviceItem.innerHTML = `
                        <div class="device-info">
                            <span class="device-name">üì± ${device.name || 'LED-Controller'}</span>
                            <span class="device-id">ID: ${device.id}</span>
                            <span class="device-status">üü¢ Bereit zum Verbinden</span>
                        </div>
                        <button class="connect-btn" onclick="connectToRealDevice('${device.id}')">
                            <i class="fas fa-link"></i> Verbinden
                        </button>
                    `;
                    deviceList.appendChild(deviceItem);
                    
                    updateConnectionStatus(`‚úÖ Ger√§t gefunden: ${device.name || 'LED-Controller'}`);
                    showNotification('LED-Controller gefunden! Klicke auf Verbinden.', 'success');
                } else {
                    deviceList.innerHTML = '<div class="no-devices">Keine Ger√§te gefunden</div>';
                    updateConnectionStatus('‚ùå Keine Ger√§te gefunden');
                }
                
            } catch (error) {
                console.error('Bluetooth-Scan Fehler:', error);
                
                // Benutzerfreundliche Fehlermeldungen
                let errorMessage = 'Fehler beim Scannen';
                if (error.message.includes('User cancelled') || error.message.includes('NotFoundError')) {
                    errorMessage = 'Scan abgebrochen oder kein Ger√§t ausgew√§hlt';
                } else if (error.message.includes('not available')) {
                    errorMessage = 'Bluetooth nicht verf√ºgbar - Nutze Chrome/Edge mit HTTPS';
                } else if (error.message.includes('BLE Controller')) {
                    errorMessage = 'App nicht richtig geladen - Bitte Seite neu laden';
                } else {
                    errorMessage = error.message;
                }
                
                deviceList.innerHTML = `<div class="error">‚ùå ${errorMessage}</div>`;
                updateConnectionStatus(`‚ùå ${errorMessage}`);
                showNotification(errorMessage, 'error');
            } finally {
                isScanning = false;
                updateScanButton();
            }
        }
        
        // ‚úÖ ECHTE HARDWARE-VERBINDUNG MIT GLOBALEM BLE CONTROLLER
        async function connectToRealDevice(deviceId) {
            try {
                // ‚úÖ VERWENDE DEN GLOBALEN BLE CONTROLLER AUS app.js!
                let controller = null;
                
                // In iframe? Dann parent.bleController
                if (window.parent && window.parent !== window && window.parent.bleController) {
                    controller = window.parent.bleController;
                    console.log('üîó Verwende Parent bleController f√ºr Verbindung');
                } 
                // Direkt? Dann window.bleController
                else if (window.bleController) {
                    controller = window.bleController;
                    console.log('üîó Verwende lokalen bleController f√ºr Verbindung');
                } else {
                    throw new Error('BLE Controller nicht verf√ºgbar! Bitte Seite neu laden.');
                }
                
                updateConnectionStatus(`üîÑ Verbinde mit Bluetooth-Ger√§t...`);
                
                // ‚úÖ ECHTE VERBINDUNG √úBER DEN GLOBALEN CONTROLLER
                await controller.connect();
                
                if (controller.isConnected) {
                    const deviceName = controller.deviceName || 'LED-Controller';
                    
                    // ‚úÖ SPEICHERE F√úR AUTO-RECONNECT
                    localStorage.setItem('lastConnectedDevice', JSON.stringify({
                        type: 'bluetooth',
                        id: controller.deviceId,
                        name: deviceName,
                        protocol: controller.protocol,
                        timestamp: Date.now()
                    }));
                    
                    // ‚úÖ TEST-SEQUENZ AUSF√úHREN
                    updateConnectionStatus('üß™ Teste LED-Verbindung...');
                    await controller.runTestSequence();
                    
                    updateConnectionStatus(`‚úÖ Erfolgreich verbunden mit ${deviceName}`);
                    showNotification(`‚úÖ Bluetooth verbunden mit ${deviceName}!`, 'success');
                    
                    // ‚úÖ STATUS AN ALLE MODULE SENDEN
                    if (window.parent && window.parent.updateBLEStatus) {
                        window.parent.updateBLEStatus();
                    }
                    
                    // UI aktualisieren
                    updateDeviceList();
                    
                } else {
                    throw new Error('Verbindung konnte nicht hergestellt werden');
                }
                
            } catch (error) {
                console.error('‚ùå Verbindungsfehler:', error);
                
                let errorMsg = 'Verbindung fehlgeschlagen';
                if (error.message.includes('User cancelled')) {
                    errorMsg = 'Verbindung abgebrochen';
                } else if (error.message.includes('Bluetooth')) {
                    errorMsg = 'Bluetooth nicht verf√ºgbar oder deaktiviert';
                } else if (error.message.includes('GATT')) {
                    errorMsg = 'Ger√§t nicht kompatibel';
                } else {
                    errorMsg = error.message;
                }
                
                updateConnectionStatus(`‚ùå ${errorMsg}`);
                showNotification(`‚ùå ${errorMsg}`, 'error');
            }
        }
        
        // ‚úÖ ECHTE WLED-INTEGRATION MIT HTTP/JSON API
        async function scanForWLEDDevices() {
            const wledList = document.getElementById('wledDevicesList');
            wledList.innerHTML = '<div style="color: #4ecdc4;">üîç Suche WLED-Ger√§te...</div>';
            
            const foundDevices = [];
            
            // Scanne typische WLED-IPs im lokalen Netzwerk
            const baseIP = '192.168.1.'; // Anpassen je nach Netzwerk
            const scanPromises = [];
            
            for (let i = 1; i <= 254; i++) {
                const ip = baseIP + i;
                scanPromises.push(
                    fetch(`http://${ip}/json/info`, { 
                        method: 'GET',
                        mode: 'no-cors',
                        signal: AbortSignal.timeout(500) 
                    })
                    .then(() => {
                        foundDevices.push({
                            ip: ip,
                            name: `WLED Controller ${ip}`
                        });
                    })
                    .catch(() => {}) // Ignoriere Fehler
                );
            }
            
            // Zus√§tzlich mDNS-Namen probieren
            scanPromises.push(
                fetch('http://wled.local/json/info', { signal: AbortSignal.timeout(1000) })
                .then(res => res.json())
                .then(data => {
                    foundDevices.push({
                        ip: 'wled.local',
                        name: data.name || 'WLED Controller',
                        version: data.ver,
                        leds: data.leds.count
                    });
                })
                .catch(() => {})
            );
            
            await Promise.allSettled(scanPromises);
            
            // Zeige gefundene Ger√§te
            if (foundDevices.length > 0) {
                wledList.innerHTML = '';
                foundDevices.forEach(device => {
                    const deviceEl = document.createElement('div');
                    deviceEl.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(78,205,196,0.1); border-radius: 8px; margin-bottom: 10px;';
                    deviceEl.innerHTML = `
                        <div>
                            <div style="font-weight: bold; color: #4ecdc4;">${device.name}</div>
                            <div style="font-size: 0.9em; color: #888;">${device.ip}</div>
                            ${device.leds ? `<div style="font-size: 0.9em; color: #888;">LEDs: ${device.leds}</div>` : ''}
                        </div>
                        <button onclick="connectToWLED('${device.ip}')" style="padding: 8px 16px; background: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Verbinden
                        </button>
                    `;
                    wledList.appendChild(deviceEl);
                });
            } else {
                wledList.innerHTML = '<div style="color: #ff6b6b;">Keine WLED-Ger√§te gefunden</div>';
            }
        }
        
        // ‚úÖ VERBINDUNG ZU WLED-CONTROLLER
        async function connectToWLED(ip) {
            try {
                // Test-Verbindung
                const response = await fetch(`http://${ip}/json/state`);
                const state = await response.json();
                
                // Speichere WLED-Verbindung global
                window.wledDevice = {
                    ip: ip,
                    connected: true,
                    state: state
                };
                
                // Setze Test-Farbe
                await fetch(`http://${ip}/json/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        on: true,
                        bri: 255,
                        seg: [{
                            col: [[255, 0, 255]] // Magenta als Test
                        }]
                    })
                });
                
                showNotification(`‚úÖ Mit WLED ${ip} verbunden!`, 'success');
                
                // Update UI
                updateConnectionStatus(`WLED verbunden: ${ip}`);
                
            } catch (error) {
                console.error('WLED-Verbindung fehlgeschlagen:', error);
                showNotification('‚ùå WLED-Verbindung fehlgeschlagen', 'error');
            }
        }
        
        // ‚úÖ AUTO-RECONNECT FUNKTIONALIT√ÑT
        async function autoReconnect() {
            const savedDevice = localStorage.getItem('lastConnectedDevice');
            if (!savedDevice) return;
            
            try {
                const device = JSON.parse(savedDevice);
                
                if (device.type === 'bluetooth') {
                    // Auto-reconnect BLE
                    updateConnectionStatus('üîÑ Automatische Verbindung...');
                    
                    // Versuche gespeichertes Ger√§t zu verbinden
                    const devices = await navigator.bluetooth.getDevices();
                    for (const btDevice of devices) {
                        if (btDevice.id === device.id) {
                            await btDevice.gatt.connect();
                            window.ledDevice = {
                                device: btDevice,
                                server: btDevice.gatt,
                                isConnected: true
                            };
                            updateConnectionStatus(`‚úÖ Auto-verbunden: ${btDevice.name}`);
                            break;
                        }
                    }
                } else if (device.type === 'wled') {
                    // Auto-reconnect WLED
                    await connectToWLED(device.ip);
                }
                
            } catch (error) {
                console.log('Auto-Reconnect nicht m√∂glich:', error);
            }
        }
        
        // ‚úÖ PIXEL-LEVEL KONTROLLE
        async function setPixel(pixelIndex, r, g, b) {
            if (window.ledDevice?.isConnected) {
                // BLE Pixel-Control
                const cmd = new Uint8Array([
                    0x7E, 0x01, // Pixel-Mode
                    (pixelIndex >> 8) & 0xFF, pixelIndex & 0xFF,
                    r, g, b,
                    0xEF
                ]);
                await window.ledDevice.characteristic.writeValue(cmd);
                
            } else if (window.wledDevice?.connected) {
                // WLED Pixel-Control √ºber Segment
                await fetch(`http://${window.wledDevice.ip}/json/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        seg: [{
                            i: [pixelIndex, [r, g, b]]
                        }]
                    })
                });
            }
        }

        // ‚úÖ NEUE FUNKTION: Verbundene Ger√§te anzeigen
        function updateDeviceList() {
            let controller = null;
            
            if (window.parent && window.parent !== window && window.parent.bleController) {
                controller = window.parent.bleController;
            } else if (window.bleController) {
                controller = window.bleController;
            }
            
            if (!controller) return;
            
            const deviceList = document.getElementById('deviceList');
            if (!deviceList) return;
            
            if (controller.isConnected) {
                const status = controller.getConnectionStatus();
                deviceList.innerHTML = `
                    <div class="device-item connected">
                        <div class="device-info">
                            <span class="device-name">‚úÖ ${status.device.name || 'LED-Controller'}</span>
                            <span class="device-status" style="color: #00ff00;">üü¢ Verbunden</span>
                            <span class="device-protocol">Protokoll: ${status.device.protocol}</span>
                        </div>
                        <button class="disconnect-btn" onclick="disconnectDevice()" style="background: #ff4757; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-unlink"></i> Trennen
                        </button>
                    </div>
                `;
            }
        }
        
        // ‚úÖ NEUE FUNKTION: Ger√§t trennen
        window.disconnectDevice = async function() {
            try {
                let controller = null;
                
                if (window.parent && window.parent !== window && window.parent.bleController) {
                    controller = window.parent.bleController;
                } else if (window.bleController) {
                    controller = window.bleController;
                }
                
                if (controller && controller.isConnected) {
                    controller.disconnect();
                    updateConnectionStatus('‚ùå Getrennt');
                    showNotification('Bluetooth-Verbindung getrennt', 'info');
                    
                    // Liste aktualisieren
                    const deviceList = document.getElementById('deviceList');
                    if (deviceList) {
                        deviceList.innerHTML = '<div class="no-devices">Kein Ger√§t verbunden</div>';
                    }
                    
                    // Status an andere Module senden
                    if (window.parent && window.parent.updateBLEStatus) {
                        window.parent.updateBLEStatus();
                    }
                }
            } catch (error) {
                console.error('Fehler beim Trennen:', error);
                showNotification('Fehler beim Trennen', 'error');
            }
        }

        // ‚úÖ HAUPTINITIALISIERUNG MIT AUTO-RECONNECT
        document.addEventListener('DOMContentLoaded', async () => {
            await initBLE();
            
            // ‚úÖ PR√úFE OB BEREITS VERBUNDEN
            setTimeout(() => {
                updateDeviceList();
                
                let controller = null;
                if (window.parent && window.parent !== window && window.parent.bleController) {
                    controller = window.parent.bleController;
                } else if (window.bleController) {
                    controller = window.bleController;
                }
                
                if (controller && controller.isConnected) {
                    const status = controller.getConnectionStatus();
                    updateConnectionStatus(`‚úÖ Verbunden mit ${status.device.name}`);
                }
            }, 500);
            
            // Auto-Reconnect beim Start
            setTimeout(autoReconnect, 1000);
            
            // Scan-Button Event
            document.getElementById('scanButton').addEventListener('click', scanForDevices);
            
            // ‚úÖ ALLE SWITCH-EVENTS HINZUF√úGEN
            document.getElementById('autoConnectSwitch').addEventListener('click', function() {
                autoConnect = !autoConnect;
                this.classList.toggle('active');
                saveSettings();
                showNotification(`Auto-Verbindung ${autoConnect ? 'aktiviert' : 'deaktiviert'}`, 'success');
            });
            
            // ‚úÖ WLED-SWITCH EVENT
            document.getElementById('wledSwitch').addEventListener('click', function() {
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');
                
                // Zeige/Verstecke WLED-Optionen
                document.getElementById('wledScanSection').style.display = isActive ? 'block' : 'none';
                document.getElementById('wledDevicesSection').style.display = isActive ? 'block' : 'none';
                
                if (isActive) {
                    showNotification('WLED-Integration aktiviert', 'success');
                    // Auto-Scan beim Aktivieren
                    setTimeout(() => scanForWLEDDevices(), 500);
                } else {
                    showNotification('WLED-Integration deaktiviert', 'info');
                    // Trenne WLED-Verbindung
                    if (window.wledDevice) {
                        window.wledDevice.connected = false;
                        window.wledDevice = null;
                    }
                }
                
                localStorage.setItem('wledEnabled', isActive);
            });
            
            // ‚úÖ PIXEL-CONTROL SWITCH
            document.getElementById('pixelControlSwitch').addEventListener('click', function() {
                this.classList.toggle('active');
                const isActive = this.classList.contains('active');
                window.pixelControlEnabled = isActive;
                
                showNotification(`Pixel-Control ${isActive ? 'aktiviert' : 'deaktiviert'}`, 'success');
                localStorage.setItem('pixelControlEnabled', isActive);
                
                // Sende Info an andere Module
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'pixelControlChanged',
                        enabled: isActive
                    }, '*');
                }
            });
            
            document.getElementById('notificationsSwitch').addEventListener('click', function() {
                notifications = !notifications;
                this.classList.toggle('active');
                saveSettings();
                showNotification(`Benachrichtigungen ${notifications ? 'aktiviert' : 'deaktiviert'}`, 'success');
            });
            
            document.getElementById('darkModeSwitch').addEventListener('click', toggleDarkMode);
            
            document.getElementById('wledSwitch').addEventListener('click', toggleWLED);
            
            document.getElementById('hierarchicalGroupsSwitch').addEventListener('click', toggleHierarchicalGroups);
            
            document.getElementById('pixelControlSwitch').addEventListener('click', togglePixelControl);
            
            document.getElementById('hwAccelSwitch').addEventListener('click', function() {
                hwAccel = !hwAccel;
                this.classList.toggle('active');
                saveSettings();
                showNotification(`Hardware-Beschleunigung ${hwAccel ? 'aktiviert' : 'deaktiviert'}`, 'success');
            });
            
            // ‚úÖ WLED SCAN BUTTON
            const wledScanBtn = document.getElementById('wledScanBtn');
            if (wledScanBtn) {
                wledScanBtn.addEventListener('click', scanWLEDDevices);
            }
            
            // ‚úÖ SLIDER EVENTS
            document.getElementById('brightnessSlider').addEventListener('input', function() {
                brightness = this.value;
                document.getElementById('brightnessValue').textContent = brightness + '%';
                saveSettings();
            });
            
            document.getElementById('fpsSlider').addEventListener('input', function() {
                fps = this.value;
                document.getElementById('fpsValue').textContent = fps + ' FPS';
                saveSettings();
            });
            
            document.getElementById('packetSizeSlider').addEventListener('input', function() {
                packetSize = this.value;
                document.getElementById('packetSizeValue').textContent = packetSize + ' Bytes';
                saveSettings();
            });
            
            document.getElementById('micSensitivitySlider').addEventListener('input', function() {
                micSensitivity = this.value;
                document.getElementById('micSensitivityValue').textContent = micSensitivity + '%';
                saveSettings();
            });
            
            // ‚úÖ LANGUAGE SELECT EVENT
            document.getElementById('languageSelect').addEventListener('change', function() {
                changeLanguage(this.value);
            });
        });
    </script>

    <!-- Device Manager f√ºr erweiterte Ger√§teverwaltung -->
    <script src="js/device-manager.js"></script>

</body>
</html>
