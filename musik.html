<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musik World</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
            padding-top: 70px;
        }

        /* Taskbar Styles - BlackPlayer inspired */
        .taskbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #0f0f0f;
            border-bottom: 1px solid #1a1a1a;
            padding: 12px 20px;
            z-index: 1000;
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            height: 60px;
        }

        .taskbar::-webkit-scrollbar {
            display: none;
        }

        .taskbar-btn {
            background: transparent;
            border: none;
            color: #888888;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            margin: 0 2px;
            font-size: 0.85em;
            font-weight: 500;
            display: flex;
            align-items: center;
            height: 36px;
        }

        .taskbar-btn i {
            margin-right: 6px;
            font-size: 1em;
        }

        .taskbar-btn:hover {
            background: #1a1a1a;
            color: #ffffff;
        }

        .taskbar-btn.active {
            background: #ff6b35;
            color: #ffffff;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .taskbar::-webkit-scrollbar {
            height: 6px;
        }
        
        .taskbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .taskbar::-webkit-scrollbar-thumb {
            background: #4ecdc4;
            border-radius: 3px;
        }

        .content-panel {
            background: #0f0f0f;
            border-radius: 0;
            padding: 0;
            margin: 0;
            display: none;
            min-height: calc(100vh - 60px);
        }

        .content-panel.active {
            display: block;
        }

        .panel-header {
            background: #0f0f0f;
            border-bottom: 1px solid #1a1a1a;
            padding: 20px 24px;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
        }

        .panel-header i {
            font-size: 1.2em;
            margin-right: 10px;
            color: #ff6b35;
        }

        .panel-title {
            font-size: 1.1em;
            font-weight: 500;
            color: #ffffff;
            margin: 0;
        }

        /* Settings Section Styles */
        .settings-section {
            background: #111111;
            border-radius: 8px;
            margin: 16px 24px;
            border: 1px solid #1a1a1a;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: #0f0f0f;
            border-bottom: 1px solid #1a1a1a;
        }

        .section-header i {
            color: #ff6b35;
            margin-right: 10px;
            font-size: 1em;
        }

        .section-header h3 {
            color: #ffffff;
            font-size: 0.95em;
            font-weight: 500;
            margin: 0;
        }

        .section-content {
            padding: 20px;
        }

        /* Modern Button Grid */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .action-btn {
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #2a2a2a;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85em;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .action-btn:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }

        .action-btn.success {
            background: #28a745;
            border-color: #28a745;
        }

        /* Library Panel Styles */
        .library-header-controls {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .header-btn {
            background: transparent;
            border: 1px solid #2a2a2a;
            color: #888;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .header-btn:hover {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #3a3a3a;
        }

        .header-btn.active {
            background: #ff6b35;
            color: #ffffff;
            border-color: #ff6b35;
        }

        .library-nav {
            display: flex;
            gap: 4px;
            padding: 16px 24px;
            background: #0f0f0f;
            border-bottom: 1px solid #1a1a1a;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .library-nav::-webkit-scrollbar {
            display: none;
        }

        .library-nav-btn {
            background: transparent;
            border: 1px solid #2a2a2a;
            color: #888;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .library-nav-btn:hover {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #3a3a3a;
        }

        .library-nav-btn.active {
            background: rgba(255, 107, 53, 0.2);
            color: #ff6b35;
            border-color: #ff6b35;
        }

        .library-search {
            padding: 16px 24px;
            background: #0f0f0f;
            border-bottom: 1px solid #1a1a1a;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            color: #666;
            z-index: 2;
        }

        #librarySearchInput {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid #2a2a2a;
            border-radius: 25px;
            background: #1a1a1a;
            color: #ffffff;
            font-size: 0.9em;
            outline: none;
            transition: all 0.2s ease;
        }

        #librarySearchInput:focus {
            border-color: #ff6b35;
            background: #222;
        }

        .search-clear-btn {
            position: absolute;
            right: 8px;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .search-clear-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .library-sort {
            padding: 16px 24px;
            background: #0f0f0f;
            border-bottom: 1px solid #1a1a1a;
        }

        .sort-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sort-btn {
            background: transparent;
            border: 1px solid #2a2a2a;
            color: #888;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sort-btn:hover {
            background: #1a1a1a;
            color: #ffffff;
            border-color: #3a3a3a;
        }

        .sort-btn.active {
            background: #ff6b35;
            color: #ffffff;
            border-color: #ff6b35;
        }

        .library-content {
            padding: 24px;
        }

        .library-section {
            display: none;
        }

        .library-section.active {
            display: block;
        }

        .section-header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header-info h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .item-count {
            color: #888;
            font-size: 0.9em;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .library-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 16px;
            color: #444;
        }

        .empty-state h4 {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #888;
        }

        .empty-state p {
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Artist Card */
        .artist-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .artist-card:hover {
            background: #222;
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }

        .artist-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
        }

        .artist-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .artist-info {
            color: #888;
            font-size: 0.8em;
        }

        /* Album Card */
        .album-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .album-card:hover {
            background: #222;
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }

        .album-cover {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
        }

        .album-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            font-size: 0.9em;
            line-height: 1.3;
        }

        .album-artist {
            color: #888;
            font-size: 0.8em;
        }

        /* Song Item */
        .song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .song-item:hover {
            background: #222;
            border-color: #2a2a2a;
        }

        .song-item.playing {
            background: rgba(255, 107, 53, 0.1);
            border-color: #ff6b35;
        }

        .song-cover {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-title {
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 2px;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-meta {
            color: #888;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-duration {
            color: #666;
            font-size: 0.8em;
            flex-shrink: 0;
        }

        .song-item.playing .song-duration {
            color: #ff6b35;
        }

        /* Genre Card */
        .genre-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .genre-card:hover {
            background: #222;
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }

        .genre-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #333;
        }

        .genre-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .genre-count {
            color: #888;
            font-size: 0.8em;
        }

        /* Folder Card */
        .folder-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .folder-card:hover {
            background: #222;
            border-color: #3a3a3a;
            transform: translateY(-2px);
        }

        .folder-icon {
            font-size: 2.5em;
            color: #ff6b35;
            margin-bottom: 12px;
        }

        .folder-name {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .folder-count {
            color: #888;
            font-size: 0.8em;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .context-menu-item {
            padding: 10px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .context-menu-item:hover {
            background: #3a3a3a;
        }

        .context-menu-item i {
            width: 16px;
            color: #888;
        }

        .context-menu-separator {
            height: 1px;
            background: #3a3a3a;
            margin: 4px 0;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #ff6b35;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .fab:hover {
            background: #e55a2b;
            transform: scale(1.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .library-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }

            .library-content {
                padding: 16px;
            }

            .library-nav {
                padding: 12px 16px;
            }

            .library-search {
                padding: 12px 16px;
            }

            .library-sort {
                padding: 12px 16px;
            }

            .sort-options {
                gap: 6px;
            }

            .fab {
                bottom: 16px;
                right: 16px;
                width: 48px;
                height: 48px;
                font-size: 1.1em;
            }
        }

        /* Hidden File Input */
        #musicFileInput {
            display: none;
        }

        .action-btn.success:hover {
            background: #218838;
        }

        .action-btn.info {
            background: #17a2b8;
            border-color: #17a2b8;
        }

        .action-btn.info:hover {
            background: #138496;
        }

        .action-btn.warning {
            background: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        .action-btn.danger {
            background: #dc3545;
            border-color: #dc3545;
        }

        /* Info Box */
        .info-box {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .info-box-title {
            color: #ff6b35;
            font-weight: 500;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .info-box-content {
            color: #cccccc;
            font-size: 0.85em;
            line-height: 1.4;
        }

        /* Music Player Styles */
        .visualizer-screen {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(26, 26, 46, 0.9));
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(78, 205, 196, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .visualizer-display {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visualizer-bars {
            display: flex;
            gap: 4px;
            align-items: end;
            height: 60%;
            width: 80%;
        }

        .vis-bar {
            flex: 1;
            background: linear-gradient(to top, #4ecdc4, #44a08d, #00b894);
            border-radius: 3px 3px 0 0;
            transition: height 0.15s ease;
            min-height: 5px;
        }

        .visualizer-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 20px;
        }

        .track-info {
            text-align: center;
        }

        .track-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 5px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.7);
        }

        .track-artist {
            font-size: 1rem;
            color: #a0f0ff;
            opacity: 0.9;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0;
            padding: 0 20px;
        }

        .main-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .right-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .repeat-btn {
            position: relative;
        }

        .repeat-btn.repeat-one::after {
            content: "1";
            position: absolute;
            top: -5px;
            right: -5px;
            background: #4ecdc4;
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .favorite-btn.active {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .music-library {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }


.shuffle-btn.active, .repeat-btn.active, .favorite-btn.active {
    background: #4ecdc4;
    color: #16213e;
    transform: scale(1.1);
}

.favorite-btn.active {
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.2);
}


.library-nav {
    display: flex;
    gap: 8px;
    padding: 16px 24px;
    overflow-x: auto;
    border-bottom: 1px solid #1a1a1a;
    background: #0f0f0f;
}

.library-nav-btn {
    background: transparent;
    border: 1px solid #2a2a2a;
    color: #888888;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 6px;
}

.library-nav-btn:hover {
    background: #1a1a1a;
    color: #ffffff;
    border-color: #3a3a3a;
}

.library-nav-btn.active {
    background: #ff6b35;
    border-color: #ff6b35;
    color: #ffffff;
}

.library-nav-btn i {
    font-size: 0.9em;
}

.library-section {
    padding: 24px;
    display: none;
}

.library-section.active {
    display: block;
}

.album-card, .artist-card, .playlist-card, .folder-card {
    background: #111111;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.15s ease;
}

.album-card:hover, .artist-card:hover, .playlist-card:hover, .folder-card:hover {
    background: #1a1a1a;
    border-color: #2a2a2a;
}

.album-card .album-cover {
    width: 100%;
    height: 120px;
    background: #1a1a1a;
    border-radius: 6px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666666;
    font-size: 1.8em;
}

.album-card .album-title {
    font-weight: 500;
    color: #ffffff;
    font-size: 0.9em;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.album-card .album-artist {
    color: #888888;
    font-size: 0.8em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.song-list {
    margin-top: 15px;
    max-height: 500px;
    overflow-y: auto;
    border-radius: 8px;
    background: transparent;
}

.song-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #1a1a1a;
    cursor: pointer;
    transition: background 0.15s ease;
}

.song-item:hover {
    background: #1a1a1a;
}

.song-item.playing {
    background: rgba(255, 107, 53, 0.1);
    border-left: 3px solid #ff6b35;
}

.song-icon {
    width: 48px;
    height: 48px;
    background: #1a1a1a;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 1.1em;
    color: #666666;
}

.song-details {
    flex: 1;
    min-width: 0;
}

.song-name {
    font-weight: 500;
    margin-bottom: 4px;
    color: #ffffff;
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.song-artist {
    color: #888888;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.song-duration {
    color: #ff6b35;
    font-size: 0.8rem;
    background: rgba(255, 107, 53, 0.1);
    padding: 4px 8px;
    border-radius: 12px;
}

.context-menu {
    position: absolute;
    background: #111111;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 4px 0;
    z-index: 1000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
}

.context-menu-item {
    padding: 10px 20px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
}

.context-menu-item:hover {
    background: rgba(78, 205, 196, 0.2);
}

.context-menu-item i {
    color: #4ecdc4;
    width: 16px;
}

.volume-display {
    min-width: 40px;
    text-align: center;
    font-weight: bold;
    color: #4ecdc4;
    background: rgba(78, 205, 196, 0.1);
    padding: 5px 8px;
    border-radius: 15px;
    font-size: 0.85rem;
}

.controls {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.control-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

        .volume-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            padding: 5px 8px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .btn.active {
            background: #4ecdc4;
            color: #16213e;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 0 20px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background: #ff6b35;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .current-song {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: #0f0f0f;
            border-radius: 12px;
            border: 1px solid #1a1a1a;
        }

        .song-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .song-artist {
            font-size: 0.95rem;
            color: #888888;
            font-weight: 400;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            background: #4ecdc4;
            border-radius: 50%;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .sleep-timer {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            justify-content: center;
        }

        .sleep-timer select {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            color: white;
            cursor: pointer;
        }

        /* Equalizer Styles */
        .equalizer {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .eq-band {
            text-align: center;
        }

        .eq-label {
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .eq-slider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            -moz-appearance: slider-vertical;
            appearance: slider-vertical;
            width: 30px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            border-radius: 15px;
            padding: 5px;
        }

        .presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .preset-btn.active {
            background: #4ecdc4;
            color: #16213e;
        }

        /* Visualizer Styles */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 0;
        }
        
        .category-card:hover {
            background: rgba(78, 205, 196, 0.2) !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .visual-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .visual-preset {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .visual-preset:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }

        .visual-preset.active {
            background: #4ecdc4;
            color: #16213e;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .visual-preset i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        /* LED Styles */
        .led-controls {
            display: grid;
            gap: 20px;
        }

        .led-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
        }

        .led-section h4 {
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
        }

        .led-section h4 i {
            margin-right: 10px;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        select, input[type="color"] {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            width: 100%;
            cursor: pointer;
        }

        input[type="color"] {
            height: 40px;
            padding: 5px;
        }

        .range-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-control input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .range-control input[type="range"]::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            background: #4ecdc4;
            border-radius: 50%;
            -webkit-appearance: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(78, 205, 196, 0.3);
            transition: all 0.2s ease;
        }

        .range-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.5);
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }

        /* Music Library Styles */
        .music-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            padding: 80px 20px 20px;
            overflow-y: auto;
        }

        .music-overlay.open {
            display: block;
        }

        .music-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            max-width: 1200px;
            margin: 0 auto 30px;
            padding: 0 20px;
        }

        .close-overlay {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
        }

        .search-bar {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            margin-bottom: 25px;
            max-width: 1200px;
            margin: 0 auto 25px;
            display: block;
        }

        .search-bar::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .music-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .music-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .music-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }

        .album-art {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #4ecdc4, #556ee6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
        }

        .music-info {
            padding: 15px;
        }

        .music-title {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-artist {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .lyrics-container {
            text-align: center;
            padding: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-top: 20px;
        }

        .lyrics-line {
            font-size: 1.2em;
            margin: 10px 0;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .taskbar {
                padding: 12px 15px;
            }
            
            .taskbar-btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }
            
            .taskbar-btn i {
                margin-right: 5px;
                font-size: 1em;
            }
            
            .equalizer {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .visual-presets {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .control-buttons {
                gap: 15px;
            }
            
            .btn {
                width: 45px;
                height: 45px;
            }
            
            .play-btn {
                width: 55px;
                height: 55px;
            }
            
            .music-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Taskbar -->
    <div class="taskbar">
        <button class="taskbar-btn active" data-content="player"><i class="fas fa-play"></i> Player</button>
        <button class="taskbar-btn" data-content="equalizer"><i class="fas fa-sliders-h"></i> Equalizer</button>
        <button class="taskbar-btn" data-content="visualizer"><i class="fas fa-wave-square"></i> Visualisierung</button>
        <button class="taskbar-btn" data-content="led"><i class="fas fa-music"></i> LED-Musik</button>
        <button class="taskbar-btn" data-content="party"><i class="fas fa-glass-cheers"></i> Party-Modus</button>
        <button class="taskbar-btn" data-content="library"><i class="fas fa-book"></i> Bibliothek</button>
        <button class="taskbar-btn" data-content="settings"><i class="fas fa-cog"></i> Einstellungen</button>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Player Panel -->
        <div class="content-panel active" id="player">
            <div class="panel-header">
                <i class="fas fa-play"></i>
                <h2 class="panel-title">Musik Player</h2>
            </div>
            
            <!-- Visualizer Screen -->
            <div class="visualizer-screen" id="visualizerScreen">
                <div class="visualizer-display" id="visualizerDisplay">
                    <div class="visualizer-bars" id="visualizerBars">
                        <!-- Bars will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- ✅ ALBUM-COVER ANZEIGE -->
            <div class="album-cover-section" style="display: flex; align-items: center; justify-content: center; padding: 20px 0; background: rgba(255, 255, 255, 0.03); border-radius: 15px; margin: 15px 0;">
                <div class="album-cover-container" style="position: relative; margin-right: 20px;">
                    <div class="album-cover" id="albumCover" style="
                        width: 120px; 
                        height: 120px; 
                        border-radius: 12px; 
                        background: linear-gradient(135deg, #667eea, #764ba2); 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px rgba(102, 126, 234, 0.2);
                        overflow: hidden;
                        transition: all 0.3s ease;
                    ">
                        <i class="fas fa-music" style="font-size: 2.5rem; color: rgba(255,255,255,0.7); transition: all 0.3s ease;" id="albumCoverIcon"></i>
                        <img id="albumCoverImage" style="width: 100%; height: 100%; object-fit: cover; display: none;" alt="Album Cover">
                    </div>
                    <div class="album-cover-glow" style="
                        position: absolute; 
                        top: -10px; 
                        left: -10px; 
                        right: -10px; 
                        bottom: -10px; 
                        border-radius: 20px; 
                        background: inherit; 
                        filter: blur(15px); 
                        opacity: 0.3; 
                        z-index: -1;
                        transition: all 0.3s ease;
                    "></div>
                </div>
                
                <!-- Track Info neben Album-Cover -->
                <div class="track-info-details" style="flex: 1; text-align: left;">
                    <div class="track-title" id="trackTitle" style="font-size: 1.6rem; font-weight: bold; color: #4ecdc4; margin-bottom: 8px; line-height: 1.2;">Kein Titel ausgewählt</div>
                    <div class="track-artist" id="trackArtist" style="font-size: 1.1rem; color: #a0a0a0; margin-bottom: 6px;">Unbekannter Künstler</div>
                    <div class="track-album" id="trackAlbum" style="font-size: 0.95rem; color: #707070; font-style: italic;">Unbekanntes Album</div>
                    <div class="track-year" id="trackYear" style="font-size: 0.85rem; color: #606060; margin-top: 4px;"></div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <span class="time" id="currentTime">0:00</span>
                <div class="progress-bar" id="progressBarContainer">
                    <div class="progress" id="progressBar"></div>
                </div>
                <span class="time" id="totalTime">0:00</span>
            </div>
            
            <!-- Player Controls -->
            <div class="player-controls">
                <!-- Left Side: Repeat Button -->
                <button class="btn repeat-btn" id="repeatBtn" title="Wiederholen: Aus">
                    <i class="fas fa-redo" id="repeatIcon"></i>
                </button>
                
                <!-- Center: Previous, Play/Pause, Next -->
                <div class="main-controls">
                    <button class="btn" id="prevBtn">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="btn play-btn" id="playBtn">
                        <i class="fas fa-play" id="playIcon"></i>
                    </button>
                    <button class="btn" id="nextBtn">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <!-- Right Side: Shuffle and Favorite -->
                <div class="right-controls">
                    <button class="btn shuffle-btn" id="shuffleBtn" title="Zufallswiedergabe: Aus">
                        <i class="fas fa-random" id="shuffleIcon"></i>
                    </button>
                    <button class="btn favorite-btn" id="favoriteBtn" title="Zu Favoriten hinzufügen">
                        <i class="fas fa-star" id="favoriteIcon"></i>
                    </button>
                </div>
            </div>
            
            <!-- Volume Control ENTFERNT - Nutze Handy-Lautstärke -->
            <!-- Lautstärke wird über die Handy-Lautstärketasten gesteuert -->
            
            <!-- Lyrics Display -->
            <div class="lyrics-container" id="lyricsContainer" style="display: none; background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin: 20px 0; max-height: 300px; overflow-y: auto;">
                <div class="lyrics-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #4ecdc4; margin: 0;">
                        <i class="fas fa-file-alt"></i> Liedtext
                    </h4>
                    <div class="lyrics-controls">
                        <button id="lyricsSyncBtn" class="btn" style="background: rgba(78, 205, 196, 0.2); color: #4ecdc4; border: 1px solid #4ecdc4; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">
                            <i class="fas fa-sync" id="lyricsSyncIcon"></i> Sync
                        </button>
                        <button id="lyricsSizeBtn" class="btn" style="background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); padding: 5px 10px; border-radius: 5px; font-size: 0.8em; margin-left: 5px;">
                            <i class="fas fa-text-height"></i>
                        </button>
                    </div>
                </div>
                
                <div class="lyrics-content" id="lyricsContent" style="line-height: 1.8; font-size: 1rem; color: #e0e0e0; text-align: center;">
                    <div class="lyrics-placeholder" style="opacity: 0.6; font-style: italic;">
                        <i class="fas fa-music" style="font-size: 2em; margin-bottom: 10px; display: block; color: #4ecdc4;"></i>
                        Keine Liedtexte verfügbar
                        <div style="font-size: 0.9em; margin-top: 5px;">LRC-Dateien werden automatisch geladen</div>
                    </div>
                </div>
                
                <!-- Lyrics Progress Indicator -->
                <div class="lyrics-progress" id="lyricsProgress" style="display: none; margin-top: 15px;">
                    <div style="background: rgba(255, 255, 255, 0.1); height: 3px; border-radius: 2px; overflow: hidden;">
                        <div id="lyricsProgressBar" style="background: #4ecdc4; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <!-- ✅ MUSIC LIBRARY ENTFERNT - Nutze stattdessen die Bibliothek-Tab! -->
            
            <!-- Context Menu for Songs -->
            <div class="context-menu" id="songContextMenu" style="display: none;">
                <div class="context-menu-item" data-action="play">
                    <i class="fas fa-play"></i> Abspielen
                </div>
                <div class="context-menu-item" data-action="queue">
                    <i class="fas fa-plus"></i> Zur Warteschlange hinzufügen
                </div>
                <div class="context-menu-item" data-action="favorites">
                    <i class="fas fa-heart"></i> Zu Favoriten hinzufügen
                </div>
                <div class="context-menu-item" data-action="playlist">
                    <i class="fas fa-list"></i> Zu Playlist hinzufügen
                </div>
                <div class="context-menu-item" data-action="info">
                    <i class="fas fa-info-circle"></i> Informationen anzeigen
                </div>
                <div class="context-menu-item" data-action="delete">
                    <i class="fas fa-trash"></i> Löschen
                </div>
            </div>
        </div>

        <!-- Add Music Panel -->

        <!-- Equalizer Panel -->
        <div class="content-panel" id="equalizer">
            <div class="panel-header">
                <i class="fas fa-sliders-h"></i>
                <h2 class="panel-title">Equalizer</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #4ecdc4;">
                        <input type="checkbox" id="eqToggle" checked style="transform: scale(1.3);">
                        <span style="font-weight: bold;">EQ Ein</span>
                    </label>
                </div>
            </div>
            
            <div class="presets">
                <button class="preset-btn active">Flat</button>
                <button class="preset-btn">Pop</button>
                <button class="preset-btn">Rock</button>
                <button class="preset-btn">Bass Boost</button>
                <button class="preset-btn">Klassik</button>
                <button class="preset-btn">Jazz</button>
            </div>
            
            <div class="equalizer">
                <div class="eq-band">
                    <div class="eq-label">60Hz</div>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical">
                </div>
                <div class="eq-band">
                    <div class="eq-label">170Hz</div>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical">
                </div>
                <div class="eq-band">
                    <div class="eq-label">310Hz</div>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical">
                </div>
                <div class="eq-band">
                    <div class="eq-label">600Hz</div>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical">
                </div>
                <div class="eq-band">
                    <div class="eq-label">1kHz</div>
                    <input type="range" class="eq-slider" min="-12" max="12" value="0" orient="vertical">
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 15px;">
                <button class="preset-btn">Speichern</button>
                <button class="preset-btn">Zurücksetzen</button>
            </div>
            
            <!-- Bassboost Section -->
            <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                <h4 style="color: #4ecdc4; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-drum"></i> Bass Boost
                </h4>
                
                <div style="display: flex; align-items: center; gap: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="bassBoostToggle" style="transform: scale(1.2);">
                        <span>Bass Boost aktivieren</span>
                    </label>
                    
                    <div style="flex: 1; display: flex; align-items: center; gap: 15px;">
                        <span style="min-width: 80px;">Intensität:</span>
                        <input type="range" id="bassBoostIntensity" min="0" max="12" value="0" style="flex: 1;" disabled>
                        <span id="bassBoostValue" style="min-width: 40px; text-align: right;">0dB</span>
                    </div>
                </div>
                
                <div style="margin-top: 10px; font-size: 0.9em; color: #888;">
                    Verstärkt die tiefen Frequenzen (20-250Hz) für kraftvollere Bässe
                </div>
            </div>
        </div>

        <!-- Visualizer Panel -->
        <div class="content-panel" id="visualizer">
            <div class="panel-header">
                <i class="fas fa-wave-square"></i>
                <h2 class="panel-title">Visualisierungseffekte</h2>
            </div>
            
            <div class="visual-presets">
                <div class="visual-preset active">
                    <i class="fas fa-chart-bar"></i>
                    Balken
                </div>
                <div class="visual-preset">
                    <i class="fas fa-water"></i>
                    Wellen
                </div>
                <div class="visual-preset">
                    <i class="fas fa-atom"></i>
                    Partikel
                </div>
                <div class="visual-preset">
                    <i class="fas fa-circle"></i>
                    Kreise
                </div>
                <div class="visual-preset">
                    <i class="fas fa-infinity"></i>
                    Spirale
                </div>
                <div class="visual-preset">
                    <i class="fas fa-grip-lines"></i>
                    Linien
                </div>
                <div class="visual-preset">
                    <i class="fas fa-chart-area"></i>
                    Spektrum
                </div>
                <div class="visual-preset">
                    <i class="fas fa-fire"></i>
                    Feuer
                </div>
            </div>
            
            <!-- ✅ VISUALIZER CANVAS FÜR ECHTE VISUALISIERUNG -->
            <div style="margin-top: 20px; background: #000; border-radius: 15px; padding: 20px; position: relative; overflow: hidden;">
                <canvas id="visualizerCanvas" style="width: 100%; height: 300px; display: block;"></canvas>
                <div id="visualizerBars" style="display: flex; justify-content: space-around; align-items: flex-end; height: 200px; margin-top: 10px;"></div>
            </div>
            
            <!-- ✅ VISUALIZER EINSTELLUNGEN -->
            <div style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                <h4 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-cog"></i> Visualizer Einstellungen</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <label>Empfindlichkeit:</label>
                        <input type="range" id="vizSensitivity" min="1" max="10" value="5" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label>Farbe:</label>
                        <input type="color" id="vizColor" value="#4ecdc4" style="width: 100%; height: 40px;">
                    </div>
                    <div style="flex: 1;">
                        <label>Glättung:</label>
                        <input type="range" id="vizSmoothing" min="0" max="100" value="80" style="width: 100%;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Original LED-Musik-Steuerung Panel -->
        <div class="content-panel" id="led">
            <div class="panel-header">
                <i class="fas fa-music"></i>
                <h2 class="panel-title">LED-Musik-Steuerung</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #4ecdc4;">
                        <input type="checkbox" id="ledMusicToggle" checked style="transform: scale(1.3);">
                        <span style="font-weight: bold;">LED-Musik Ein</span>
                    </label>
                </div>
            </div>
            
            <!-- LED-Musik-Control VOLLSTÄNDIGER INHALT -->
            <div class="led-music-control-content" style="padding: 20px;">
                
                <!-- Global Controls -->
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 30px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-weight: bold;">🤖 Automatik-Modus:</span>
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                            <input type="checkbox" id="ledMusicAutomaticMode" style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 30px;"></span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-weight: bold;">🔗 Sync alle Bänder:</span>
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                            <input type="checkbox" id="ledMusicSyncAll" style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 30px;"></span>
                        </label>
                    </div>
                </div>

                <!-- LED-Bänder Konfiguration -->
                <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #4ecdc4; margin-bottom: 15px;">
                        <i class="fas fa-sliders-h"></i> LED-Bänder Konfiguration
                    </h3>
                    <div style="background: rgba(78, 205, 196, 0.1); padding: 20px; border-radius: 10px;">
                        <label style="color: #4ecdc4; font-size: 1.1rem; display: block; margin-bottom: 10px;">Anzahl aktiver LED-Bänder</label>
                        <div style="color: #a0f0ff; margin-bottom: 15px;">Wähle aus, wie viele LED-Bänder du verwenden möchtest (1-10)</div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="ledBandCount" min="1" max="10" value="3" 
                                   style="flex: 1; height: 8px; border-radius: 4px; background: #333; outline: none;" 
                                   oninput="document.getElementById('ledBandCountValue').textContent = this.value; updateBandTabs(this.value);">
                            <span id="ledBandCountValue" style="color: #4ecdc4; font-weight: bold; font-size: 1.2rem; min-width: 30px;">3</span>
                        </div>
                    </div>
                </div>

                <!-- Band Tabs -->
                <div id="ledBandTabs" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 15px;">
                    <button class="led-band-tab active" data-band="audio-reactive" style="padding: 12px 20px; background: rgba(78, 205, 196, 0.2); border: 1px solid #4ecdc4; color: white; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-waveform-lines"></i> Audio-Reactive Engine
                    </button>
                    <button class="led-band-tab" data-band="0" style="padding: 12px 20px; background: rgba(58, 134, 255, 0.2); border: 1px solid #3A86FF; color: white; border-radius: 8px; cursor: pointer;">
                        <span style="display: inline-block; width: 12px; height: 12px; background: #3A86FF; border-radius: 50%; margin-right: 8px;"></span> LED-Band 1
                    </button>
                    <button class="led-band-tab" data-band="1" style="padding: 12px 20px; background: rgba(255, 0, 110, 0.2); border: 1px solid #FF006E; color: white; border-radius: 8px; cursor: pointer;">
                        <span style="display: inline-block; width: 12px; height: 12px; background: #FF006E; border-radius: 50%; margin-right: 8px;"></span> LED-Band 2
                    </button>
                    <button class="led-band-tab" data-band="2" style="padding: 12px 20px; background: rgba(255, 190, 11, 0.2); border: 1px solid #FFBE0B; color: white; border-radius: 8px; cursor: pointer;">
                        <span style="display: inline-block; width: 12px; height: 12px; background: #FFBE0B; border-radius: 50%; margin-right: 8px;"></span> LED-Band 3
                    </button>
                    <!-- Weitere Bänder 4-10 werden per JS hinzugefügt -->
                </div>

                <!-- Audio-Reactive Engine Content -->
                <div id="ledBandContent-audio-reactive" class="led-band-content" style="display: block;">
                    
                    <!-- Audio Control -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-music"></i> Musik-Analyse (KEIN Mikrofon)</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button id="startAudioCapture" style="padding: 12px 25px; background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-music"></i> Musik-Analyse starten
                            </button>
                            <button id="stopAudioCapture" style="padding: 12px 25px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; cursor: pointer; display: none;">
                                <i class="fas fa-stop"></i> Audio-Erfassung stoppen
                            </button>
                            <button id="scanLEDStrips" style="padding: 12px 25px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-bluetooth"></i> LED-Bänder scannen
                            </button>
                        </div>
                    </div>

                    <!-- Frequency Visualizer -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> Frequenz-Analyse</h3>
                        <div id="ledFrequencyDisplay" style="display: flex; align-items: end; gap: 2px; height: 120px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 10px;">
                            <!-- Frequenz-Balken werden dynamisch generiert -->
                        </div>
                        <div style="display: flex; justify-content: space-between; color: #ccc; font-size: 0.9rem; margin-top: 5px;">
                            <span>Bass</span>
                            <span>Mitten</span>
                            <span>Höhen</span>
                        </div>
                    </div>

                    <!-- Live-Status Grid -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Live-Status</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                            <div style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">Bass</div>
                                <div id="ledBassLevel" style="font-size: 1.4rem; font-weight: bold; color: #4ecdc4;">0%</div>
                            </div>
                            <div style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">Mitten</div>
                                <div id="ledMidLevel" style="font-size: 1.4rem; font-weight: bold; color: #4ecdc4;">0%</div>
                            </div>
                            <div style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">Höhen</div>
                                <div id="ledTrebleLevel" style="font-size: 1.4rem; font-weight: bold; color: #4ecdc4;">0%</div>
                            </div>
                            <div style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">BPM</div>
                                <div id="ledBPMValue" style="font-size: 1.4rem; font-weight: bold; color: #4ecdc4;">0</div>
                            </div>
                            <div style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">Latenz</div>
                                <div id="ledLatencyValue" style="font-size: 1.4rem; font-weight: bold; color: #4ecdc4;">0ms</div>
                            </div>
                            <div style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">Verbundene Bänder</div>
                                <div id="ledConnectedStrips" style="font-size: 1.4rem; font-weight: bold; color: #4ecdc4;">0</div>
                            </div>
                            <div id="ledBeatIndicator" style="background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 10px; padding: 15px; text-align: center;">
                                <div style="font-size: 0.9rem; color: #ccc; margin-bottom: 8px;">Beat</div>
                                <div style="font-size: 2rem;">♪</div>
                            </div>
                        </div>
                    </div>

                    <!-- LED-Strips Control Grid -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-lightbulb"></i> LED-Bänder Steuerung</h3>
                        <div id="ledStripsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            <!-- Wird dynamisch mit LED-Strip Controls gefüllt -->
                        </div>
                    </div>
                </div>

                <!-- LED-Band Einstellungen (Band 0-9) -->
                <div id="ledBandContent-0" class="led-band-content" style="display: none;">
                    <div style="display: grid; gap: 20px;">
                        <!-- Grundeinstellungen -->
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 20px;"><i class="fas fa-cog"></i> Grundeinstellungen</h3>
                            
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                <label style="font-weight: bold;">LED-Band aktiviert</label>
                                <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 30px;">
                                    <input type="checkbox" class="band-enabled" checked style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 30px;"></span>
                                </label>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">Hauptfarbe</label>
                                <input type="color" class="band-color" value="#3A86FF" style="width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer;">
                            </div>

                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">LED-Effekt</label>
                                <select class="band-effect" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px;">
                                    <option value="solid">Einfarbig</option>
                                    <option value="pulse" selected>Pulsierend</option>
                                    <option value="strobe">Stroboskop</option>
                                    <option value="wave">Wellenmuster</option>
                                    <option value="spectrum">Spektrum</option>
                                    <option value="rainbow">Regenbogen</option>
                                    <option value="chase">Lauflicht</option>
                                    <option value="breathe">Atmend</option>
                                </select>
                            </div>
                        </div>

                        <!-- Musik-Reaktion -->
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 20px;"><i class="fas fa-music"></i> Musik-Reaktion</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">Reagiert auf</label>
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Bestimmt, welcher Musikaspekt die LEDs steuert</div>
                                <select class="band-react-to" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px;">
                                    <option value="rhythm" selected>Rhythmus</option>
                                    <option value="vocals">Gesang</option>
                                    <option value="beats">Beats</option>
                                    <option value="melody">Melodie</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">Frequenzbereich</label>
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Welche Frequenzen sollen erfasst werden</div>
                                <select class="band-freq-range" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px;">
                                    <option value="all" selected>Alle Frequenzen</option>
                                    <option value="bass">Bass (Tiefe Töne)</option>
                                    <option value="mid">Mitten (Mittlere Töne)</option>
                                    <option value="high">Höhen (Hohe Töne)</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">Empfindlichkeit</label>
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Wie stark reagieren die LEDs auf Musik</div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="range" class="band-sensitivity" min="0" max="100" value="65" 
                                           style="flex: 1; height: 8px; border-radius: 4px; background: #333; outline: none;">
                                    <span class="sensitivity-value" style="color: #4ecdc4; font-weight: bold; min-width: 50px;">65%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Visuelle Einstellungen -->
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px;">
                            <h3 style="color: #4ecdc4; margin-bottom: 20px;"><i class="fas fa-eye"></i> Visuelle Einstellungen</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">Geschwindigkeit</label>
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Geschwindigkeit der Effekt-Animation</div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="range" class="band-speed" min="0" max="100" value="50" 
                                           style="flex: 1; height: 8px; border-radius: 4px; background: #333; outline: none;">
                                    <span class="speed-value" style="color: #4ecdc4; font-weight: bold; min-width: 50px;">50%</span>
                                </div>
                            </div>

                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 10px;">Helligkeit</label>
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">Maximale Helligkeit der LEDs</div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="range" class="band-brightness" min="0" max="100" value="80" 
                                           style="flex: 1; height: 8px; border-radius: 4px; background: #333; outline: none;">
                                    <span class="brightness-value" style="color: #4ecdc4; font-weight: bold; min-width: 50px;">80%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Preset Actions -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button onclick="saveLEDBandPreset(0)" style="flex: 1; min-width: 150px; padding: 12px 25px; background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-save"></i> Preset speichern
                            </button>
                            <button onclick="loadLEDBandPreset(0)" style="flex: 1; min-width: 150px; padding: 12px 25px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-folder-open"></i> Preset laden
                            </button>
                            <button onclick="resetLEDBandToDefault(0)" style="flex: 1; min-width: 150px; padding: 12px 25px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-undo"></i> Zurücksetzen
                            </button>
                            <button onclick="copyLEDBandToOthers(0)" style="flex: 1; min-width: 150px; padding: 12px 25px; background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-copy"></i> Auf andere kopieren
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Weitere Band-Contents 1-9 werden per JS generiert -->

            </div>
        </div>

        <!-- Party Mode Panel -->
        <div class="content-panel" id="party">
            <div class="panel-header">
                <i class="fas fa-glass-cheers"></i>
                <h2 class="panel-title">Party-Modus</h2>
            </div>
            
                         <div style="padding: 20px;">
                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                     
                     <!-- Party Activation -->
                     <div style="text-align: center; padding: 20px; background: rgba(78, 205, 196, 0.1); border-radius: 15px;">
                         <h3 style="color: #4ecdc4; margin-bottom: 15px;">🎉 Party-Modus</h3>
                         <button class="preset-btn" onclick="togglePartyMode()" id="partyToggle">
                             <i class="fas fa-play"></i> Party starten
                         </button>
                     </div>

                     <!-- Professional DJ Crossfading -->
                     <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                         <h4 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-headphones-alt"></i> DJ-Überblendung (Nahtlos)</h4>
                         
                         <div style="margin-bottom: 15px;">
                             <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                 <input type="checkbox" id="seamlessTransition" checked style="transform: scale(1.2);">
                                 <span style="font-weight: bold;">🎧 Nahtlose Überblendung aktivieren</span>
                             </label>
                             <div style="font-size: 0.9em; color: #888; margin-top: 5px;">Eliminiert Pausen zwischen Liedern - wie professionelles DJing</div>
                         </div>
                         
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                             <div>
                                 <label style="display: block; margin-bottom: 8px;">Crossfade-Zeit:</label>
                                 <div style="display: flex; align-items: center; gap: 10px;">
                                     <input type="range" id="overlapTime" min="0.5" max="15" step="0.5" value="4" style="flex: 1;">
                                     <span id="overlapTimeValue" style="min-width: 35px;">4.0s</span>
                                 </div>
                             </div>
                             
                             <div>
                                 <label style="display: block; margin-bottom: 8px;">Überblend-Typ:</label>
                                 <select id="crossfadeType" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                     <option value="linear">Linear</option>
                                     <option value="exponential" selected>Exponentiell</option>
                                     <option value="logarithmic">Logarithmisch</option>
                                     <option value="scurve">S-Kurve</option>
                                 </select>
                             </div>
                         </div>
                         
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                             <div>
                                 <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                     <input type="checkbox" id="autoDetect" checked style="transform: scale(1.2);">
                                     <span>Auto-Erkennung Song-Ende</span>
                                 </label>
                             </div>
                             
                             <div>
                                 <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                     <input type="checkbox" id="beatMatching" style="transform: scale(1.2);">
                                     <span>Beat-Matching</span>
                                 </label>
                             </div>
                         </div>
                         
                         <!-- Pre-cueing Options -->
                         <div style="margin-top: 15px; padding: 15px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
                             <h5 style="color: #4ecdc4; margin-bottom: 10px;"><i class="fas fa-volume-up"></i> Pre-Cueing</h5>
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                 <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                     <input type="checkbox" id="preCue" style="transform: scale(1.1);">
                                     <span>Pre-Cue aktivieren</span>
                                 </label>
                                 
                                 <div style="display: flex; align-items: center; gap: 10px;">
                                     <span style="font-size: 0.9em;">Lautstärke:</span>
                                     <input type="range" id="preCueVolume" min="0" max="100" value="50" style="flex: 1;" disabled>
                                     <span id="preCueVolumeValue" style="font-size: 0.9em;">50%</span>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <!-- Tempo & Pitch Controls -->
                     <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                         <h4 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-tachometer-alt"></i> Tempo & Tonhöhe</h4>
                         
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                             <div>
                                 <label style="display: block; margin-bottom: 8px;">🎵 Tempo:</label>
                                 <div style="display: flex; align-items: center; gap: 10px;">
                                     <input type="range" id="tempoSlider" min="0.5" max="2" step="0.1" value="1" style="flex: 1;">
                                     <span id="tempoValue" style="min-width: 50px;">100%</span>
                                 </div>
                             </div>
                             
                             <div>
                                 <label style="display: block; margin-bottom: 8px;">🎼 Tonhöhe:</label>
                                 <div style="display: flex; align-items: center; gap: 10px;">
                                     <input type="range" id="pitchSlider" min="-12" max="12" step="1" value="0" style="flex: 1;">
                                     <span id="pitchValue" style="min-width: 50px;">0</span>
                                 </div>
                             </div>
                         </div>
                         
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                             <div>
                                 <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                     <input type="checkbox" id="preservePitch" style="transform: scale(1.2);">
                                     <span>Tonhöhe beibehalten</span>
                                 </label>
                             </div>
                             
                             <div>
                                <button onclick="resetTempoAndPitch()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">↺ Zurücksetzen</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Crossfade & Gapless Playback -->
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; margin-top: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-exchange-alt"></i> Crossfade & Gapless</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px;">
                                <input type="checkbox" id="crossfadeEnabled" style="transform: scale(1.2);">
                                <span style="font-weight: bold;">🔄 Crossfade aktivieren</span>
                            </label>
                            
                            <div id="crossfadeSettings" style="opacity: 0.5; pointer-events: none;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px;">⏱️ Crossfade-Dauer:</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" id="crossfadeDuration" min="1" max="10" step="0.5" value="3" style="flex: 1;">
                                        <span id="crossfadeDurationValue" style="min-width: 50px;">3.0s</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 8px;">📊 Crossfade-Typ:</label>
                                    <select id="crossfadeType" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                        <option value="linear">Linear</option>
                                        <option value="logarithmic" selected>Logarithmisch</option>
                                        <option value="exponential">Exponentiell</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px;">
                                <input type="checkbox" id="gaplessEnabled" checked style="transform: scale(1.2);">
                                <span style="font-weight: bold;">🎵 Gapless Playback</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888;">Nahtlose Wiedergabe ohne Pausen zwischen Tracks</div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="preloadNext" checked style="transform: scale(1.2);">
                                <span>⚡ Nächsten Track vorladen</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-top: 5px;">Lädt den nächsten Track im Hintergrund vor</div>
                        </div>
                    </div>
                    
                    <!-- Fade-In/Out Effects -->
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; margin-top: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-volume-up"></i> Fade-Effekte</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="fadeInEnabled" style="transform: scale(1.2);">
                                    <span style="font-weight: bold;">📈 Fade-In</span>
                                </label>
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Dauer:</label>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="range" id="fadeInDuration" min="0.5" max="5" step="0.1" value="1" style="flex: 1;">
                                        <span id="fadeInDurationValue" style="min-width: 40px; font-size: 0.9em;">1.0s</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="fadeOutEnabled" style="transform: scale(1.2);">
                                    <span style="font-weight: bold;">📉 Fade-Out</span>
                                </label>
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Dauer:</label>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="range" id="fadeOutDuration" min="0.5" max="5" step="0.1" value="1" style="flex: 1;">
                                        <span id="fadeOutDurationValue" style="min-width: 40px; font-size: 0.9em;">1.0s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px;">📊 Fade-Kurve:</label>
                            <select id="fadeCurve" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                <option value="linear">Linear</option>
                                <option value="logarithmic" selected>Logarithmisch</option>
                                <option value="exponential">Exponentiell</option>
                                <option value="smooth">Smooth (S-Kurve)</option>
                            </select>
                        </div>
                    </div>
                </div>


            </div>
        </div>


        <!-- Library Panel -->
        <div class="content-panel" id="library">
            <div class="panel-header">
                <i class="fas fa-music"></i>
                <h2 class="panel-title">Bibliothek</h2>
                <div class="library-header-controls">
                    <button id="librarySearchBtn" class="header-btn" title="Suchen">
                        <i class="fas fa-search"></i>
                    </button>
                    <button id="libraryViewToggle" class="header-btn" title="Ansicht wechseln">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button id="librarySortBtn" class="header-btn" title="Sortieren">
                        <i class="fas fa-sort"></i>
                    </button>
                </div>
            </div>
            
            <!-- Library Navigation -->
            <div class="library-nav">
                <button class="library-nav-btn active" data-section="artists">
                    <i class="fas fa-microphone-alt"></i>
                    <span>Interpreten</span>
                </button>
                <button class="library-nav-btn" data-section="albums">
                    <i class="fas fa-compact-disc"></i>
                    <span>Alben</span>
                </button>
                <button class="library-nav-btn" data-section="songs">
                    <i class="fas fa-music"></i>
                    <span>Titel</span>
                </button>
                <button class="library-nav-btn" data-section="folders">
                    <i class="fas fa-folder"></i>
                    <span>Ordner</span>
                </button>
                <button class="library-nav-btn" data-section="genres">
                    <i class="fas fa-guitar"></i>
                    <span>Genres</span>
                </button>
                <button class="library-nav-btn" data-section="recent">
                    <i class="fas fa-clock"></i>
                    <span>Kürzlich</span>
                </button>
                <button class="library-nav-btn" data-section="favorites">
                    <i class="fas fa-star"></i>
                    <span>Favoriten</span>
                </button>
                <button class="library-nav-btn" data-section="most-played">
                    <i class="fas fa-fire"></i>
                    <span>Meist gespielt</span>
                </button>
                <button class="library-nav-btn" data-section="playlists">
                    <i class="fas fa-list-ul"></i>
                    <span>Playlists</span>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="library-search" id="librarySearchBar" style="display: none;">
                <div class="search-input-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="librarySearchInput" placeholder="Durchsuche deine Bibliothek..." autocomplete="off">
                    <button id="searchClearBtn" class="search-clear-btn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Sort Options -->
            <div class="library-sort" id="librarySortOptions" style="display: none;">
                <div class="sort-options">
                    <button class="sort-btn active" data-sort="name">
                        <i class="fas fa-sort-alpha-down"></i>
                        <span>Name</span>
                    </button>
                    <button class="sort-btn" data-sort="artist">
                        <i class="fas fa-user"></i>
                        <span>Interpret</span>
                    </button>
                    <button class="sort-btn" data-sort="album">
                        <i class="fas fa-compact-disc"></i>
                        <span>Album</span>
                    </button>
                    <button class="sort-btn" data-sort="date">
                        <i class="fas fa-calendar"></i>
                        <span>Datum</span>
                    </button>
                    <button class="sort-btn" data-sort="duration">
                        <i class="fas fa-clock"></i>
                        <span>Dauer</span>
                    </button>
                </div>
            </div>

            <!-- Library Content -->
            <div class="library-content">
                <!-- Artists Section -->
                <div class="library-section active" id="artists-section">
                    <div class="section-header-info">
                        <h3>Interpreten</h3>
                        <span class="item-count" id="artistsCount">0 Interpreten</span>
                    </div>
                    <div class="library-grid" id="artistsGrid">
                        <div class="empty-state">
                            <i class="fas fa-microphone-alt"></i>
                            <h4>Keine Interpreten gefunden</h4>
                            <p>Füge Musik hinzu, um deine Interpreten hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- Albums Section -->
                <div class="library-section" id="albums-section">
                    <div class="section-header-info">
                        <h3>Alben</h3>
                        <span class="item-count" id="albumsCount">0 Alben</span>
                    </div>
                    <div class="library-grid" id="albumsGrid">
                        <div class="empty-state">
                            <i class="fas fa-compact-disc"></i>
                            <h4>Keine Alben gefunden</h4>
                            <p>Füge Musik hinzu, um deine Alben hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- Songs Section -->
                <div class="library-section" id="songs-section">
                    <div class="section-header-info">
                        <h3>Titel</h3>
                        <span class="item-count" id="songsCount">0 Titel</span>
                    </div>
                    <div class="library-list" id="songsGrid">
                        <div class="empty-state">
                            <i class="fas fa-music"></i>
                            <h4>Keine Titel gefunden</h4>
                            <p>Füge Musik hinzu, um deine Titel hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- Folders Section -->
                <div class="library-section" id="folders-section">
                    <div class="section-header-info">
                        <h3>Ordner</h3>
                        <span class="item-count" id="foldersCount">0 Ordner</span>
                    </div>
                    <div class="library-grid" id="foldersGrid">
                        <div class="empty-state">
                            <i class="fas fa-folder"></i>
                            <h4>Keine Ordner gefunden</h4>
                            <p>Füge Musik hinzu, um deine Ordner hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- Genres Section -->
                <div class="library-section" id="genres-section">
                    <div class="section-header-info">
                        <h3>Genres</h3>
                        <span class="item-count" id="genresCount">0 Genres</span>
                    </div>
                    <div class="library-grid" id="genresGrid">
                        <div class="empty-state">
                            <i class="fas fa-guitar"></i>
                            <h4>Keine Genres gefunden</h4>
                            <p>Füge Musik hinzu, um deine Genres hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Section -->
                <div class="library-section" id="recent-section">
                    <div class="section-header-info">
                        <h3>Kürzlich hinzugefügt</h3>
                        <span class="item-count" id="recentCount">0 Titel</span>
                    </div>
                    <div class="library-list" id="recentGrid">
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <h4>Keine kürzlich hinzugefügten Titel</h4>
                            <p>Neue Musik wird hier angezeigt</p>
                        </div>
                    </div>
                </div>

                <!-- Favorites Section -->
                <div class="library-section" id="favorites-section">
                    <div class="section-header-info">
                        <h3>Favoriten</h3>
                        <span class="item-count" id="favoritesCount">0 Favoriten</span>
                    </div>
                    <div class="library-list" id="favoritesGrid">
                        <div class="empty-state">
                            <i class="fas fa-star"></i>
                            <h4>Keine Favoriten</h4>
                            <p>Markiere Titel als Favoriten, um sie hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- Most Played Section -->
                <div class="library-section" id="most-played-section">
                    <div class="section-header-info">
                        <h3>Meist gespielt</h3>
                        <span class="item-count" id="mostPlayedCount">0 Titel</span>
                    </div>
                    <div class="library-list" id="mostPlayedGrid">
                        <div class="empty-state">
                            <i class="fas fa-fire"></i>
                            <h4>Keine meist gespielten Titel</h4>
                            <p>Spiele Musik ab, um deine meist gespielten Titel hier zu sehen</p>
                        </div>
                    </div>
                </div>

                <!-- ✅ Playlists Section -->
                <div class="library-section" id="playlists-section" style="display: none;">
                    <div class="section-header-info">
                        <h3>Playlists</h3>
                        <span class="item-count" id="playlistsCount">0 Playlists</span>
                        <button onclick="createNewPlaylist()" ontouchend="createNewPlaylist()" class="header-btn" style="background: rgba(78, 205, 196, 0.2); color: #4ecdc4; border: 1px solid #4ecdc4; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin-left: auto; min-height: 44px; font-size: 16px;">
                            <i class="fas fa-plus"></i> Neue Playlist
                        </button>
                    </div>
                    <div class="library-grid" id="playlistsGrid">
                        <div class="empty-state">
                            <i class="fas fa-list-ul"></i>
                            <h4>Keine Playlists</h4>
                            <p>Erstelle eine Playlist, um Songs zu organisieren</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Audio Element for actual playbook -->
    <audio id="audioPlayer" preload="metadata"></audio>
    
    <!-- Hidden File Input for Music Upload -->
    <input type="file" id="musicFileInput" multiple accept="audio/*">
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="play">
            <i class="fas fa-play"></i>
            <span>Abspielen</span>
        </div>
        <div class="context-menu-item" data-action="add-to-queue">
            <i class="fas fa-list"></i>
            <span>Zur Warteschlange hinzufügen</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="favorite">
            <i class="fas fa-star"></i>
            <span>Zu Favoriten hinzufügen</span>
        </div>
        <div class="context-menu-item" data-action="add-to-playlist">
            <i class="fas fa-plus"></i>
            <span>Zu Playlist hinzufügen</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="show-info">
            <i class="fas fa-info-circle"></i>
            <span>Informationen anzeigen</span>
        </div>
        <div class="context-menu-item" data-action="delete">
            <i class="fas fa-trash"></i>
            <span>Löschen</span>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="addMusicFab" title="Musik hinzufügen">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // ===== FUNKTIONSFÄHIGER MUSIK PLAYER MIT AUDIO API =====
        
        // Audio Element
        const audioPlayer = document.getElementById('audioPlayer');
        
        // ===== PLAYER STATE MIT PERSISTENZ =====
        const PLAYER_STATE_KEY = 'music-player-state';
        
        // Player State laden oder initialisieren
        function loadPlayerState() {
            const saved = localStorage.getItem(PLAYER_STATE_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn('Fehler beim Laden des Player-States:', e);
                    return null;
                }
            }
            return null;
        }
        
        // Player State speichern
        function savePlayerState() {
            const state = {
                currentTrackIndex: currentTrackIndex,
                currentTrack: currentTrack,
                currentTime: audioPlayer.currentTime,
                volume: audioPlayer.volume,
                isShuffleMode: isShuffleMode,
                isRepeatMode: isRepeatMode,
                playlist: playlist,
                lastSaved: Date.now()
            };
            localStorage.setItem(PLAYER_STATE_KEY, JSON.stringify(state));
        }
        
        // Player State beim Laden wiederherstellen
        const savedState = loadPlayerState();
        let isPlaying = false;
        let isShuffleMode = savedState?.isShuffleMode || false;
        let isRepeatMode = savedState?.isRepeatMode || 0; // 0: off, 1: repeat all, 2: repeat one, 3: playlist
        let playlist = savedState?.playlist || [];
        let currentTrackIndex = savedState?.currentTrackIndex || 0;
        let currentTrack = savedState?.currentTrack || null;
        
        // Web Audio API für Visualizer
        let audioContext;
        let analyser;
        let source;
        let bufferLength;
        let dataArray;
        
        // LED-Musiksteuerung Integration
        let ledMusicControlConnected = false;
        let beatDetector = null;
        
        // ===== MEDIA SESSION API (LOCKSCREEN/BACKGROUND) =====
        function updateMediaSession() {
            if ('mediaSession' in navigator && currentTrack) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: currentTrack.name || 'Unbekannter Titel',
                    artist: currentTrack.artist || 'Unbekannter Künstler',
                    album: currentTrack.album || 'Unbekanntes Album',
                    artwork: currentTrack.cover ? [
                        { src: currentTrack.cover, sizes: '512x512', type: 'image/jpeg' }
                    ] : []
                });
                
                // ✅ Lockscreen Controls
                navigator.mediaSession.setActionHandler('play', () => {
                    audioPlayer.play();
                    isPlaying = true;
                    savePlayerState();
                });
                
                navigator.mediaSession.setActionHandler('pause', () => {
                    audioPlayer.pause();
                    isPlaying = false;
                    savePlayerState();
                });
                
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    playPrevious();
                });
                
                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    playNext();
                });
                
                // ✅ Optional: Seek (falls Browser unterstützt)
                try {
                    navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                        audioPlayer.currentTime = Math.max(audioPlayer.currentTime - (details.seekOffset || 10), 0);
                    });
                    
                    navigator.mediaSession.setActionHandler('seekforward', (details) => {
                        audioPlayer.currentTime = Math.min(audioPlayer.currentTime + (details.seekOffset || 10), audioPlayer.duration);
                    });
                    
                    navigator.mediaSession.setActionHandler('seekto', (details) => {
                        if (details.fastSeek && 'fastSeek' in audioPlayer) {
                            audioPlayer.fastSeek(details.seekTime);
                        } else {
                            audioPlayer.currentTime = details.seekTime;
                        }
                    });
                } catch (e) {
                    console.log('Seek Actions nicht unterstützt');
                }
                
                console.log('📱 Media Session aktualisiert:', currentTrack.name);
            }
        }
        
        // ✅ Aktualisiere Playback State
        function updatePlaybackState(state) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = state; // 'playing', 'paused', 'none'
            }
        }
        
        // ===== MUSIC LIBRARY MANAGEMENT SYSTEM =====
        
        // Global Music Library Object
        let musicLibrary = {
            songs: [],
            artists: new Map(),
            albums: new Map(),
            genres: new Map(),
            folders: new Map(),
            playlists: [],
            favorites: [],
            recentlyPlayed: [],
            mostPlayed: []
        };
        
        // Library state
        let currentLibrarySection = 'artists';
        let currentSortMethod = 'name';
        let isGridView = true;
        let searchQuery = '';
        
        // Library Manager Class
        class LibraryManager {
            constructor() {
                this.currentSection = 'artists';
                this.searchTerm = '';
                this.sortMethod = 'name';
                this.sortDirection = 'asc';
                this.isSearchVisible = false;
                this.isGridView = true; // ✅ Grid View als Standard
            }
            
            initializeLibrary() {
                try {
                    const savedLibrary = localStorage.getItem('musicLibrary');
                    if (savedLibrary) {
                        const parsed = JSON.parse(savedLibrary);
                        musicLibrary = {
                            ...musicLibrary,
                            ...parsed,
                            artists: new Map(Object.entries(parsed.artists || {})),
                            albums: new Map(Object.entries(parsed.albums || {})),
                            genres: new Map(Object.entries(parsed.genres || {})),
                            folders: new Map(Object.entries(parsed.folders || {}))
                        };
                    }
                    this.updateAllSections();
                } catch (error) {
                    console.error('Fehler beim Laden der Bibliothek:', error);
                }
            }
            
            setupEventListeners() {
                // Library navigation
                document.querySelectorAll('.library-nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const section = e.currentTarget.dataset.section;
                        this.switchSection(section);
                    });
                });
                
                // Header controls
                document.getElementById('librarySearchBtn')?.addEventListener('click', () => {
                    this.toggleSearch();
                });
                
                document.getElementById('libraryViewToggle')?.addEventListener('click', () => {
                    this.toggleView();
                });
                
                document.getElementById('librarySortBtn')?.addEventListener('click', () => {
                    this.toggleSortOptions();
                });
                
                document.getElementById('libraryAddBtn')?.addEventListener('click', () => {
                    this.openFileDialog();
                });
                
                // Search functionality
                const searchInput = document.getElementById('librarySearchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.handleSearch(e.target.value);
                    });
                }
                
                // Search clear button
                document.getElementById('searchClearBtn')?.addEventListener('click', () => {
                    this.clearSearch();
                });
                
                // Sort options
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sortMethod = e.currentTarget.dataset.sort;
                        this.setSortMethod(sortMethod);
                    });
                });
                
                // File input
                const fileInput = document.getElementById('musicFileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        this.handleFileSelection(e.target.files);
                    });
                }
                
                // FAB
                document.getElementById('addMusicFab')?.addEventListener('click', () => {
                    this.openFileDialog();
                });
                
                // Context menu
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu')) {
                        this.hideContextMenu();
                    }
                });
            }
            
            switchSection(section) {
                currentLibrarySection = section;
                
                // Update navigation buttons
                document.querySelectorAll('.library-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Switch content based on section
                switch(section) {
                    case 'all':
                        this.displayAllSongs();
                        break;
                    case 'albums':
                        this.displayAlbums();
                        break;
                    case 'artists':
                        this.displayArtists();
                        break;
                    case 'genres':
                        this.displayGenres();
                        break;
                    case 'recent':
                        this.displayRecentlyAdded();
                        break;
                    case 'favorites':
                        this.displayFavorites();
                        break;
                    case 'most-played':
                        this.displayMostPlayed();
                        break;
                }
            }
            
            async handleFileSelection(files) {
                if (!files || files.length === 0) return;
                
                const validFiles = Array.from(files).filter(file => 
                    file.type.startsWith('audio/')
                );
                
                if (validFiles.length === 0) {
                    this.showNotification('Keine gültigen Audiodateien ausgewählt', 'warning');
                    return;
                }
                
                await this.addMusicFiles(validFiles);
            }
            
            async addMusicFiles(files) {
                this.showNotification(`Verarbeite ${files.length} Dateien...`, 'info');
                
                for (const file of files) {
                    try {
                        const track = await this.processAudioFile(file);
                        this.addTrackToLibrary(track);
                    } catch (error) {
                        console.error('Fehler beim Verarbeiten der Datei:', file.name, error);
                    }
                }
                
                this.saveLibrary();
                this.updateAllSections();
                this.showNotification(`${files.length} Titel hinzugefügt`, 'success');
            }
            
            async processAudioFile(file) {
                const metadata = await this.extractMetadata(file);
                
                return {
                    id: this.generateId(),
                    name: metadata.title || file.name.replace(/\.[^/.]+$/, ''),
                    artist: metadata.artist || 'Unbekannter Künstler',
                    album: metadata.album || 'Unbekanntes Album',
                    genre: metadata.genre || 'Unbekanntes Genre',
                    year: metadata.year || null,
                    track: metadata.track || null,
                    duration: metadata.duration || 0,
                    albumArt: metadata.albumArt || null,
                    fileName: file.name,
                    fileSize: file.size,
                    file: file,
                    url: URL.createObjectURL(file),
                    dateAdded: new Date().toISOString(),
                    playCount: 0,
                    lastPlayed: null,
                    isFavorite: false
                };
            }
            
            addTrackToLibrary(track) {
                // Add to songs
                musicLibrary.songs.push(track);
                
                // Add to artists
                if (!musicLibrary.artists.has(track.artist)) {
                    musicLibrary.artists.set(track.artist, {
                        name: track.artist,
                        songs: [],
                        albumCount: 0
                    });
                }
                musicLibrary.artists.get(track.artist).songs.push(track.id);
                
                // Add to albums
                const albumKey = `${track.artist} - ${track.album}`;
                if (!musicLibrary.albums.has(albumKey)) {
                    musicLibrary.albums.set(albumKey, {
                        title: track.album,
                        artist: track.artist,
                        year: track.year,
                        songs: [],
                        albumArt: track.albumArt
                    });
                    
                    // Update artist album count
                    const artist = musicLibrary.artists.get(track.artist);
                    if (artist) artist.albumCount++;
                }
                musicLibrary.albums.get(albumKey).songs.push(track.id);
                
                // Add to genres
                if (!musicLibrary.genres.has(track.genre)) {
                    musicLibrary.genres.set(track.genre, {
                        name: track.genre,
                        songs: []
                    });
                }
                musicLibrary.genres.get(track.genre).songs.push(track.id);
                
                // Add to folders (based on file path if available)
                const folderPath = this.extractFolderPath(track.fileName);
                if (folderPath) {
                    if (!musicLibrary.folders.has(folderPath)) {
                        musicLibrary.folders.set(folderPath, {
                            path: folderPath,
                            name: folderPath.split('/').pop() || folderPath,
                            songs: []
                        });
                    }
                    musicLibrary.folders.get(folderPath).songs.push(track.id);
                }
            }
            
            extractFolderPath(fileName) {
                const lastSlash = fileName.lastIndexOf('/');
                const lastBackslash = fileName.lastIndexOf('\\');
                const lastSeparator = Math.max(lastSlash, lastBackslash);
                
                if (lastSeparator > 0) {
                    return fileName.substring(0, lastSeparator);
                }
                return null;
            }
            
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            displayArtists() {
                const container = document.getElementById('artistsGrid');
                const countElement = document.getElementById('artistsCount');
                
                if (!container) return;
                
                const artists = Array.from(musicLibrary.artists.entries());
                countElement.textContent = `${artists.length} Interpreten`;
                
                if (artists.length === 0) {
                    this.showEmptyState(container, 'microphone-alt', 'Keine Interpreten', 'Füge Musik hinzu');
                    return;
                }
                
                container.innerHTML = '';
                
                artists.forEach(([artistName, artistData]) => {
                    const card = this.createArtistCard(artistName, artistData);
                    container.appendChild(card);
                });
            }
            
            createArtistCard(name, data) {
                const card = document.createElement('div');
                card.className = 'artist-card';
                card.onclick = () => this.showArtistDetails(name, data);
                card.oncontextmenu = (e) => this.showContextMenu(e, 'artist', { name, data });
                
                const avatar = document.createElement('div');
                avatar.className = 'artist-avatar';
                avatar.innerHTML = '<i class="fas fa-microphone-alt"></i>';
                
                const nameEl = document.createElement('div');
                nameEl.className = 'artist-name';
                nameEl.textContent = name;
                
                const info = document.createElement('div');
                info.className = 'artist-info';
                info.textContent = `${data.songs.length} Titel • ${data.albumCount} Alben`;
                
                card.appendChild(avatar);
                card.appendChild(nameEl);
                card.appendChild(info);
                
                return card;
            }
            
            displayAlbums() {
                const container = document.getElementById('albumsGrid');
                const countElement = document.getElementById('albumsCount');
                
                if (!container) return;
                
                const albums = Array.from(musicLibrary.albums.entries());
                countElement.textContent = `${albums.length} Alben`;
                
                if (albums.length === 0) {
                    this.showEmptyState(container, 'compact-disc', 'Keine Alben', 'Füge Musik hinzu');
                    return;
                }
                
                container.innerHTML = '';
                
                albums.forEach(([albumKey, albumData]) => {
                    const card = this.createAlbumCard(albumKey, albumData);
                    container.appendChild(card);
                });
            }
            
            createAlbumCard(key, data) {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.onclick = () => this.showAlbumDetails(key, data);
                card.oncontextmenu = (e) => this.showContextMenu(e, 'album', { key, data });
                
                const cover = document.createElement('div');
                cover.className = 'album-cover';
                if (data.albumArt) {
                    cover.style.backgroundImage = `url(${data.albumArt})`;
                    cover.style.backgroundSize = 'cover';
                } else {
                    cover.innerHTML = '<i class="fas fa-compact-disc"></i>';
                }
                
                const title = document.createElement('div');
                title.className = 'album-title';
                title.textContent = data.title;
                
                const artist = document.createElement('div');
                artist.className = 'album-artist';
                artist.textContent = data.artist;
                
                card.appendChild(cover);
                card.appendChild(title);
                card.appendChild(artist);
                
                return card;
            }
            
            displaySongs() {
                const container = document.getElementById('songsGrid');
                const countElement = document.getElementById('songsCount');
                
                if (!container) return;
                
                let songs = [...musicLibrary.songs];
                
                // Apply search filter
                if (searchQuery) {
                    songs = songs.filter(song => 
                        song.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        song.artist.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        song.album.toLowerCase().includes(searchQuery.toLowerCase())
                    );
                }
                
                // Apply sorting
                songs = this.sortSongs(songs, currentSortMethod);
                
                countElement.textContent = `${songs.length} Titel`;
                
                if (songs.length === 0) {
                    this.showEmptyState(container, 'music', 'Keine Titel', searchQuery ? 'Keine Suchergebnisse' : 'Füge Musik hinzu');
                    return;
                }
                
                container.innerHTML = '';
                
                songs.forEach((song, index) => {
                    const item = this.createSongItem(song, index);
                    container.appendChild(item);
                });
            }
            
            createSongItem(song, index) {
                const item = document.createElement('div');
                item.className = 'song-item';
                item.dataset.songId = song.id;
                item.onclick = () => this.playSong(song);
                item.oncontextmenu = (e) => this.showContextMenu(e, 'song', song);
                
                const cover = document.createElement('div');
                cover.className = 'song-cover';
                if (song.albumArt) {
                    cover.style.backgroundImage = `url(${song.albumArt})`;
                    cover.style.backgroundSize = 'cover';
                } else {
                    cover.innerHTML = '<i class="fas fa-music"></i>';
                }
                
                const info = document.createElement('div');
                info.className = 'song-info';
                
                const title = document.createElement('div');
                title.className = 'song-title';
                title.textContent = song.name;
                
                const meta = document.createElement('div');
                meta.className = 'song-meta';
                meta.textContent = `${song.artist} • ${song.album}`;
                
                info.appendChild(title);
                info.appendChild(meta);
                
                const duration = document.createElement('div');
                duration.className = 'song-duration';
                duration.textContent = this.formatDuration(song.duration);
                
                item.appendChild(cover);
                item.appendChild(info);
                item.appendChild(duration);
                
                return item;
            }
            
            showEmptyState(container, icon, title, subtitle) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-${icon}"></i>
                        <h4>${title}</h4>
                        <p>${subtitle}</p>
                    </div>
                `;
            }
            
            formatDuration(seconds) {
                if (!seconds || isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            updateAllSections() {
                this.displayArtists();
                this.displayAlbums();
                this.displaySongs();
                this.displayFolders();
                this.displayGenres();
                this.displayRecentlyAdded();
                this.displayFavorites();
                this.displayMostPlayed();
            }
            
            saveLibrary() {
                try {
                    const libraryToSave = {
                        ...musicLibrary,
                        artists: Object.fromEntries(musicLibrary.artists),
                        albums: Object.fromEntries(musicLibrary.albums),
                        genres: Object.fromEntries(musicLibrary.genres),
                        folders: Object.fromEntries(musicLibrary.folders)
                    };
                    localStorage.setItem('musicLibrary', JSON.stringify(libraryToSave));
                } catch (error) {
                    console.error('Fehler beim Speichern der Bibliothek:', error);
                }
            }
            
            showNotification(message, type = 'info') {
                // Vollständige Notification-Implementierung
                try {
                    // Entferne vorherige Notifications
                    const existingNotification = document.querySelector('.notification');
                    if (existingNotification) {
                        existingNotification.remove();
                    }

                    // Erstelle neue Notification
                    const notification = document.createElement('div');
                    notification.className = `notification ${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
                    notification.style.cssText = `
                        position: fixed; top: 20px; right: 20px; z-index: 10000;
                        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8'};
                        color: white; padding: 12px 20px; border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 14px;
                        transform: translateX(400px); transition: transform 0.3s ease;
                        max-width: 350px; word-wrap: break-word;
                    `;
                    
                    // Icon hinzufügen
                    const icon = document.createElement('i');
                    icon.className = `fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}`;
                    icon.style.marginRight = '8px';
                    
                    const textSpan = document.createElement('span');
                    textSpan.textContent = message;
                    
                    notification.appendChild(icon);
                    notification.appendChild(textSpan);
                    document.body.appendChild(notification);
                    
                    // Animation einblenden
                    setTimeout(() => {
                        notification.style.transform = 'translateX(0)';
                    }, 100);
                    
                    // Automatisch ausblenden nach 4 Sekunden
                    setTimeout(() => {
                        notification.style.transform = 'translateX(400px)';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }, 4000);
                    
                    // Klick zum Schließen
                    notification.addEventListener('click', () => {
                        notification.style.transform = 'translateX(400px)';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    });
                    
                } catch (error) {
                    console.error('Fehler beim Anzeigen der Notification:', error);
                    // Fallback zu console.log
                    console.log(`${type.toUpperCase()}: ${message}`);
                }
            }
            
            // Additional methods for complete functionality
            displayFolders() {
                const container = document.getElementById('foldersGrid');
                const countElement = document.getElementById('foldersCount');
                
                if (!container) return;
                
                const folders = Array.from(musicLibrary.folders.entries());
                countElement.textContent = `${folders.length} Ordner`;
                
                if (folders.length === 0) {
                    this.showEmptyState(container, 'folder', 'Keine Ordner', 'Füge Musik hinzu');
                    return;
                }
                
                container.innerHTML = '';
                
                folders.forEach(([folderPath, folderData]) => {
                    const card = this.createFolderCard(folderPath, folderData);
                    container.appendChild(card);
                });
            }
            
            createFolderCard(path, data) {
                const card = document.createElement('div');
                card.className = 'folder-card';
                card.onclick = () => this.playFolder(path);
                card.oncontextmenu = (e) => this.showContextMenu(e, 'folder', { path, data });
                
                const icon = document.createElement('div');
                icon.className = 'folder-icon';
                icon.innerHTML = '<i class="fas fa-folder"></i>';
                
                const name = document.createElement('div');
                name.className = 'folder-name';
                name.textContent = data.name;
                
                const count = document.createElement('div');
                count.className = 'folder-count';
                count.textContent = `${data.songs.length} Titel`;
                
                card.appendChild(icon);
                card.appendChild(name);
                card.appendChild(count);
                
                return card;
            }
            
            displayGenres() {
                const container = document.getElementById('genresGrid');
                const countElement = document.getElementById('genresCount');
                
                if (!container) return;
                
                const genres = Array.from(musicLibrary.genres.entries());
                countElement.textContent = `${genres.length} Genres`;
                
                if (genres.length === 0) {
                    this.showEmptyState(container, 'guitar', 'Keine Genres', 'Füge Musik hinzu');
                    return;
                }
                
                container.innerHTML = '';
                
                genres.forEach(([genreName, genreData]) => {
                    const card = this.createGenreCard(genreName, genreData);
                    container.appendChild(card);
                });
            }
            
            createGenreCard(name, data) {
                const card = document.createElement('div');
                card.className = 'genre-card';
                card.onclick = () => this.showGenreDetails(name, data);
                card.oncontextmenu = (e) => this.showContextMenu(e, 'genre', { name, data });
                
                const icon = document.createElement('div');
                icon.className = 'genre-icon';
                icon.innerHTML = '<i class="fas fa-guitar"></i>';
                
                const nameEl = document.createElement('div');
                nameEl.className = 'genre-name';
                nameEl.textContent = name;
                
                const count = document.createElement('div');
                count.className = 'genre-count';
                count.textContent = `${data.songs.length} Titel`;
                
                card.appendChild(icon);
                card.appendChild(nameEl);
                card.appendChild(count);
                
                return card;
            }
            
            displayRecentlyAdded() {
                const container = document.getElementById('recentGrid');
                const countElement = document.getElementById('recentCount');
                
                if (!container) return;
                
                const recentSongs = [...musicLibrary.songs]
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
                    .slice(0, 50);
                
                countElement.textContent = `${recentSongs.length} Titel`;
                
                if (recentSongs.length === 0) {
                    this.showEmptyState(container, 'clock', 'Keine kürzlich hinzugefügten Titel', 'Füge Musik hinzu');
                    return;
                }
                
                container.innerHTML = '';
                
                recentSongs.forEach((song, index) => {
                    const item = this.createSongItem(song, index);
                    container.appendChild(item);
                });
            }
            
            displayFavorites() {
                const container = document.getElementById('favoritesGrid');
                const countElement = document.getElementById('favoritesCount');
                
                if (!container) return;
                
                const favoriteSongs = musicLibrary.songs.filter(song => song.isFavorite);
                countElement.textContent = `${favoriteSongs.length} Favoriten`;
                
                if (favoriteSongs.length === 0) {
                    this.showEmptyState(container, 'star', 'Keine Favoriten', 'Markiere Titel als Favoriten');
                    return;
                }
                
                container.innerHTML = '';
                
                favoriteSongs.forEach((song, index) => {
                    const item = this.createSongItem(song, index);
                    container.appendChild(item);
                });
            }
            
            displayMostPlayed() {
                const container = document.getElementById('mostPlayedGrid');
                const countElement = document.getElementById('mostPlayedCount');
                
                if (!container) return;
                
                const mostPlayedSongs = [...musicLibrary.songs]
                    .filter(song => song.playCount > 0)
                    .sort((a, b) => b.playCount - a.playCount)
                    .slice(0, 50);
                
                countElement.textContent = `${mostPlayedSongs.length} Titel`;
                
                if (mostPlayedSongs.length === 0) {
                    this.showEmptyState(container, 'fire', 'Keine meist gespielten Titel', 'Spiele Musik ab');
                    return;
                }
                
                container.innerHTML = '';
                
                mostPlayedSongs.forEach((song, index) => {
                    const item = this.createSongItem(song, index);
                    container.appendChild(item);
                });
            }
            
            // UI Control Methods
            toggleSearch() {
                const searchBar = document.getElementById('librarySearchBar');
                const searchBtn = document.getElementById('librarySearchBtn');
                
                if (searchBar.style.display === 'none' || !searchBar.style.display) {
                    searchBar.style.display = 'block';
                    searchBtn.classList.add('active');
                    document.getElementById('librarySearchInput').focus();
                } else {
                    searchBar.style.display = 'none';
                    searchBtn.classList.remove('active');
                    this.clearSearch();
                }
            }
            
            toggleView() {
                const viewBtn = document.getElementById('libraryViewToggle');
                const icon = viewBtn.querySelector('i');
                
                this.isGridView = !this.isGridView;
                
                if (this.isGridView) {
                    icon.className = 'fas fa-th-large';
                    viewBtn.title = 'Zur Listenansicht wechseln';
                    // Grid-Ansicht CSS anwenden
                    document.querySelectorAll('.library-grid').forEach(grid => {
                        grid.style.display = 'grid';
                        grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                    });
                } else {
                    icon.className = 'fas fa-list';
                    viewBtn.title = 'Zur Rasteransicht wechseln';
                    // Listen-Ansicht CSS anwenden
                    document.querySelectorAll('.library-grid').forEach(grid => {
                        grid.style.display = 'flex';
                        grid.style.flexDirection = 'column';
                        grid.style.gridTemplateColumns = 'none';
                    });
                }
                
                // Aktuellen Bereich neu laden
                this.updateSectionContent(this.currentSection);
                console.log(`🔄 Ansicht gewechselt zu: ${this.isGridView ? 'Grid' : 'Liste'}`);
            }
            
            toggleSortOptions() {
                const sortOptions = document.getElementById('librarySortOptions');
                const sortBtn = document.getElementById('librarySortBtn');
                
                if (sortOptions.style.display === 'none' || !sortOptions.style.display) {
                    sortOptions.style.display = 'block';
                    sortBtn.classList.add('active');
                } else {
                    sortOptions.style.display = 'none';
                    sortBtn.classList.remove('active');
                }
            }
            
            handleSearch(query) {
                searchQuery = query;
                const clearBtn = document.getElementById('searchClearBtn');
                
                if (query.length > 0) {
                    clearBtn.style.display = 'block';
                } else {
                    clearBtn.style.display = 'none';
                }
                
                this.updateSectionContent(currentLibrarySection);
            }
            
            clearSearch() {
                const searchInput = document.getElementById('librarySearchInput');
                const clearBtn = document.getElementById('searchClearBtn');
                
                searchInput.value = '';
                searchQuery = '';
                clearBtn.style.display = 'none';
                
                this.updateSectionContent(currentLibrarySection);
            }
            
            setSortMethod(method) {
                currentSortMethod = method;
                
                // Update sort button states
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-sort="${method}"]`).classList.add('active');
                
                this.updateSectionContent(currentLibrarySection);
            }
            
            sortSongs(songs, method) {
                switch (method) {
                    case 'name':
                        return songs.sort((a, b) => a.name.localeCompare(b.name));
                    case 'artist':
                        return songs.sort((a, b) => {
                            if (a.artist !== b.artist) return a.artist.localeCompare(b.artist);
                            if (a.album !== b.album) return a.album.localeCompare(b.album);
                            return (a.track || 0) - (b.track || 0);
                        });
                    case 'album':
                        return songs.sort((a, b) => {
                            if (a.album !== b.album) return a.album.localeCompare(b.album);
                            return (a.track || 0) - (b.track || 0);
                        });
                    case 'date':
                        return songs.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                    case 'duration':
                        return songs.sort((a, b) => (b.duration || 0) - (a.duration || 0));
                    default:
                        return songs;
                }
            }
            
            openFileDialog() {
                document.getElementById('musicFileInput').click();
            }
            
            // Playback Methods
            playSong(song) {
                // Update playlist with current song
                playlist = [song];
                currentTrackIndex = 0;
                loadTrack(0);
                playPause();
                
                // Update play count
                song.playCount = (song.playCount || 0) + 1;
                song.lastPlayed = new Date().toISOString();
                this.saveLibrary();
            }
            
            playArtist(artistName) {
                const artistData = musicLibrary.artists.get(artistName);
                if (!artistData) return;
                
                const artistSongs = musicLibrary.songs.filter(song => 
                    artistData.songs.includes(song.id)
                );
                
                if (artistSongs.length > 0) {
                    playlist = artistSongs;
                    currentTrackIndex = 0;
                    loadTrack(0);
                    playPause();
                }
            }
            
            playAlbum(albumKey) {
                const albumData = musicLibrary.albums.get(albumKey);
                if (!albumData) return;
                
                const albumSongs = musicLibrary.songs.filter(song => 
                    albumData.songs.includes(song.id)
                ).sort((a, b) => (a.track || 0) - (b.track || 0));
                
                if (albumSongs.length > 0) {
                    playlist = albumSongs;
                    currentTrackIndex = 0;
                    loadTrack(0);
                    playPause();
                }
            }
            
            // ✅ NEUE DETAIL-ANSICHTEN
            showArtistDetails(artistName, artistData) {
                console.log(`🎤 Zeige Details für Interpret: ${artistName}`);
                
                // Wechsle zur Songs-Ansicht und filtere nach Interpret
                this.currentSection = 'songs';
                this.updateSectionTabs();
                
                // Filtere Songs nach diesem Interpreten
                const artistSongs = musicLibrary.songs.filter(song => 
                    artistData.songs.includes(song.id)
                );
                
                // Zeige gefilterte Songs
                this.displayFilteredSongs(artistSongs, `Interpret: ${artistName}`);
                
                // Scroll zur Songs-Sektion
                document.getElementById('songsGrid').scrollIntoView({ behavior: 'smooth' });
            }
            
            showAlbumDetails(albumKey, albumData) {
                console.log(`💿 Zeige Details für Album: ${albumData.name}`);
                
                // Wechsle zur Songs-Ansicht und filtere nach Album
                this.currentSection = 'songs';
                this.updateSectionTabs();
                
                // Filtere Songs nach diesem Album
                const albumSongs = musicLibrary.songs.filter(song => 
                    albumData.songs.includes(song.id)
                ).sort((a, b) => (a.track || 0) - (b.track || 0));
                
                // Zeige gefilterte Songs
                this.displayFilteredSongs(albumSongs, `Album: ${albumData.name}`);
                
                // Scroll zur Songs-Sektion
                document.getElementById('songsGrid').scrollIntoView({ behavior: 'smooth' });
            }
            
            displayFilteredSongs(songs, filterTitle) {
                const container = document.getElementById('songsGrid');
                const countElement = document.getElementById('songsCount');
                
                if (!container) return;
                
                // Update Titel und Anzahl
                countElement.textContent = `${songs.length} Titel - ${filterTitle}`;
                
                if (songs.length === 0) {
                    this.showEmptyState(container, 'music', 'Keine Songs gefunden', 'Für diesen Filter');
                    return;
                }
                
                container.innerHTML = '';
                
                songs.forEach((song, index) => {
                    const card = this.createSongCard(song, index);
                    container.appendChild(card);
                });
                
                console.log(`🎵 ${songs.length} Songs für "${filterTitle}" angezeigt`);
            }
            
            showGenreDetails(genreName, genreData) {
                console.log(`🎸 Zeige Details für Genre: ${genreName}`);
                
                // Wechsle zur Songs-Ansicht und filtere nach Genre
                this.currentSection = 'songs';
                this.updateSectionTabs();
                
                // Filtere Songs nach diesem Genre
                const genreSongs = musicLibrary.songs.filter(song => 
                    genreData.songs.includes(song.id)
                );
                
                // Zeige gefilterte Songs
                this.displayFilteredSongs(genreSongs, `Genre: ${genreName}`);
                
                // Scroll zur Songs-Sektion
                document.getElementById('songsGrid').scrollIntoView({ behavior: 'smooth' });
            }
            
            playGenre(genreName) {
                const genreData = musicLibrary.genres.get(genreName);
                if (!genreData) return;
                
                const genreSongs = musicLibrary.songs.filter(song => 
                    genreData.songs.includes(song.id)
                );
                
                if (genreSongs.length > 0) {
                    playlist = genreSongs;
                    currentTrackIndex = 0;
                    loadTrack(0);
                    playPause();
                }
            }
            
            playFolder(folderPath) {
                const folderData = musicLibrary.folders.get(folderPath);
                if (!folderData) return;
                
                const folderSongs = musicLibrary.songs.filter(song => 
                    folderData.songs.includes(song.id)
                );
                
                if (folderSongs.length > 0) {
                    playlist = folderSongs;
                    currentTrackIndex = 0;
                    loadTrack(0);
                    playPause();
                }
            }
            
            // Context Menu
            showContextMenu(event, type, data) {
                event.preventDefault();
                const contextMenu = document.getElementById('contextMenu');
                
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${event.pageX}px`;
                contextMenu.style.top = `${event.pageY}px`;
                
                // Store context data
                contextMenu.dataset.type = type;
                contextMenu.dataset.data = JSON.stringify(data);
            }
            
            hideContextMenu() {
                document.getElementById('contextMenu').style.display = 'none';
            }
            
            // Metadata extraction (simplified version)
            async extractMetadata(file) {
                return new Promise((resolve) => {
                    const audio = new Audio();
                    const url = URL.createObjectURL(file);
                    
                    audio.addEventListener('loadedmetadata', () => {
                        const parsedData = this.parseFileNameForMetadata(file.name);
                        
                        resolve({
                            title: parsedData.title,
                            artist: parsedData.artist,
                            album: parsedData.album,
                            genre: parsedData.genre,
                            year: parsedData.year,
                            track: parsedData.track,
                            duration: audio.duration || 0
                        });
                        
                        URL.revokeObjectURL(url);
                    });
                    
                    audio.addEventListener('error', () => {
                        resolve({
                            title: file.name.replace(/\.[^/.]+$/, ''),
                            artist: 'Unbekannter Künstler',
                            album: 'Unbekanntes Album',
                            genre: 'Unbekanntes Genre',
                            duration: 0
                        });
                        URL.revokeObjectURL(url);
                    });
                    
                    audio.src = url;
                });
            }
            
            parseFileNameForMetadata(fileName) {
                const name = fileName.replace(/\.[^/.]+$/, '');
                let title = name;
                let artist = 'Unbekannter Künstler';
                let album = 'Unbekanntes Album';
                let genre = 'Unbekanntes Genre';
                let year = null;
                let track = null;
                
                // Format: "Artist - Title"
                if (name.includes(' - ')) {
                    const parts = name.split(' - ');
                    if (parts.length >= 2) {
                        artist = parts[0].trim();
                        title = parts[1].trim();
                    }
                }
                
                // Extract track number
                const trackMatch = name.match(/^(\d{1,2})[\s\.-]+(.+)/);
                if (trackMatch) {
                    track = parseInt(trackMatch[1]);
                    const remaining = trackMatch[2];
                    if (remaining.includes(' - ')) {
                        const parts = remaining.split(' - ');
                        artist = parts[0].trim();
                        title = parts[1].trim();
                    } else {
                        title = remaining.trim();
                    }
                }
                
                // Extract year
                const yearMatch = name.match(/\b(19|20)\d{2}\b/);
                if (yearMatch) {
                    year = parseInt(yearMatch[0]);
                }
                
                return { title, artist, album, genre, year, track };
            }
        }
        
        // Initialize Music Library Manager
        let libraryManager;
        
        // Initialize library manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            libraryManager = new LibraryManager();
            libraryManager.initializeLibrary();
            libraryManager.setupEventListeners();
            console.log('✅ LibraryManager initialisiert');
            
            // Context Menu Event Listeners
            const contextMenu = document.getElementById('songContextMenu');
            if (contextMenu) {
                contextMenu.addEventListener('click', function(e) {
                    const item = e.target.closest('.context-menu-item');
                    if (!item) return;
                    
                    const action = item.getAttribute('data-action');
                    handleContextMenuAction(action);
                    hideContextMenu();
                });
            }
            
            // Schließe Kontextmenü bei Klick außerhalb
            document.addEventListener('click', (e) => {
                if (contextMenu && !e.target.closest('.context-menu') && !e.target.closest('.song-item')) {
                    contextMenu.style.display = 'none';
                }
            });
            
            // ✅ VOLUME SLIDER ENTFERNT - Audio Volume wird auf Standard (70%) gesetzt
            if (audioPlayer) {
                audioPlayer.volume = 0.7; // Standard-Lautstärke 70%
                console.log('🔊 Audio Volume auf Standard gesetzt: 70%');
            }
            
            // Progress Bar Event Listeners
            const progressBarContainer = document.getElementById('progressBarContainer');
            if (progressBarContainer) {
                let isDragging = false;
                
                // Mouse Events
                progressBarContainer.addEventListener('click', function(e) {
                    if (!audioPlayer || !audioPlayer.duration) {
                        console.log('⚠️ Progress Bar Click: Kein Audio oder Duration');
                        return;
                    }
                    
                    const rect = this.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percentage = Math.max(0, Math.min(1, clickX / rect.width));
                    const newTime = percentage * audioPlayer.duration;
                    
                    console.log(`⏭️ Progress Bar Click: ${percentage * 100}% -> ${newTime}s`);
                    audioPlayer.currentTime = newTime;
                    
                    // Update Progress Bar visuell
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.style.width = (percentage * 100) + '%';
                    }
                });
                
                // Touch Events für Mobile
                progressBarContainer.addEventListener('touchstart', function(e) {
                    isDragging = true;
                    e.preventDefault();
                });
                
                progressBarContainer.addEventListener('touchmove', function(e) {
                    if (!isDragging || !audioPlayer || !audioPlayer.duration) return;
                    
                    const touch = e.touches[0];
                    const rect = this.getBoundingClientRect();
                    const touchX = touch.clientX - rect.left;
                    const percentage = Math.max(0, Math.min(1, touchX / rect.width));
                    const newTime = percentage * audioPlayer.duration;
                    
                    // Visuelles Feedback während des Ziehens
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.style.width = (percentage * 100) + '%';
                    }
                    
                    const currentTimeDisplay = document.getElementById('currentTime');
                    if (currentTimeDisplay) {
                        currentTimeDisplay.textContent = formatTime(newTime);
                    }
                    
                    e.preventDefault();
                });
                
                progressBarContainer.addEventListener('touchend', function(e) {
                    if (!isDragging || !audioPlayer || !audioPlayer.duration) return;
                    
                    const touch = e.changedTouches[0];
                    const rect = this.getBoundingClientRect();
                    const touchX = touch.clientX - rect.left;
                    const percentage = Math.max(0, Math.min(1, touchX / rect.width));
                    const newTime = percentage * audioPlayer.duration;
                    
                    audioPlayer.currentTime = newTime;
                    isDragging = false;
                    
                    console.log(`📱 Touch Seek zu: ${formatTime(newTime)}`);
                    e.preventDefault();
                });
            }
            
            // Player Controls Event Listeners
            const playBtn = document.getElementById('playBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const repeatBtn = document.getElementById('repeatBtn');
            const shuffleBtn = document.getElementById('shuffleBtn');
            const favoriteBtn = document.getElementById('favoriteBtn');
            
            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    togglePlayPause();
                });
            }
            
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    playPrevious();
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    playNext();
                });
            }
            
            if (repeatBtn) {
                repeatBtn.addEventListener('click', function() {
                    toggleRepeat();
                });
            }
            
            if (shuffleBtn) {
                shuffleBtn.addEventListener('click', function() {
                    toggleShuffle();
                });
            }
            
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', function() {
                    toggleFavorite();
                });
            }
            
            // ✅ DEMO-SONGS ENTFERNT - KEINE EVENT LISTENER MEHR NÖTIG
            // Echte Songs werden über die Bibliothek hinzugefügt
            
            // ✅ LYRICS TOGGLE ENTFERNT - Lyrics sind jetzt im Player integriert
            
            // Lyrics Sync Button
            const lyricsSyncBtn = document.getElementById('lyricsSyncBtn');
            if (lyricsSyncBtn) {
                lyricsSyncBtn.addEventListener('click', function() {
                    toggleLyricsSync();
                });
            }
            
            // Lyrics Size Button
            const lyricsSizeBtn = document.getElementById('lyricsSizeBtn');
            if (lyricsSizeBtn) {
                lyricsSizeBtn.addEventListener('click', function() {
                    toggleLyricsSize();
                });
            }
        });
        
        // ===== NEUE FUNKTIONEN FÜR ECHTEN AUDIO-PLAYER =====
        
        // ✅ PLAYLIST-FUNKTIONEN
        function createNewPlaylist() {
            const playlistName = prompt('Playlist-Name:');
            if (!playlistName) return;
            
            const playlists = JSON.parse(localStorage.getItem('music-playlists') || '[]');
            const newPlaylist = {
                id: Date.now(),
                name: playlistName,
                songs: [],
                created: new Date().toISOString()
            };
            
            playlists.push(newPlaylist);
            localStorage.setItem('music-playlists', JSON.stringify(playlists));
            
            loadPlaylists();
            showNotification(`Playlist "${playlistName}" erstellt!`, 'success');
        }
        
        function loadPlaylists() {
            const playlists = JSON.parse(localStorage.getItem('music-playlists') || '[]');
            const container = document.getElementById('playlistsGrid');
            const countEl = document.getElementById('playlistsCount');
            
            if (!container) return;
            
            if (playlists.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-list-ul"></i>
                        <h4>Keine Playlists</h4>
                        <p>Erstelle eine Playlist, um Songs zu organisieren</p>
                    </div>
                `;
                if (countEl) countEl.textContent = '0 Playlists';
                return;
            }
            
            container.innerHTML = '';
            playlists.forEach(playlist => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.style.cssText = 'background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-list-ul" style="font-size: 2em; color: #4ecdc4;"></i>
                        <div style="flex: 1;">
                            <h4 style="color: white; margin: 0 0 5px 0;">${playlist.name}</h4>
                            <p style="color: #888; margin: 0; font-size: 0.9em;">${playlist.songs.length} Songs</p>
                        </div>
                        <button onclick="deletePlaylist(${playlist.id}); event.stopPropagation();" style="background: rgba(255,0,0,0.2); color: #ff4757; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            if (countEl) countEl.textContent = `${playlists.length} Playlists`;
        }
        
        function deletePlaylist(id) {
            if (!confirm('Playlist wirklich löschen?')) return;
            
            let playlists = JSON.parse(localStorage.getItem('music-playlists') || '[]');
            playlists = playlists.filter(p => p.id !== id);
            localStorage.setItem('music-playlists', JSON.stringify(playlists));
            
            loadPlaylists();
            showNotification('Playlist gelöscht!', 'info');
        }

        // Track laden und UI aktualisieren
        function loadTrack(track, index) {
            console.log('🎵 Lade Track:', track.title);
            
            currentTrack = track;
            currentTrackIndex = index;
            
            // Audio laden
            audioPlayer.src = track.url;
            audioPlayer.load();
            
            // ✅ UI AKTUALISIEREN MIT ALBUM-COVER
            document.getElementById('trackTitle').textContent = track.title || 'Unbekannter Titel';
            document.getElementById('trackArtist').textContent = track.artist || 'Unbekannter Künstler';
            document.getElementById('trackAlbum').textContent = track.album || 'Unbekanntes Album';
            document.getElementById('trackYear').textContent = track.year || '';
            
            // ✅ ALBUM-COVER ANZEIGEN
            updateAlbumCover(track.albumCover);
            
            // Playlist-Anzeige aktualisieren
            updatePlaylistUI();
            
            // Speichere aktuellen Track
            savePlayerState();
            // Titel aktualisiert
            
            // Favoriten-Button Status aktualisieren
            const favoriteBtn = document.getElementById('favoriteBtn');
            const favoriteIcon = document.getElementById('favoriteIcon');
            if (track.isFavorite) {
                favoriteBtn.classList.add('active');
                favoriteIcon.classList.remove('far');
                favoriteIcon.classList.add('fas');
                favoriteBtn.title = 'Von Favoriten entfernen';
            } else {
                favoriteBtn.classList.remove('active');
                favoriteIcon.classList.remove('fas');
                favoriteIcon.classList.add('far');
                favoriteBtn.title = 'Zu Favoriten hinzufügen';
            }
            
            // Alle Songs in der Liste als nicht-spielend markieren
            document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing'));
            
            // Aktuellen Song als spielend markieren
            const songElement = document.querySelector(`[data-track-index="${index}"]`);
            if (songElement) {
                songElement.classList.add('playing');
            }
            
            // Track geladen
        }

        // ✅ ALBUM-COVER ANZEIGE-FUNKTION
        function updateAlbumCover(coverUrl) {
            const albumCover = document.getElementById('albumCover');
            const albumCoverImage = document.getElementById('albumCoverImage');
            const albumCoverIcon = document.getElementById('albumCoverIcon');
            const albumCoverGlow = document.querySelector('.album-cover-glow');
            
            if (coverUrl) {
                // Cover vorhanden - Bild anzeigen
                albumCoverImage.src = coverUrl;
                albumCoverImage.style.display = 'block';
                albumCoverIcon.style.display = 'none';
                
                // Glow-Effekt mit Cover-Farben
                albumCover.style.background = 'none';
                if (albumCoverGlow) {
                    albumCoverGlow.style.background = `url(${coverUrl})`;
                    albumCoverGlow.style.backgroundSize = 'cover';
                }
                
                console.log('🎨 Album-Cover angezeigt');
            } else {
                // Kein Cover - Standard-Icon anzeigen
                albumCoverImage.style.display = 'none';
                albumCoverIcon.style.display = 'flex';
                
                // Standard-Gradient
                albumCover.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                if (albumCoverGlow) {
                    albumCoverGlow.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                }
                
                console.log('🎵 Standard Album-Cover angezeigt');
            }
        }

        // ✅ ALBUM-COVER ANZEIGE-FUNKTION
        function updateAlbumCover(coverUrl) {
            const albumCover = document.getElementById('albumCover');
            const albumCoverImage = document.getElementById('albumCoverImage');
            const albumCoverIcon = document.getElementById('albumCoverIcon');
            const albumCoverGlow = document.querySelector('.album-cover-glow');
            
            if (coverUrl) {
                // Cover vorhanden - Bild anzeigen
                albumCoverImage.src = coverUrl;
                albumCoverImage.style.display = 'block';
                albumCoverIcon.style.display = 'none';
                
                // Glow-Effekt mit Cover-Farben
                albumCover.style.background = 'none';
                if (albumCoverGlow) {
                    albumCoverGlow.style.background = `url(${coverUrl})`;
                    albumCoverGlow.style.backgroundSize = 'cover';
                }
                
                console.log('🎨 Album-Cover angezeigt');
            } else {
                // Kein Cover - Standard-Icon anzeigen
                albumCoverImage.style.display = 'none';
                albumCoverIcon.style.display = 'flex';
                
                // Standard-Gradient
                albumCover.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                if (albumCoverGlow) {
                    albumCoverGlow.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                }
                
                console.log('🎵 Standard Album-Cover angezeigt');
            }
        }
        
        // Web Audio API für Visualizer und Equalizer initialisieren
        let eqFilters = [];
        let bassBoostFilter = null;
        
        function initializeWebAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaElementSource(audioPlayer);
                
                // Equalizer Filter erstellen (5-Band EQ)
                const frequencies = [60, 170, 310, 600, 1000];
                eqFilters = frequencies.map(freq => {
                    const filter = audioContext.createBiquadFilter();
                    filter.type = 'peaking';
                    filter.frequency.value = freq;
                    filter.Q.value = 1;
                    filter.gain.value = 0;
                    return filter;
                });
                
                // Bass Boost Filter (Low Shelf)
                bassBoostFilter = audioContext.createBiquadFilter();
                bassBoostFilter.type = 'lowshelf';
                bassBoostFilter.frequency.value = 250;
                bassBoostFilter.gain.value = 0;
                
                // Audio Chain: Source -> EQ Filters -> Bass Boost -> Analyser -> Destination
                let currentNode = source;
                
                // EQ Filter Chain
                eqFilters.forEach(filter => {
                    currentNode.connect(filter);
                    currentNode = filter;
                });
                
                // Bass Boost
                currentNode.connect(bassBoostFilter);
                
                // Analyser für Visualizer
                bassBoostFilter.connect(analyser);
                analyser.connect(audioContext.destination);
                
                analyser.fftSize = 256;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // Web Audio API initialisiert
            } catch (error) {
                console.error('Fehler bei Web Audio API:', error);
            }
        }
        
        // Musikdatei zur Playlist hinzufügen (mit persistenter Speicherung)
        async function addTrackToPlaylist(file) {
            // Datei wird verarbeitet
            
            try {
                // Metadaten aus Datei extrahieren
                const metadata = await extractMetadata(file);
                
                const trackUrl = URL.createObjectURL(file);
                
                const track = {
                    name: metadata.title || file.name.replace(/\.[^/.]+$/, ""), // Remove file extension
                    artist: metadata.artist || 'Unbekannter Künstler',
                    album: metadata.album || 'Unbekanntes Album',
                    genre: metadata.genre || 'Unbekanntes Genre',
                    year: metadata.year || null,
                    track: metadata.track || null,
                    duration: metadata.duration || '0:00',
                    fileName: file.name,
                    file: file,
                    url: trackUrl,
                    dateAdded: new Date().toISOString(),
                    isFavorite: false
                };
                
                // Track URL für Cleanup registrieren
                if (!window._objectUrls) window._objectUrls = [];
                window._objectUrls.push(trackUrl);
                
                playlist.push(track);
                
                // Keine automatische Sortierung - Lieder werden in bestehende Kategorien einsortiert
                
                updatePlaylistUI();
                updateSongCount();
                updateMusicCategories();
                savePlaylist();
                
                // Track erfolgreich hinzugefügt
            } catch (error) {
                console.error('❌ Fehler beim Hinzufügen des Tracks:', error);
            }
        }

// ✅ ERWEITERTE METADATEN-EXTRAKTION MIT ALBUM-COVER
async function extractMetadata(file) {
    return new Promise(async (resolve) => {
        const audio = new Audio();
        const url = URL.createObjectURL(file);
        
        // ✅ ALBUM-COVER EXTRAKTION
        let albumCover = null;
        try {
            albumCover = await extractAlbumCover(file);
        } catch (error) {
            console.warn('Album-Cover-Extraktion fehlgeschlagen:', error);
        }
        
        audio.addEventListener('loadedmetadata', function() {
            try {
                // Basis-Metadaten aus Audio-Element
                const duration = formatTime(audio.duration || 0);
                const parsedData = parseFileNameForMetadata(file.name);
                
                resolve({
                    title: parsedData.title || file.name.replace(/\.[^/.]+$/, ""),
                    artist: parsedData.artist || 'Unbekannter Künstler',
                    album: parsedData.album || 'Unbekanntes Album',
                    year: parsedData.year || '',
                    duration: duration,
                    size: file.size,
                    type: file.type,
                    url: url,
                    file: file,
                    albumCover: albumCover // ✅ Album-Cover hinzugefügt
                });
            } catch (error) {
                console.error('Metadata-Extraktion Fehler:', error);
                resolve({
                    title: file.name.replace(/\.[^/.]+$/, ""),
                    artist: 'Unbekannter Künstler',
                    album: 'Unbekanntes Album',
                    year: '',
                    duration: '0:00',
                    size: file.size,
                    type: file.type,
                    url: url,
                    file: file,
                    albumCover: albumCover
                });
            }
        });
        
        audio.addEventListener('error', function() {
            resolve({
                title: file.name.replace(/\.[^/.]+$/, ""),
                artist: 'Unbekannter Künstler',
                album: 'Unbekanntes Album',
                year: '',
                duration: '0:00',
                size: file.size,
                type: file.type,
                url: url,
                file: file,
                albumCover: albumCover
            });
        });
        
        audio.src = url;
    });
}

// ✅ ALBUM-COVER EXTRAKTION AUS ID3-TAGS
async function extractAlbumCover(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const buffer = e.target.result;
                const dataView = new DataView(buffer);
                
                // ID3v2-Header prüfen
                if (dataView.getUint8(0) === 0x49 && // 'I'
                    dataView.getUint8(1) === 0x44 && // 'D'
                    dataView.getUint8(2) === 0x33) { // '3'
                    
                    const cover = parseID3v2Cover(dataView);
                    if (cover) {
                        resolve(cover);
                        return;
                    }
            let title = name;
            let artist = null;
            let album = null;
            let genre = null;
            let year = null;
            let track = null;
            
            // Format: "Artist - Title"
            if (name.includes(' - ')) {
                const parts = name.split(' - ');
                if (parts.length >= 2) {
                    artist = parts[0].trim();
                    title = parts[1].trim();
                }
            }
            
            // Format: "01. Artist - Title" oder "01 - Artist - Title"
            const trackMatch = name.match(/^(\d{1,2})[\.\s\-]+(.+)/);
            if (trackMatch) {
                track = parseInt(trackMatch[1]);
                const remaining = trackMatch[2];
                if (remaining.includes(' - ')) {
                    const parts = remaining.split(' - ');
                    artist = parts[0].trim();
                    title = parts[1].trim();
                } else {
                    title = remaining.trim();
                }
            }
            
            // Jahr extrahieren (4-stellige Zahl)
            const yearMatch = name.match(/\b(19|20)\d{2}\b/);
            if (yearMatch) {
                year = parseInt(yearMatch[0]);
            }
            
            // Genre aus häufigen Begriffen ableiten
            const genreKeywords = {
                'rock': ['rock', 'metal', 'punk'],
                'pop': ['pop', 'chart', 'hit'],
                'electronic': ['electronic', 'techno', 'house', 'edm', 'dance'],
                'jazz': ['jazz', 'blues', 'swing'],
                'classical': ['classical', 'orchestra', 'symphony'],
                'hip-hop': ['hip', 'hop', 'rap', 'trap'],
                'country': ['country', 'folk', 'acoustic']
            };
            
            const lowerName = name.toLowerCase();
            for (const [genreName, keywords] of Object.entries(genreKeywords)) {
                if (keywords.some(keyword => lowerName.includes(keyword))) {
                    genre = genreName.charAt(0).toUpperCase() + genreName.slice(1);
                    break;
                }
            }
            
            return { title, artist, album, genre, year, track };
        }
        
        // Playlist nach verschiedenen Kriterien sortieren
        function sortPlaylistByMetadata(sortBy = 'artist') {
            currentSortMethod = sortBy;
            
            const sortedPlaylist = [...playlist];
            
            switch(sortBy) {
                case 'title':
                    sortedPlaylist.sort((a, b) => a.name.localeCompare(b.name));
                    // Nach Titel sortiert
                    break;
                    
                case 'artist':
                    sortedPlaylist.sort((a, b) => {
                        // Primär: Nach Künstler
                        if (a.artist !== b.artist) {
                            return a.artist.localeCompare(b.artist);
                        }
                        // Sekundär: Nach Album
                        if (a.album !== b.album) {
                            return a.album.localeCompare(b.album);
                        }
                        // Tertiär: Nach Track-Nummer
                        if (a.track && b.track) {
                            return a.track - b.track;
                        }
                        // Quartär: Nach Titel
                        return a.name.localeCompare(b.name);
                    });
                    // Nach Interpret sortiert
                    break;
                    
                case 'album':
                    sortedPlaylist.sort((a, b) => {
                        // Primär: Nach Album
                        if (a.album !== b.album) {
                            return a.album.localeCompare(b.album);
                        }
                        // Sekundär: Nach Track-Nummer
                        if (a.track && b.track) {
                            return a.track - b.track;
                        }
                        // Tertiär: Nach Titel
                        return a.name.localeCompare(b.name);
                    });
                    // Nach Album sortiert
                    break;
                    
                case 'folder':
                    sortedPlaylist.sort((a, b) => {
                        // Nach Ordner/Pfad (aus fileName extrahiert)
                        const folderA = a.fileName.substring(0, a.fileName.lastIndexOf('/') || 0);
                        const folderB = b.fileName.substring(0, b.fileName.lastIndexOf('/') || 0);
                        if (folderA !== folderB) {
                            return folderA.localeCompare(folderB);
                        }
                        return a.name.localeCompare(b.name);
                    });
                    // Nach Ordner sortiert
                    break;
                    
                case 'date':
                    sortedPlaylist.sort((a, b) => {
                        // Nach Hinzufüge-Datum
                        const dateA = new Date(a.dateAdded || 0);
                        const dateB = new Date(b.dateAdded || 0);
                        return dateB - dateA; // Neueste zuerst
                    });
                    // Nach Datum sortiert
                    break;
                    
                case 'favorites':
                    sortedPlaylist.sort((a, b) => {
                        // Favoriten zuerst, dann alphabetisch nach Name
                        if (a.isFavorite !== b.isFavorite) {
                            return a.isFavorite ? -1 : 1;
                        }
                        return a.name.localeCompare(b.name);
                    });
                    // Nach Favoriten sortiert
                    break;
                    
                default:
                    // Unbekannte Sortierungsmethode
                    return;
            }
            
            playlist = sortedPlaylist;
            currentSortMethod = sortBy;
            updatePlaylistUI();
        }

        // Wrapper-Funktion für Playlist-Speicherung
        function savePlaylist() {
            savePlaylistToStorage();
        }
        
        // Playlist persistent speichern
        function savePlaylistToStorage() {
            try {
                const playlistData = playlist.map(track => ({
                    name: track.name,
                    artist: track.artist,
                    album: track.album,
                    fileName: track.fileName,
                    fileSize: track.fileSize,
                    fileType: track.fileType,
                    duration: track.duration,
                    dateAdded: track.dateAdded,
                    isFavorite: track.isFavorite
                }));
                localStorage.setItem('musicPlaylist', JSON.stringify(playlistData));
                // Playlist gespeichert
            } catch (error) {
                console.error('❌ Fehler beim Speichern der Playlist:', error);
            }
        }

        // Playlist aus Speicher laden
        function loadPlaylistFromStorage() {
            try {
                const savedPlaylist = localStorage.getItem('musicPlaylist');
                if (savedPlaylist) {
                    const playlistData = JSON.parse(savedPlaylist);
                    // Gespeicherte Tracks gefunden
                    
                    // Hinweis: Dateien können nicht wiederhergestellt werden, nur Metadaten
                    playlistData.forEach(trackData => {
                        const placeholderTrack = {
                            name: trackData.name,
                            artist: trackData.artist,
                            url: null, // Datei muss neu geladen werden
                            file: null,
                            duration: trackData.duration,
                            fileName: trackData.fileName,
                            fileSize: trackData.fileSize,
                            fileType: trackData.fileType,
                            album: trackData.album || 'Unbekanntes Album',
                            genre: trackData.genre || 'Unbekanntes Genre',
                            isPlaceholder: true
                        };
                        playlist.push(placeholderTrack);
                    });
                    
                    updatePlaylistUI();
                    updateSongCount();
                    updateMusicCategories();
                }
            } catch (error) {
                console.error('❌ Fehler beim Laden der Playlist:', error);
            }
        }

        // Musik-Kategorien in obere Übersichtsleiste einsortieren
        function updateMusicCategories() {
            const albums = new Set();
            const artists = new Set();
            const folders = new Set();
            
            playlist.forEach(track => {
                if (track.album && track.album !== 'Unbekanntes Album') albums.add(track.album);
                if (track.artist && track.artist !== 'Unbekannter Künstler') artists.add(track.artist);
                if (track.fileName) {
                    const folder = track.fileName.split('/').slice(0, -1).join('/') || 'Root';
                    folders.add(folder);
                }
            });
            
            // In obere Übersichtsleiste einsortieren
            updateCategoryPanel('albumsList', Array.from(albums), 'album');
            updateCategoryPanel('artistsList', Array.from(artists), 'artist');
            updateCategoryPanel('foldersList', Array.from(folders), 'folder');
            updateAllSongsList();
            updateFavoritesList();
            
            // Kategorien einsortiert
        }

        // Kategorie-Panels in oberer Übersichtsleiste aktualisieren
        function updateCategoryPanel(containerId, items, categoryType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'category-card';
                itemElement.style.cssText = `
                    background: rgba(78, 205, 196, 0.1);
                    border: 1px solid rgba(78, 205, 196, 0.3);
                    border-radius: 10px;
                    padding: 15px;
                    margin: 10px;
                    cursor: pointer;
                    transition: all 0.3s;
                    text-align: center;
                `;
                
                const tracksInCategory = playlist.filter(track => {
                    switch(categoryType) {
                        case 'album': return track.album === item;
                        case 'artist': return track.artist === item;
                        case 'folder': return (track.fileName ? track.fileName.split('/').slice(0, -1).join('/') || 'Root' : 'Root') === item;
                        default: return false;
                    }
                });
                
                // Sichere DOM-Erstellung ohne innerHTML
                const titleDiv = document.createElement('div');
                titleDiv.style.cssText = 'font-weight: bold; color: #4ecdc4; margin-bottom: 5px;';
                titleDiv.textContent = sanitizeText(item);
                
                const countDiv = document.createElement('div');
                countDiv.style.cssText = 'font-size: 0.9em; color: #a0f0ff;';
                countDiv.textContent = `${tracksInCategory.length} Titel`;
                
                itemElement.appendChild(titleDiv);
                itemElement.appendChild(countDiv);
                
                itemElement.onclick = () => {
                    // Zur Lieder-Ansicht wechseln und filtern
                    showPanel('songs');
                    updatePlaylistUI(tracksInCategory);
                };
                
                container.appendChild(itemElement);
            });
        }
        
        // Alle Lieder in der Übersichtsleiste anzeigen
        function updateAllSongsList() {
            const container = document.getElementById('allSongsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            playlist.forEach((track, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'song-item';
                songElement.setAttribute('data-track-index', index);
                songElement.onclick = () => {
                    loadTrack(index);
                    playPause();
                };
                songElement.ontouchend = (e) => {
                    e.preventDefault();
                    loadTrack(index);
                    playPause();
                };
                
                // Sichere DOM-Erstellung ohne innerHTML
                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';
                
                const songName = document.createElement('div');
                songName.className = 'song-name';
                songName.textContent = sanitizeText(track.name);
                
                const songArtist = document.createElement('div');
                songArtist.className = 'song-artist';
                songArtist.textContent = sanitizeText(track.artist);
                
                songInfo.appendChild(songName);
                songInfo.appendChild(songArtist);
                
                const songDuration = document.createElement('div');
                songDuration.className = 'song-duration';
                songDuration.textContent = track.duration || formatTime(0);
                
                songElement.appendChild(songInfo);
                songElement.appendChild(songDuration);
                
                container.appendChild(songElement);
            });
        }
        
        // Favoriten in der Übersichtsleiste anzeigen
        function updateFavoritesList() {
            const container = document.getElementById('favoritesList');
            if (!container) return;
            
            const favorites = playlist.filter(track => track.isFavorite);
            container.innerHTML = '';
            
            favorites.forEach((track, index) => {
                const realIndex = playlist.indexOf(track);
                const songElement = document.createElement('div');
                songElement.className = 'song-item';
                songElement.setAttribute('data-track-index', realIndex);
                songElement.onclick = () => {
                    loadTrack(realIndex);
                    playPause();
                };
                songElement.ontouchend = (e) => {
                    e.preventDefault();
                    loadTrack(realIndex);
                    playPause();
                };
                
                // Sichere DOM-Erstellung ohne innerHTML
                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';
                
                const songName = document.createElement('div');
                songName.className = 'song-name';
                songName.textContent = sanitizeText(track.name);
                
                const songArtist = document.createElement('div');
                songArtist.className = 'song-artist';
                songArtist.textContent = sanitizeText(track.artist);
                
                songInfo.appendChild(songName);
                songInfo.appendChild(songArtist);
                
                const songDuration = document.createElement('div');
                songDuration.className = 'song-duration';
                songDuration.textContent = track.duration;
                
                const songActions = document.createElement('div');
                songActions.className = 'song-actions';
                
                const playNextBtn = document.createElement('button');
                playNextBtn.title = 'Als nächstes abspielen';
                playNextBtn.onclick = (event) => {
                    event.stopPropagation();
                    playNext(realIndex);
                };
                
                const playNextIcon = document.createElement('i');
                playNextIcon.className = 'fas fa-step-forward';
                playNextBtn.appendChild(playNextIcon);
                songActions.appendChild(playNextBtn);
                
                songElement.appendChild(songInfo);
                songElement.appendChild(songDuration);
                songElement.appendChild(songActions);
                
                container.appendChild(songElement);
            });
        }

// Musik-Kategorien in obere Übersichtsleiste einsortieren
function updateMusicCategories() {
    const albums = new Set();
    const artists = new Set();
    const folders = new Set();

    playlist.forEach(track => {
        if (track.album && track.album !== 'Unbekanntes Album') albums.add(track.album);
        if (track.artist && track.artist !== 'Unbekannter Künstler') artists.add(track.artist);
        if (track.fileName) {
            const folder = track.fileName.split('/').slice(0, -1).join('/') || 'Root';
            folders.add(folder);
        }
    });

    // In obere Übersichtsleiste einsortieren
    updateCategoryPanel('albumsList', Array.from(albums), 'album');
    updateCategoryPanel('artistsList', Array.from(artists), 'artist');
    updateCategoryPanel('foldersList', Array.from(folders), 'folder');
    updateAllSongsList();
    updateFavoritesList();
    
    // Kategorien einsortiert
}

// Kategorie-Panels in oberer Übersichtsleiste aktualisieren
function updateCategoryPanel(containerId, items, categoryType) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    items.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'category-card';
        itemElement.style.cssText = `
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        `;

        const tracksInCategory = playlist.filter(track => {
            switch(categoryType) {
                case 'album': return track.album === item;
                case 'artist': return track.artist === item;
                case 'folder': return (track.fileName ? track.fileName.split('/').slice(0, -1).join('/') || 'Root' : 'Root') === item;
                default: return false;
            }
        });
        
        // Sichere DOM-Erstellung ohne innerHTML
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = 'font-weight: bold; color: #4ecdc4; margin-bottom: 5px;';
        titleDiv.textContent = sanitizeText(item);
        
        const countDiv = document.createElement('div');
        countDiv.style.cssText = 'font-size: 0.9em; color: #a0f0ff;';
        countDiv.textContent = `${tracksInCategory.length} Titel`;
        
        itemElement.appendChild(titleDiv);
        itemElement.appendChild(countDiv);
        
        itemElement.onclick = () => {
            // Zur Lieder-Ansicht wechseln und filtern
            showPanel('songs');
            updatePlaylistUI(tracksInCategory);
        };
        
        container.appendChild(itemElement);
    });
}

// Suchfunktion
function searchTracks(searchTerm) {
    if (!searchTerm.trim()) {
        updatePlaylistUI(); // Alle anzeigen
        return;
    }
    
    const filteredTracks = playlist.filter(track => 
        track.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        track.artist.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (track.album && track.album.toLowerCase().includes(searchTerm.toLowerCase()))
    );
    
    // Tracks gefunden
    updatePlaylistUI(filteredTracks);
}

// Playlist UI aktualisieren
function updatePlaylistUI(filteredTracks = playlist) {
    const songList = document.getElementById('songList');
    if (!songList) return;
    
    songList.innerHTML = '';
    
    filteredTracks.forEach((track, index) => {
        const songElement = document.createElement('div');
        songElement.className = 'song-item';
        const realIndex = playlist.indexOf(track);
        songElement.setAttribute('data-track-index', realIndex);
        songElement.onclick = () => selectSong(songElement, realIndex);
        
        // Sichere DOM-Erstellung ohne innerHTML
        const songInfo = document.createElement('div');
        songInfo.className = 'song-info';
        
        const songName = document.createElement('div');
        songName.className = 'song-name';
        songName.textContent = sanitizeText(track.name);
        
        const songArtist = document.createElement('div');
        songArtist.className = 'song-artist';
        songArtist.textContent = sanitizeText(track.artist);
        
        songInfo.appendChild(songName);
        songInfo.appendChild(songArtist);
        
        const songDuration = document.createElement('div');
        songDuration.className = 'song-duration';
        songDuration.textContent = track.duration || formatTime(0);
        
        songElement.appendChild(songInfo);
        songElement.appendChild(songDuration);
        
        songList.appendChild(songElement);
    });
}

// Song-Anzahl aktualisieren
function updateSongCount() {
    const songCountElement = document.getElementById('songCount');
    if (songCountElement) {
        songCountElement.textContent = `${playlist.length} Titel`;
    }
}

// ✅ ECHTE LED-MUSIK-SYNCHRONISATION MIT HARDWARE!
let ledUpdateInterval = null;
let lastLEDUpdate = 0;
const LED_UPDATE_RATE = 50; // 20 FPS für flüssige LED-Updates

function initializeLEDMusicSync() {
    console.log('🎵 Initialisiere LED-Musik-Synchronisation...');
    
    // Starte LED-Update-Loop
    if (ledUpdateInterval) clearInterval(ledUpdateInterval);
    
    ledUpdateInterval = setInterval(() => {
        if (isPlaying && !audioPlayer.paused && analyser && dataArray) {
            // Nur updaten wenn genug Zeit vergangen ist (Rate-Limiting)
            const now = Date.now();
            if (now - lastLEDUpdate >= LED_UPDATE_RATE) {
                analyser.getByteFrequencyData(dataArray);
                sendAudioDataToLEDControl(dataArray);
                lastLEDUpdate = now;
            }
        }
    }, LED_UPDATE_RATE);
}

// ✅ ECHTE HARDWARE-FUNKTION: Audio-Daten zu LED-Farben konvertieren und senden!
async function sendAudioDataToLEDControl(frequencyData) {
    if (!frequencyData || frequencyData.length === 0) return;
    
    try {
        // Hole den globalen BLE Controller
        let controller = null;
        
        if (window.parent && window.parent !== window && window.parent.bleController) {
            controller = window.parent.bleController;
        } else if (window.bleController) {
            controller = window.bleController;
        }
        
        if (!controller || !controller.isConnected) {
            // Keine Verbindung - nichts senden
            return;
        }
        
        // ✅ ANALYSIERE AUDIO-FREQUENZEN
        const bufferLength = frequencyData.length;
        
        // Teile Frequenzspektrum in Bass, Mid, Treble
        const bassEnd = Math.floor(bufferLength * 0.1);   // 0-10% = Bass
        const midEnd = Math.floor(bufferLength * 0.5);     // 10-50% = Mid
        // 50-100% = Treble
        
        let bass = 0, mid = 0, treble = 0;
        
        // Berechne Durchschnittswerte für jeden Bereich
        for (let i = 0; i < bassEnd; i++) {
            bass += frequencyData[i];
        }
        bass = bass / bassEnd / 255; // Normalisiere auf 0-1
        
        for (let i = bassEnd; i < midEnd; i++) {
            mid += frequencyData[i];
        }
        mid = mid / (midEnd - bassEnd) / 255;
        
        for (let i = midEnd; i < bufferLength; i++) {
            treble += frequencyData[i];
        }
        treble = treble / (bufferLength - midEnd) / 255;
        
        // ✅ KONVERTIERE ZU RGB-FARBEN
        // Bass = Rot, Mid = Grün, Treble = Blau
        const r = Math.round(bass * 255);
        const g = Math.round(mid * 255);  
        const b = Math.round(treble * 255);
        
        // ✅ SENDE ECHTE FARBE AN HARDWARE!
        await controller.setColorRGB(r, g, b);
        
        // Beat-Erkennung für spezielle Effekte
        if (bass > 0.8) {
            // Starker Bass - Pulseffekt
            await controller.setBrightness(100);
            setTimeout(async () => {
                await controller.setBrightness(70);
            }, 50);
        }
        
    } catch (error) {
        // Fehler still ignorieren um Performance nicht zu beeinträchtigen
        console.error('LED-Musik-Sync Fehler:', error);
    }
}

// Initialize Visualizer
function initializeVisualizer() {
    const container = document.getElementById('visualizerBars');
    
    // Create visualizer bars
    for (let i = 0; i < 64; i++) {
        const bar = document.createElement('div');
        bar.className = 'vis-bar';
        bar.style.cssText = 'width: 8px; height: 20px; background: linear-gradient(180deg, #4ecdc4, #44a3aa); margin: 0 2px; border-radius: 4px 4px 0 0; transition: height 0.1s ease;';
        container.appendChild(bar);
    }
    
    // Initialisiere Beat-Detektor wenn noch nicht vorhanden
    if (!beatDetector) {
        beatDetector = new SimpleBeatDetector();
    }
    
    // ✅ INITIALISIERE ECHTE LED-MUSIK-SYNCHRONISATION!
    initializeLEDMusicSync();
}

// ✅ STOPPE LED-MUSIK-SYNC BEIM VERLASSEN
window.addEventListener('beforeunload', () => {
    if (ledUpdateInterval) {
        clearInterval(ledUpdateInterval);
        ledUpdateInterval = null;
    }
});

// Initialisierung beim Laden
document.addEventListener('DOMContentLoaded', function() {
    updateTimeDisplay();
    initializeVisualizer();
    loadPlaylistFromStorage(); // Gespeicherte Playlist laden
    
    // Beat-Detektor initialisieren
    initializeBeatDetector();
    
    // ✅ LED-MUSIK-SYNC INITIALISIEREN
    console.log('🎵 Starte LED-Musik-Synchronisation...');
    initializeLEDMusicSync();
    
    // Start animation loop
    function animate() {
        animateVisualizer();
        requestAnimationFrame(animate);
    }
    animate();
    
    // Sortierungs-Buttons Event Listener
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Aktiven Status updaten
            document.querySelectorAll('.sort-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'rgba(255, 255, 255, 0.1)';
                b.style.border = '1px solid rgba(255, 255, 255, 0.2)';
            });
            
            this.classList.add('active');
            this.style.background = 'rgba(78, 205, 196, 0.2)';
            this.style.border = '1px solid #4ecdc4';
            
            // Playlist sortieren
            const sortMethod = this.getAttribute('data-sort');
            sortPlaylistByMetadata(sortMethod);
        });
    });
            
    // Musik-Player initialisiert
});
        
// ===== ENDE NEUER MUSIK PLAYER =====

// Taskbar Navigation - MUSS IN DOMCONTENTLOADED!
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎵 Initialisiere Musik-Panel Navigation...');
    
    // ✅ AUDIO CONTEXT & ANALYSER FÜR VISUALIZER & EQUALIZER
    let audioContext = null;
    let analyser = null;
    let source = null;
    let eqFilters = [];
    
    // ✅ INITIALISIERE AUDIO-SYSTEM
    function initAudioSystem() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            analyser.smoothingTimeConstant = 0.8;
            
            // ✅ ERSTELLE EQUALIZER-FILTER
            const frequencies = [60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000];
            frequencies.forEach(freq => {
                const filter = audioContext.createBiquadFilter();
                filter.type = freq <= 310 ? 'lowshelf' : freq >= 6000 ? 'highshelf' : 'peaking';
                filter.frequency.value = freq;
                filter.Q.value = 1;
                filter.gain.value = 0;
                eqFilters.push(filter);
            });
            
            console.log('✅ Audio-System initialisiert');
        }
    }
    
    // ✅ VERBINDE AUDIO-ELEMENT MIT ANALYSER
    function connectAudioElement(audioElement) {
        if (!audioContext) initAudioSystem();
        
        if (source) {
            source.disconnect();
        }
        
        source = audioContext.createMediaElementSource(audioElement);
        
        // Verbinde durch EQ-Filter
        let prevNode = source;
        eqFilters.forEach(filter => {
            prevNode.connect(filter);
            prevNode = filter;
        });
        
        // Verbinde mit Analyser und Ausgang
        prevNode.connect(analyser);
        analyser.connect(audioContext.destination);
        
        console.log('✅ Audio-Element verbunden');
    }
    
    // ✅ TASKBAR-BUTTON EVENT-LISTENER
    const taskbarButtons = document.querySelectorAll('.taskbar-btn');
    console.log(`✅ ${taskbarButtons.length} Taskbar-Buttons gefunden`);
    
    taskbarButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const content = this.getAttribute('data-content');
            console.log(`🎵 Tab geklickt: ${content}`);
        
            // AKTIVE TAB WECHSELN
            document.querySelectorAll('.taskbar-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // ALLE PANELS VERSTECKEN (wie in funktionierender Version)
            document.querySelectorAll('.content-panel').forEach(panel => panel.classList.remove('active'));
            
            // GEWÄHLTES PANEL ANZEIGEN (einfache Methode)
            const targetPanel = document.getElementById(content);
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log(` Panel '${content}' angezeigt`);
            
                // SPEZIAL-AKTIONEN FÜR JEDES PANEL
                switch(content) {
                    case 'equalizer':
                        console.log(' Equalizer Panel aktiviert');
                        if (typeof initializeEqualizer === 'function') {
                            initializeEqualizer();
                        }
                        break;
                    case 'visualizer':
                        console.log('🌈 Visualizer Panel aktiviert');
                        if (typeof initializeVisualizer === 'function') {
                            initializeVisualizer();
                        }
                        break;
                    case 'led':
                        console.log('💡 LED-Musik Panel aktiviert');
                        break;
                    case 'party':
                        console.log('🎉 Party-Modus Panel aktiviert');
                        break;
                    case 'library':
                        console.log('📚 Bibliothek Panel aktiviert');
                        break;
                    case 'settings':
                        console.log('⚙️ Einstellungen Panel aktiviert');
                        break;
                    case 'player':
                        console.log(' Player Panel aktiviert');
                        break;
                }
            } else {
                console.error(` Panel '${content}' nicht gefunden!`);
            }
        });
    }); // ← Schließt forEach
    // Initial Player-Tab aktivieren
    const playerTab = document.querySelector('.taskbar-btn[data-content="player"]');
    if (playerTab) {
        playerTab.click();
        console.log('✅ Player-Tab initial aktiviert');
    }
    
    // Player initialisieren (direkt hier statt über separate Funktion)
    // Initialize visualizer on page load
    if (typeof updateVisualizerType === 'function') {
        updateVisualizerType();
    }
    
    // Initialize player
    if (typeof initializePlayer === 'function') {
        initializePlayer();
    }
    
    // Load saved playlist on page load
    if (typeof loadPlaylist === 'function') {
        loadPlaylist();
    }
    
    console.log('🎵 Musik-App vollständig initialisiert - Persistente Wiedergabe aktiviert');
    
    // Equalizer Toggle - Echte Audio-Filterung
    const eqToggle = document.getElementById('eqToggle');
    if (eqToggle) {
        eqToggle.addEventListener('change', function() {
            const sliders = document.querySelectorAll('.eq-slider');
            const presets = document.querySelectorAll('.preset-btn');
            
            if (this.checked) {
                sliders.forEach(slider => slider.disabled = false);
                presets.forEach(btn => btn.disabled = false);
                
                // EQ-Filter aktivieren (aktuelle Werte beibehalten)
                sliders.forEach((slider, index) => {
                    if (eqFilters && eqFilters[index]) {
                        eqFilters[index].gain.value = parseFloat(slider.value);
                    }
                });
                
                console.log(' Equalizer aktiviert');
            } else {
                sliders.forEach(slider => slider.disabled = true);
                presets.forEach(btn => btn.disabled = true);
                
                // EQ-Filter auf Neutral setzen
                if (eqFilters) {
                    eqFilters.forEach(filter => {
                        filter.gain.value = 0;
                    });
                }
                
                console.log(' Equalizer deaktiviert');
            }
        });

        // Bass Boost Controls - Echte Audio-Filterung
        document.getElementById('bassBoostToggle').addEventListener('change', function() {
            const intensity = document.getElementById('bassBoostIntensity');
            
            if (this.checked) {
                intensity.disabled = false;
                intensity.value = 6; // Standard Bass Boost
                document.getElementById('bassBoostValue').textContent = '6dB';
                
                // Bass Boost Filter anwenden
                if (bassBoostFilter) {
                    bassBoostFilter.gain.value = 6;
                }
                
                // Bass Boost aktiviert
            } else {
                intensity.disabled = true;
                intensity.value = 0;
                document.getElementById('bassBoostValue').textContent = '0dB';
                
                // Bass Boost Filter deaktivieren
                if (bassBoostFilter) {
                    bassBoostFilter.gain.value = 0;
                }
                
                // Bass Boost deaktiviert
            }
        });

        document.getElementById('bassBoostIntensity').addEventListener('input', function() {
            const gainValue = parseFloat(this.value);
            document.getElementById('bassBoostValue').textContent = gainValue + 'dB';
            
            // Bass Boost Intensität in Echtzeit anpassen
            if (bassBoostFilter) {
                bassBoostFilter.gain.value = gainValue;
            }
            
            console.log(`🔊 Bass Boost: ${gainValue}dB`);
        });
        
        // ✅ EQUALIZER SLIDERS - ECHTE AUDIO-FILTERUNG
        document.querySelectorAll('.eq-slider').forEach((slider, index) => {
            slider.addEventListener('input', function() {
                const gainValue = parseFloat(this.value);
                const valueDisplay = this.parentElement.querySelector('.eq-value span');
                
                if (valueDisplay) {
                    valueDisplay.textContent = (gainValue > 0 ? '+' : '') + gainValue + 'dB';
                }
                
                // ✅ ECHTZEIT AUDIO-FILTERUNG
                if (eqFilters && eqFilters[index] && audioContext) {
                    eqFilters[index].gain.setValueAtTime(gainValue, audioContext.currentTime);
                    console.log(`🎚️ EQ Band ${index + 1}: ${gainValue}dB`);
                }
            });
        });

        // Visual Presets - Enhanced with actual visualizer switching
        let currentVisualizerType = 'bars';
        document.querySelectorAll('.visual-preset').forEach(preset => {
            preset.addEventListener('click', function() {
                document.querySelectorAll('.visual-preset').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                
                // Determine visualizer type from text content
                const text = this.textContent.trim().toLowerCase();
                if (text.includes('balken')) currentVisualizerType = 'bars';
                else if (text.includes('wellen')) currentVisualizerType = 'waves';
                else if (text.includes('partikel')) currentVisualizerType = 'particles';
                else if (text.includes('kreise')) currentVisualizerType = 'circles';
                else if (text.includes('spirale')) currentVisualizerType = 'spiral';
                else if (text.includes('linien')) currentVisualizerType = 'lines';
                else if (text.includes('spektrum')) currentVisualizerType = 'spectrum';
                else if (text.includes('feuer')) currentVisualizerType = 'fire';
                
                // Update visualizer display
                updateVisualizerType();
                // Visualizer gewechselt
            });
        });

        // ✅ ECHTE VISUALIZER FUNKTIONEN MIT CANVAS
        let visualizerCanvas = null;
        let visualizerCtx = null;
        let animationId = null;
        
        function initVisualizer() {
            visualizerCanvas = document.getElementById('visualizerCanvas');
            if (visualizerCanvas) {
                visualizerCtx = visualizerCanvas.getContext('2d');
                visualizerCanvas.width = visualizerCanvas.offsetWidth;
                visualizerCanvas.height = visualizerCanvas.offsetHeight;
            }
        }
        
        // Update visualizer type and regenerate bars/elements
        function updateVisualizerType() {
            const visualizerBars = document.getElementById('visualizerBars');
            if (visualizerBars) {
                visualizerBars.innerHTML = '';
            }
            
            // Initialize canvas if not done
            if (!visualizerCtx) {
                initVisualizer();
            }
            
            // ✅ STARTE ECHTE AUDIO-VISUALISIERUNG
            if (audioContext && analyser) {
                startVisualization();
            }
            
            // Generate elements based on type
            const numElements = getElementCount(currentVisualizerType);
            
            if (visualizerBars) {
                for (let i = 0; i < numElements; i++) {
                const element = document.createElement('div');
                element.className = `visualizer-element ${currentVisualizerType}`;
                element.style.animationDelay = `${i * 0.1}s`;
                    visualizerBars.appendChild(element);
                }
            }
            
            // Apply type-specific styling
            applyVisualizerStyling(currentVisualizerType);
        }

        // Get number of elements for each visualizer type
        function getElementCount(type) {
            const counts = {
                'bars': 32,
                'waves': 20,
                'particles': 50,
                'circles': 12,
                'spiral': 24,
                'lines': 16,
                'spectrum': 64,
                'fire': 30
            };
            return counts[type] || 32;
        }

        // Apply specific styling for each visualizer type
        function applyVisualizerStyling(type) {
            const visualizerBars = document.getElementById('visualizerBars');
            
            // Remove existing type classes
            visualizerBars.className = 'visualizer-bars';
            visualizerBars.classList.add(`visualizer-${type}`);
            
            // Apply type-specific CSS
            const elements = visualizerBars.querySelectorAll('.visualizer-element');
            elements.forEach((element, index) => {
                switch(type) {
                    case 'bars':
                        element.style.width = '8px';
                        element.style.height = '20px';
                        element.style.background = '#4ecdc4';
                        element.style.margin = '0 2px';
                        element.style.borderRadius = '4px 4px 0 0';
                        break;
                    case 'waves':
                        element.style.width = '12px';
                        element.style.height = '12px';
                        element.style.background = `hsl(${index * 18}, 70%, 60%)`;
                        element.style.borderRadius = '50%';
                        element.style.margin = '0 3px';
                        break;
                    case 'particles':
                        element.style.width = '6px';
                        element.style.height = '6px';
                        element.style.background = `hsl(${Math.random() * 360}, 70%, 60%)`;
                        element.style.borderRadius = '50%';
                        element.style.position = 'absolute';
                        element.style.left = `${Math.random() * 90}%`;
                        element.style.top = `${Math.random() * 90}%`;
                        break;
                    case 'circles':
                        element.style.width = '20px';
                        element.style.height = '20px';
                        element.style.border = '2px solid #4ecdc4';
                        element.style.borderRadius = '50%';
                        element.style.margin = '0 5px';
                        break;
                    case 'spiral':
                        const angle = (index / 24) * 360;
                        const radius = 50 + (index * 3);
                        element.style.width = '8px';
                        element.style.height = '8px';
                        element.style.background = `hsl(${angle}, 70%, 60%)`;
                        element.style.borderRadius = '50%';
                        element.style.position = 'absolute';
                        element.style.left = `${50 + Math.cos(angle * Math.PI / 180) * radius}px`;
                        element.style.top = `${50 + Math.sin(angle * Math.PI / 180) * radius}px`;
                        break;
                    case 'lines':
                        element.style.width = '2px';
                        element.style.height = '40px';
                        element.style.background = `linear-gradient(to top, #4ecdc4, #556ee6)`;
                        element.style.margin = '0 4px';
                        break;
                    case 'spectrum':
                        element.style.width = '4px';
                        element.style.height = '15px';
                        element.style.background = `hsl(${index * 5.6}, 70%, 60%)`;
                        element.style.margin = '0 1px';
                        element.style.borderRadius = '2px 2px 0 0';
                        break;
                    case 'fire':
                        element.style.width = '10px';
                        element.style.height = '25px';
                        element.style.background = `linear-gradient(to top, #ff4444, #ffaa00, #ffff44)`;
                        element.style.margin = '0 2px';
                        element.style.borderRadius = '50% 50% 0 0';
                        element.style.filter = 'blur(1px)';
                        break;
                }
            });
        }

        // Party Mode Toggle
        function togglePartyMode() {
            const btn = document.getElementById('partyToggle');
            const isActive = btn.classList.contains('active');
            
            if (isActive) {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-play"></i> Party starten';
                // Party-Modus deaktiviert
            } else {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-stop"></i> Party stoppen';
                // Party-Modus aktiviert
            }
        }

        // Professional DJ Crossfading Controls
        document.getElementById('overlapTime').addEventListener('input', function() {
            document.getElementById('overlapTimeValue').textContent = this.value + 's';
            // DJ Crossfade-Zeit geändert
        });

        document.getElementById('seamlessTransition').addEventListener('change', function() {
            const allControls = ['crossfadeType', 'autoDetect', 'beatMatching', 'preCue'];
            allControls.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.disabled = !this.checked;
            });
            
            if (!this.checked) {
                document.getElementById('preCue').checked = false;
                document.getElementById('preCue').dispatchEvent(new Event('change'));
            }
            
            // Nahtlose DJ-Überblendung geändert
        });

        document.getElementById('crossfadeType').addEventListener('change', function() {
            console.log(`🎧 Crossfade-Typ: ${this.value}`);
        });

        document.getElementById('autoDetect').addEventListener('change', function() {
            console.log(`🎧 Auto-Erkennung Song-Ende: ${this.checked ? 'aktiviert' : 'deaktiviert'}`);
        });

        document.getElementById('beatMatching').addEventListener('change', function() {
            console.log(`🎧 Beat-Matching: ${this.checked ? 'aktiviert' : 'deaktiviert'}`);
        });

        // Pre-Cue Controls
        // Pre-Cue Volume Controls ENTFERNT - nutze System-Lautstärke
        
        // ✅ HELPER FUNCTIONS FÜR TASKBAR
        function initializeEqualizer() {
            // Equalizer ist bereits in der DOM vorhanden
            const eqToggle = document.getElementById('eqToggle');
            if (eqToggle && !eqToggle.checked) {
                eqToggle.checked = true;
                eqToggle.dispatchEvent(new Event('change'));
            }
        }
        
        let isVisualizerRunning = false;
        let visualizerAnimationFrame = null;
        
        function initializeVisualizer() {
            console.log('🌈 Initialisiere Visualizer...');
            const container = document.getElementById('visualizerBars');
            if (!container) return;
            
            // Erstelle Visualizer-Bars falls noch nicht vorhanden
            if (container.children.length === 0) {
                for (let i = 0; i < 64; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'vis-bar';
                    bar.style.cssText = 'width: 8px; height: 20px; background: linear-gradient(180deg, #4ecdc4, #44a3aa); margin: 0 2px; border-radius: 4px 4px 0 0; transition: height 0.1s ease;';
                    container.appendChild(bar);
                }
            }
        }
        
        function startVisualizer() {
            if (!audioContext || !analyser) {
                console.warn('⚠️ Audio-Context nicht verfügbar');
                return;
            }
            
            isVisualizerRunning = true;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function animate() {
                if (!isVisualizerRunning) return;
                
                visualizerAnimationFrame = requestAnimationFrame(animate);
                analyser.getByteFrequencyData(dataArray);
                
                const bars = document.querySelectorAll('#visualizerBars .vis-bar');
                bars.forEach((bar, i) => {
                    const height = (dataArray[i] / 255) * 100;
                    bar.style.height = `${height}%`;
                });
            }
            
            animate();
            console.log('✅ Visualizer gestartet');
        }
        
        function stopVisualizer() {
            isVisualizerRunning = false;
            if (visualizerAnimationFrame) {
                cancelAnimationFrame(visualizerAnimationFrame);
            }
        }
        
        function initializeLEDMusicSync() {
            console.log('💡 Initialisiere LED-Musik-Sync...');
            const toggle = document.getElementById('ledMusicToggle');
            if (toggle && !toggle.checked) {
                toggle.checked = true;
                toggle.dispatchEvent(new Event('change'));
            }
            // Starte LED-Musik-Analyse
            if (typeof startLEDMusicAnalysis === 'function') {
                startLEDMusicAnalysis();
            }
        }
        
        function loadSettings() {
            // Einstellungen Panel aktivieren
            console.log('⚙️ Einstellungen geladen');
        }

        // ===== ERWEITERTE PARTY MODE FEATURES =====
        
        let advancedPartyModeActive = false;
        let beatDetectionData = {
            lastBeat: 0,
            colorPosition: 0,
            energyLevel: 0,
            currentMood: 'neutral',
            detectedGenre: 'unknown'
        };

        // Erweiterte LED Sync Controls
        document.getElementById('sensitivity').addEventListener('input', function() {
            document.getElementById('sensitivityValue').textContent = this.value;
            console.log(`🎚️ LED Sensitivität: ${this.value}/10`);
        });

        document.getElementById('responseSpeed').addEventListener('input', function() {
            document.getElementById('responseSpeedValue').textContent = this.value;
            console.log(`⚡ Reaktionsgeschwindigkeit: ${this.value}/10`);
        });

        document.getElementById('beatThreshold').addEventListener('input', function() {
            document.getElementById('beatThresholdValue').textContent = this.value;
            console.log(`💓 Beat-Erkennungsschwelle: ${this.value}`);
        });

        document.getElementById('colorMode').addEventListener('change', function() {
            console.log(`🎨 LED Farbmodus: ${this.value}`);
            if (this.value === 'adaptive') {
                enableAIColorAnalysis();
            }
        });

        document.getElementById('frequencyRange').addEventListener('change', function() {
            console.log(`🎵 Frequenzbereich: ${this.value}`);
            adjustFrequencyAnalysis(this.value);
        });

        // KI-Features Toggle
        document.getElementById('aiMoodDetection').addEventListener('change', function() {
            if (this.checked) {
                console.log('🎭 KI-Stimmungserkennung aktiviert');
                startMoodDetection();
            } else {
                console.log('🎭 KI-Stimmungserkennung deaktiviert');
            }
        });

        document.getElementById('aiGenreDetection').addEventListener('change', function() {
            if (this.checked) {
                console.log('🎼 KI-Genre-Erkennung aktiviert');
                startGenreDetection();
            } else {
                console.log('🎼 KI-Genre-Erkennung deaktiviert');
            }
        });

        document.getElementById('aiEnergyMatching').addEventListener('change', function() {
            if (this.checked) {
                console.log('⚡ Energie-Anpassung aktiviert');
                startEnergyMatching();
            } else {
                console.log('⚡ Energie-Anpassung deaktiviert');
            }
        });

        document.getElementById('aiColorHarmony').addEventListener('change', function() {
            if (this.checked) {
                console.log('🎨 Farb-Harmonie aktiviert');
                startColorHarmony();
            } else {
                console.log('🎨 Farb-Harmonie deaktiviert');
            }
        });

        function toggleAdvancedPartyMode() {
            advancedPartyModeActive = !advancedPartyModeActive;
            const btn = document.getElementById('advancedPartyToggle');
            
            if (advancedPartyModeActive) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-stop"></i> KI-Analyse stoppen';
                startAdvancedPartyMode();
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-magic"></i> Erweiterte KI-Analyse starten';
                stopAdvancedPartyMode();
            }
        }

        function startAdvancedPartyMode() {
            console.log('🤖 Erweiterte KI-gestützte Party-Analyse gestartet');
            
            // Starte verschiedene Analyseprozesse
            if (document.getElementById('aiMoodDetection').checked) {
                startMoodDetection();
            }
            
            if (document.getElementById('aiGenreDetection').checked) {
                startGenreDetection();
            }
            
            if (document.getElementById('aiEnergyMatching').checked) {
                startEnergyMatching();
            }
            
            if (document.getElementById('aiColorHarmony').checked) {
                startColorHarmony();
            }

            // Starte Beat-Detection
            startBeatDetection();
            
            // Starte adaptive Farbanalyse
            startAdaptiveColorAnalysis();
        }

        // Global Interval Management für Memory Leak Prevention
        const globalIntervals = {
            moodDetection: null,
            genreDetection: null,
            energyMatching: null,
            colorHarmony: null,
            beatDetection: null,
            adaptiveColor: null,
            aiColorAnalysis: null
        };

        function stopAdvancedPartyMode() {
            console.log('🛑 Erweiterte Party-Analyse gestoppt');
            advancedPartyModeActive = false;
            
            // ✅ CLEANUP: Alle Intervals stoppen
            Object.keys(globalIntervals).forEach(key => {
                if (globalIntervals[key]) {
                    clearInterval(globalIntervals[key]);
                    globalIntervals[key] = null;
                    console.log(`🧹 ${key} Interval gestoppt`);
                }
            });
        }

        let moodDetectionInterval = null;
        
        function startMoodDetection() {
            console.log('🎭 Starte KI-Stimmungserkennung...');
            
            // Clear existing interval
            if (moodDetectionInterval) clearInterval(moodDetectionInterval);
            
            // Simuliere Stimmungserkennung
            moodDetectionInterval = setInterval(() => {
                if (!advancedPartyModeActive) {
                    clearInterval(moodDetectionInterval);
                    moodDetectionInterval = null;
                    return;
                }
                
                const moods = ['energetic', 'relaxed', 'romantic', 'aggressive', 'melancholic', 'euphoric'];
                const currentMood = moods[Math.floor(Math.random() * moods.length)];
                
                console.log(`🎭 Erkannte Stimmung: ${currentMood}`);
                document.getElementById('detectedMood').textContent = currentMood;
            }, 3000);
        }

        function startGenreDetection() {
            console.log('🎼 Starte KI-Genre-Erkennung...');
            
            setInterval(() => {
                if (!advancedPartyModeActive) return;
                
                const genres = ['rock', 'pop', 'electronic', 'jazz', 'classical', 'hip-hop', 'ambient'];
                const detectedGenre = genres[Math.floor(Math.random() * genres.length)];
                
                if (detectedGenre !== beatDetectionData.detectedGenre) {
                    beatDetectionData.detectedGenre = detectedGenre;
                    console.log(`🎼 Genre erkannt: ${detectedGenre}`);
                    adaptEffectsToGenre(detectedGenre);
                }
            }, 8000);
        }

        function startEnergyMatching() {
            console.log('⚡ Starte Energie-Anpassung...');
            
            setInterval(() => {
                if (!advancedPartyModeActive) return;
                
                // Simuliere Energie-Erkennung (0-100)
                const energyLevel = Math.floor(Math.random() * 100);
                beatDetectionData.energyLevel = energyLevel;
                
                console.log(`⚡ Energie-Level: ${energyLevel}%`);
                adaptSpeedToEnergy(energyLevel);
            }, 2000);
        }

        function startColorHarmony() {
            console.log('🎨 Starte Farb-Harmonie-Analyse...');
            
            setInterval(() => {
                if (!advancedPartyModeActive) return;
                
                // Berechne harmonische Farbkombinationen
                const harmonicColors = generateHarmonicColors();
                console.log('🎨 Harmonische Farben generiert:', harmonicColors);
                applyHarmonicColors(harmonicColors);
            }, 3000);
        }

        function startBeatDetection() {
            console.log('💓 Starte Beat-Detection...');
            
            setInterval(() => {
                if (!advancedPartyModeActive || !isPlaying) return;
                
                // Simuliere Beat-Detection
                const beatDetected = Math.random() > 0.7; // 30% Chance für Beat
                
                if (beatDetected) {
                    const now = Date.now();
                    beatDetectionData.lastBeat = now;
                    console.log('💓 Beat erkannt!');
                    triggerBeatResponse();
                }
            }, 200);
        }

        function startAdaptiveColorAnalysis() {
            console.log('🤖 Starte adaptive Farbanalyse...');
            
            setInterval(() => {
                if (!advancedPartyModeActive) return;
                
                // Analysiere aktuelle Musik-Frequenzen für adaptive Farben
                analyzeFrequenciesForColors();
            }, 500);
        }

        function adaptColorsToMood(mood) {
            const moodColors = {
                'energetic': ['#ff6b6b', '#feca57', '#ff9ff3'],
                'relaxed': ['#48cae4', '#90e0ef', '#caf0f8'],
                'romantic': ['#f8bbd9', '#f4a6d7', '#e29cc6'],
                'aggressive': ['#ef476f', '#f72585', '#c77dff'],
                'melancholic': ['#6c5ce7', '#a29bfe', '#74b9ff'],
                'euphoric': ['#00b894', '#00cec9', '#55efc4']
            };
            
            const colors = moodColors[mood] || moodColors['energetic'];
            console.log(`🎨 Farben für Stimmung "${mood}":`, colors);
        }

        function adaptEffectsToGenre(genre) {
            const genreEffects = {
                'rock': ['strobe', 'lightning', 'energy'],
                'pop': ['pulse', 'wave', 'sparkle'],
                'electronic': ['spectrum', 'digital', 'neon'],
                'jazz': ['smooth', 'flow', 'ambient'],
                'classical': ['elegant', 'crescendo', 'harmony'],
                'hip-hop': ['beat', 'urban', 'dynamic'],
                'ambient': ['fade', 'breath', 'gentle']
            };
            
            const effects = genreEffects[genre] || genreEffects['pop'];
            console.log(`✨ Effekte für Genre "${genre}":`, effects);
        }

        function adaptSpeedToEnergy(energyLevel) {
            // Geschwindigkeit basierend auf Energie anpassen
            const speed = Math.floor((energyLevel / 100) * 10) + 1;
            console.log(`⚡ Angepasste Geschwindigkeit: ${speed}/10 (Energie: ${energyLevel}%)`);
        }

        function generateHarmonicColors() {
            // Generiere harmonische Farbkombinationen
            const baseHue = Math.floor(Math.random() * 360);
            return [
                `hsl(${baseHue}, 70%, 60%)`,
                `hsl(${(baseHue + 120) % 360}, 70%, 60%)`,
                `hsl(${(baseHue + 240) % 360}, 70%, 60%)`
            ];
        }

        function applyHarmonicColors(colors) {
            console.log('🎨 Wende harmonische Farben an:', colors);
        }

        function triggerBeatResponse() {
            // Beat-responsive LED-Reaktion
            beatDetectionData.colorPosition = (beatDetectionData.colorPosition + 30) % 360;
            console.log(`💓 Beat-Response: Farbposition ${beatDetectionData.colorPosition}°`);
        }

        function analyzeFrequenciesForColors() {
            // Analysiere Frequenzen für adaptive Farbauswahl
            const frequencies = {
                bass: Math.random() * 100,
                mid: Math.random() * 100,
                treble: Math.random() * 100
            };
            
            // Konvertiere Frequenzen zu Farben
            const bassColor = Math.floor((frequencies.bass / 100) * 360);
            const midColor = Math.floor((frequencies.mid / 100) * 360);
            const trebleColor = Math.floor((frequencies.treble / 100) * 360);
            
            if (Math.random() > 0.9) { // Nur gelegentlich loggen
                console.log(`🎵 Frequenz-zu-Farbe: Bass→${bassColor}° Mid→${midColor}° Treble→${trebleColor}°`);
            }
        }

        function adjustFrequencyAnalysis(range) {
            console.log(`🎵 Frequenzanalyse angepasst auf: ${range}`);
            
            const rangeSettings = {
                'bass': { min: 20, max: 250, emphasis: 'low' },
                'mid': { min: 250, max: 2000, emphasis: 'mid' },
                'treble': { min: 2000, max: 20000, emphasis: 'high' },
                'full': { min: 20, max: 20000, emphasis: 'balanced' }
            };
            
            const settings = rangeSettings[range];
            console.log(`🔊 Analysiere ${settings.min}-${settings.max}Hz mit ${settings.emphasis} Betonung`);
        }

        function enableAIColorAnalysis() {
            console.log('🤖 KI-Farbanalyse aktiviert - Analysiere Musikfarben...');
            
            // Starte kontinuierliche Farbanalyse
            setInterval(() => {
                if (document.getElementById('colorMode').value !== 'adaptive') return;
                
                // Simuliere KI-Farbanalyse
                const aiSuggestedColors = generateAIColors();
                console.log('🤖 KI-generierte Farben:', aiSuggestedColors);
            }, 1000);
        }

        function generateAIColors() {
            // Simuliere KI-basierte Farbgenerierung
            const colorSchemes = [
                ['#ff6b6b', '#4ecdc4', '#45b7d1'],
                ['#f9ca24', '#f0932b', '#eb4d4b'],
                ['#6c5ce7', '#a29bfe', '#fd79a8'],
                ['#00b894', '#55efc4', '#81ecec'],
                ['#e17055', '#fdcb6e', '#fd79a8']
            ];
            
            return colorSchemes[Math.floor(Math.random() * colorSchemes.length)];
        }

        // ===== ENDE ERWEITERTE PARTY MODE FEATURES =====

        // ✅ LED-MUSIK MIT ECHTER HARDWARE-STEUERUNG
        document.getElementById('ledMusicToggle').addEventListener('change', async function() {
            if (this.checked) {
                // LED-Sync aktivieren
                if (window.parent?.ledDevice && window.parent.ledDevice.isConnected) {
                    // Aktiviere Musik-Modus auf Hardware
                    const cmd = new Uint8Array([0x7E, 0x00, 0x10, 0x01, 0x00, 0x00, 0x00, 0xEF]); // Music mode ON
                    await window.parent.ledDevice.characteristic.writeValue(cmd);
                }
                console.log('✅ LED-Musik-Hardware aktiviert');
            } else {
                // LED-Sync deaktivieren
                if (window.parent?.ledDevice && window.parent.ledDevice.isConnected) {
                    // Deaktiviere Musik-Modus
                    const cmd = new Uint8Array([0x7E, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0xEF]); // Music mode OFF
                    await window.parent.ledDevice.characteristic.writeValue(cmd);
                }
                console.log('⏹️ LED-Musik-Hardware deaktiviert');
            }
        });

        // Next/Previous Track Functions
        function playNext() {
            if (playlist.length === 0) {
                console.log('📭 Keine Playlist verfügbar');
                return;
            }
            
            currentTrackIndex++;
            if (currentTrackIndex >= playlist.length) {
                currentTrackIndex = 0;
            }
            
            loadTrack(currentTrackIndex);
            audioPlayer.play();
            isPlaying = true;
            
            // ✅ Aktualisiere Media Session
            updateMediaSession();
            updatePlaybackState('playing');
            savePlayerState();
            
            console.log(`⏭️ Nächster Titel: ${playlist[currentTrackIndex].name}`);
        }

        function playPrevious() {
            if (playlist.length === 0) {
                console.log('📭 Keine Playlist verfügbar');
                return;
            }
            
            if (isShuffleMode) {
                // Random previous track
                currentTrackIndex = Math.floor(Math.random() * playlist.length);
            } else {
                // Sequential previous track
                currentTrackIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : playlist.length - 1;
            }
            
            loadTrack(currentTrackIndex);
            if (isPlaying) {
                audioPlayer.play();
            }
            console.log(`⏮️ Vorheriger Titel: ${playlist[currentTrackIndex].name}`);
        }

        // ✅ DOPPELTER DOMCONTENTLOADED ENTFERNT - Initialisierung erfolgt in Haupt-DOMContentLoaded (Zeile 5267)

        // Animate visualizer elements based on audio or random data
        function animateVisualizer() {
            const elements = document.querySelectorAll('.visualizer-element');
            
            elements.forEach((element, index) => {
                // Use audio data if available, otherwise use random data for demo
                let intensity = 0.5; // Default intensity
                
                if (audioContext && analyser && !audioPlayer.paused) {
                    // Use real audio data
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    intensity = dataArray[index % dataArray.length] / 255;
                } else {
                    // Use demo animation
                    intensity = Math.random() * 0.8 + 0.2;
                }
                
                // Apply animation based on visualizer type
                switch(currentVisualizerType) {
                    case 'bars':
                    case 'spectrum':
                    case 'lines':
                        element.style.transform = `scaleY(${intensity * 3 + 0.1})`;
                        break;
                    case 'waves':
                    case 'circles':
                        element.style.transform = `scale(${intensity * 1.5 + 0.5})`;
                        break;
                    case 'particles':
                        element.style.transform = `translate(${(Math.random() - 0.5) * intensity * 20}px, ${(Math.random() - 0.5) * intensity * 20}px)`;
                        break;
                    case 'spiral':
                        element.style.transform = `rotate(${intensity * 360}deg) scale(${intensity + 0.5})`;
                        break;
                    case 'fire':
                        element.style.transform = `scaleY(${intensity * 2 + 0.3}) scaleX(${0.8 + intensity * 0.4})`;
                        element.style.opacity = intensity * 0.8 + 0.2;
                        break;
                }
                
                // Add color variation for some types
                if (['waves', 'particles', 'spiral'].includes(currentVisualizerType)) {
                    const hue = (index * 10 + Date.now() * 0.1) % 360;
                    element.style.background = `hsl(${hue}, 70%, ${50 + intensity * 30}%)`;
                }
            });
        }
        
        // ===== ID3 TAG PARSING & METADATA EXTRACTION =====
        
        // Enhanced metadata extraction with ID3 tag support
        async function extractMetadata(file) {
            const metadata = {
                title: file.name.replace(/\.[^/.]+$/, ""),
                artist: 'Unbekannter Künstler',
                album: 'Unbekanntes Album',
                year: null,
                genre: null,
                duration: 0,
                albumArt: null,
                trackNumber: null,
                bitrate: null,
                sampleRate: null
            };
            
            try {
                // Create audio element to get duration
                const audio = new Audio();
                const url = URL.createObjectURL(file);
                audio.src = url;
                
                await new Promise((resolve, reject) => {
                    audio.addEventListener('loadedmetadata', resolve);
                    audio.addEventListener('error', reject);
                });
                
                metadata.duration = audio.duration;
                URL.revokeObjectURL(url);
                
                // Parse ID3 tags if available
                if (file.type.includes('audio/')) {
                    const id3Data = await parseID3Tags(file);
                    if (id3Data) {
                        Object.assign(metadata, id3Data);
                    }
                }
                
                console.log('🏷️ Metadaten extrahiert:', metadata);
                return metadata;
                
            } catch (error) {
                console.warn('⚠️ Fehler beim Extrahieren der Metadaten:', error);
                return metadata;
            }
        }
        
        // ID3 tag parsing function
        async function parseID3Tags(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const buffer = e.target.result;
                    const view = new DataView(buffer);
                    
                    try {
                        // Check for ID3v2 header
                        if (view.getUint8(0) === 0x49 && view.getUint8(1) === 0x44 && view.getUint8(2) === 0x33) {
                            const id3Data = parseID3v2(view);
                            resolve(id3Data);
                        } else {
                            // Check for ID3v1 at end of file
                            const id3Data = parseID3v1(view);
                            resolve(id3Data);
                        }
                    } catch (error) {
                        console.warn('⚠️ ID3 Parsing Fehler:', error);
                        resolve(null);
                    }
                };
                reader.readAsArrayBuffer(file.slice(0, Math.min(file.size, 1024 * 1024))); // Read first 1MB
            });
        }
        
        // Parse ID3v2 tags
        function parseID3v2(view) {
            const metadata = {};
            let offset = 10; // Skip ID3v2 header
            
            // Get tag size
            const tagSize = ((view.getUint8(6) & 0x7F) << 21) |
                           ((view.getUint8(7) & 0x7F) << 14) |
                           ((view.getUint8(8) & 0x7F) << 7) |
                           (view.getUint8(9) & 0x7F);
            
            while (offset < tagSize && offset < view.byteLength - 10) {
                // Read frame header
                const frameId = String.fromCharCode(
                    view.getUint8(offset), view.getUint8(offset + 1),
                    view.getUint8(offset + 2), view.getUint8(offset + 3)
                );
                
                if (frameId === '\0\0\0\0') break;
                
                const frameSize = view.getUint32(offset + 4);
                if (frameSize === 0 || offset + frameSize > view.byteLength) break;
                
                const frameData = new Uint8Array(view.buffer, offset + 10, frameSize);
                
                // Parse common frames
                switch (frameId) {
                    case 'TIT2': // Title
                        metadata.title = decodeTextFrame(frameData);
                        break;
                    case 'TPE1': // Artist
                        metadata.artist = decodeTextFrame(frameData);
                        break;
                    case 'TALB': // Album
                        metadata.album = decodeTextFrame(frameData);
                        break;
                    case 'TYER': // Year
                    case 'TDRC': // Recording date
                        metadata.year = parseInt(decodeTextFrame(frameData));
                        break;
                    case 'TCON': // Genre
                        metadata.genre = decodeTextFrame(frameData);
                        break;
                    case 'TRCK': // Track number
                        metadata.trackNumber = parseInt(decodeTextFrame(frameData));
                        break;
                    case 'APIC': // Album art
                        metadata.albumArt = extractAlbumArt(frameData);
                        break;
                }
                
                offset += 10 + frameSize;
            }
            
            return metadata;
        }
        
        // Parse ID3v1 tags (fallback)
        function parseID3v1(view) {
            const metadata = {};
            const offset = view.byteLength - 128;
            
            if (offset >= 0 && 
                view.getUint8(offset) === 0x54 && // 'T'
                view.getUint8(offset + 1) === 0x41 && // 'A'
                view.getUint8(offset + 2) === 0x47) { // 'G'
                
                metadata.title = decodeString(view, offset + 3, 30).trim();
                metadata.artist = decodeString(view, offset + 33, 30).trim();
                metadata.album = decodeString(view, offset + 63, 30).trim();
                metadata.year = parseInt(decodeString(view, offset + 93, 4));
                
                const genreIndex = view.getUint8(offset + 127);
                if (genreIndex < id3Genres.length) {
                    metadata.genre = id3Genres[genreIndex];
                }
            }
            
            return metadata;
        }
        
        // Decode text frame with encoding detection
        function decodeTextFrame(data) {
            if (data.length === 0) return '';
            
            const encoding = data[0];
            const textData = data.slice(1);
            
            switch (encoding) {
                case 0: // ISO-8859-1
                    return new TextDecoder('iso-8859-1').decode(textData);
                case 1: // UTF-16 with BOM
                    return new TextDecoder('utf-16').decode(textData);
                case 2: // UTF-16BE
                    return new TextDecoder('utf-16be').decode(textData);
                case 3: // UTF-8
                    return new TextDecoder('utf-8').decode(textData);
                default:
                    return new TextDecoder('utf-8').decode(textData);
            }
        }
        
        // Decode string from DataView
        function decodeString(view, offset, length) {
            let result = '';
            for (let i = 0; i < length; i++) {
                const char = view.getUint8(offset + i);
                if (char === 0) break;
                result += String.fromCharCode(char);
            }
            return result;
        }
        
        // Extract album art from APIC frame
        function extractAlbumArt(data) {
            try {
                let offset = 1; // Skip encoding byte
                
                // Skip MIME type (null-terminated)
                while (offset < data.length && data[offset] !== 0) offset++;
                offset++; // Skip null terminator
                
                // Skip picture type
                offset++;
                
                // Skip description (null-terminated)
                while (offset < data.length && data[offset] !== 0) offset++;
                offset++; // Skip null terminator
                
                // Remaining data is the image
                const imageData = data.slice(offset);
                const blob = new Blob([imageData], { type: 'image/jpeg' });
                return URL.createObjectURL(blob);
                
            } catch (error) {
                console.warn('⚠️ Fehler beim Extrahieren des Albumcovers:', error);
                return null;
            }
        }
        
        // ID3v1 genre list
        const id3Genres = [
            'Blues', 'Classic Rock', 'Country', 'Dance', 'Disco', 'Funk', 'Grunge', 'Hip-Hop',
            'Jazz', 'Metal', 'New Age', 'Oldies', 'Other', 'Pop', 'R&B', 'Rap', 'Reggae', 'Rock',
            'Techno', 'Industrial', 'Alternative', 'Ska', 'Death Metal', 'Pranks', 'Soundtrack',
            'Euro-Techno', 'Ambient', 'Trip-Hop', 'Vocal', 'Jazz+Funk', 'Fusion', 'Trance',
            'Classical', 'Instrumental', 'Acid', 'House', 'Game', 'Sound Clip', 'Gospel', 'Noise',
            'Alternative Rock', 'Bass', 'Soul', 'Punk', 'Space', 'Meditative', 'Instrumental Pop',
            'Instrumental Rock', 'Ethnic', 'Gothic', 'Darkwave', 'Techno-Industrial', 'Electronic',
            'Pop-Folk', 'Eurodance', 'Dream', 'Southern Rock', 'Comedy', 'Cult', 'Gangsta',
            'Top 40', 'Christian Rap', 'Pop/Funk', 'Jungle', 'Native US', 'Cabaret', 'New Wave',
            'Psychadelic', 'Rave', 'Showtunes', 'Trailer', 'Lo-Fi', 'Tribal', 'Acid Punk',
            'Acid Jazz', 'Polka', 'Retro', 'Musical', 'Rock & Roll', 'Hard Rock'
        ];
        
        // Enhanced file loading with metadata extraction
        async function loadMusicFiles(files) {
            const loadedTracks = [];
            const progressContainer = document.getElementById('loadingProgress');
            
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                try {
                    // Extract metadata
                    const metadata = await extractMetadata(file);
                    
                    // Create track object
                    const track = {
                        name: metadata.title,
                        artist: metadata.artist,
                        album: metadata.album,
                        year: metadata.year,
                        genre: metadata.genre,
                        duration: metadata.duration,
                        trackNumber: metadata.trackNumber,
                        albumArt: metadata.albumArt,
                        url: URL.createObjectURL(file),
                        file: file,
                        isFavorite: false,
                        playCount: 0,
                        lastPlayed: null,
                        dateAdded: new Date().toISOString()
                    };
                    
                    loadedTracks.push(track);
                    
                    // Update progress
                    const progress = ((i + 1) / files.length) * 100;
                    updateLoadingProgress(progress, `${metadata.title} - ${metadata.artist}`);
                    
                } catch (error) {
                    console.warn('⚠️ Fehler beim Laden der Datei:', file.name, error);
                }
            }
            
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            // Add to playlist
            playlist.push(...loadedTracks);
            updateSongList();
            savePlaylist();
            
            console.log(`🎵 ${loadedTracks.length} Tracks mit Metadaten geladen`);
            return loadedTracks;
        }
        
        // Update loading progress display
        function updateLoadingProgress(percentage, currentTrack) {
            const progressBar = document.getElementById('loadingProgressBar');
            const progressText = document.getElementById('loadingProgressText');
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            
            if (progressText) {
                progressText.textContent = `${Math.round(percentage)}% - ${currentTrack}`;
            }
        }
        
        // Enhanced track display with album art - XSS-sicher
        function createTrackElement(track, index) {
            const trackElement = document.createElement('div');
            trackElement.className = 'song-item';
            trackElement.setAttribute('data-track-index', index);
            trackElement.onclick = () => selectSong(trackElement);
            trackElement.oncontextmenu = (e) => showSongMenu(e, trackElement);
            
            // Sichere Album Art URL Validierung
            let albumArt = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%234ecdc4"/><text x="50" y="55" text-anchor="middle" fill="white" font-size="30">♪</text></svg>';
            if (track.albumArt && (track.albumArt.startsWith('data:image/') || track.albumArt.startsWith('blob:'))) {
                albumArt = track.albumArt;
            }
            
            // Song icon container
            const songIcon = document.createElement('div');
            songIcon.className = 'song-icon';
            songIcon.style.cssText = `background-image: url('${albumArt}'); background-size: cover; background-position: center; width: 40px; height: 40px; border-radius: 5px;`;
            if (!track.albumArt) {
                songIcon.textContent = '🎵';
            }
            
            // Song details container
            const songDetails = document.createElement('div');
            songDetails.className = 'song-details';
            songDetails.style.cssText = 'flex: 1; min-width: 0;';
            
            // Song name
            const songName = document.createElement('div');
            songName.className = 'song-name';
            songName.style.cssText = 'font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
            songName.textContent = sanitizeText(track.name || 'Unbekannter Titel');
            
            // Song artist
            const songArtist = document.createElement('div');
            songArtist.className = 'song-artist';
            songArtist.style.cssText = 'font-size: 0.9em; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
            songArtist.textContent = sanitizeText(track.artist || 'Unbekannter Künstler');
            
            // Song meta
            const songMeta = document.createElement('div');
            songMeta.className = 'song-meta';
            songMeta.style.cssText = 'font-size: 0.8em; color: #666; margin-top: 2px;';
            let metaText = '';
            if (track.album) metaText += sanitizeText(track.album);
            if (track.year) metaText += ` (${track.year})`;
            if (track.duration) metaText += ` • ${formatDuration(track.duration)}`;
            songMeta.textContent = metaText;
            
            songDetails.appendChild(songName);
            songDetails.appendChild(songArtist);
            songDetails.appendChild(songMeta);
            
            // Song actions container
            const songActions = document.createElement('div');
            songActions.className = 'song-actions';
            songActions.style.cssText = 'display: flex; align-items: center; gap: 5px;';
            
            if (track.isFavorite) {
                const heartIcon = document.createElement('i');
                heartIcon.className = 'fas fa-heart';
                heartIcon.style.color = '#e74c3c';
                songActions.appendChild(heartIcon);
            }
            
            if (track.playCount > 0) {
                const playCount = document.createElement('span');
                playCount.style.cssText = 'font-size: 0.8em; color: #888;';
                playCount.textContent = `${track.playCount}×`;
                songActions.appendChild(playCount);
            }
            
            trackElement.appendChild(songIcon);
            trackElement.appendChild(songDetails);
            trackElement.appendChild(songActions);
            
            return trackElement;
        }
        
        // Format duration helper
        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // ===== LYRICS DISPLAY FUNCTIONS =====
        
        // Toggle lyrics display
        function toggleLyrics() {
            const lyricsContainer = document.getElementById('lyricsContainer');
            const toggleBtn = document.getElementById('lyricsToggleBtn');
            
            if (lyricsContainer.style.display === 'none' || !lyricsContainer.style.display) {
                lyricsContainer.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Lyrics';
                loadLyricsForCurrentTrack();
            } else {
                lyricsContainer.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-file-alt"></i> Lyrics';
            }
        }
        
        // Load lyrics for current track
        async function loadLyricsForCurrentTrack() {
            if (!currentTrack) return;
            
            const lyricsContent = document.getElementById('lyricsContent');
            lyricsContent.innerHTML = '<div style="text-align: center; opacity: 0.6;"><i class="fas fa-spinner fa-spin"></i> Lade Liedtext...</div>';
            
            try {
                // Try to find LRC file
                const lrcFile = await findLRCFile(currentTrack);
                if (lrcFile) {
                    const lyrics = await parseLRCFile(lrcFile);
                    displaySyncedLyrics(lyrics);
                } else {
                    // Fallback to simple text display
                    displayStaticLyrics();
                }
            } catch (error) {
                console.warn('⚠️ Fehler beim Laden der Lyrics:', error);
                displayNoLyrics();
            }
        }
        
        // Display static lyrics placeholder - XSS-sicher
        function displayStaticLyrics() {
            const lyricsContent = document.getElementById('lyricsContent');
            if (!lyricsContent) return;
            
            // Sichere DOM-Erstellung ohne innerHTML
            lyricsContent.innerHTML = '';
            
            const placeholderDiv = document.createElement('div');
            placeholderDiv.className = 'lyrics-placeholder';
            placeholderDiv.style.cssText = 'opacity: 0.6; font-style: italic; text-align: center;';
            
            const musicIcon = document.createElement('i');
            musicIcon.className = 'fas fa-music';
            musicIcon.style.cssText = 'font-size: 2em; margin-bottom: 10px; display: block; color: #4ecdc4;';
            
            const mainText = document.createElement('div');
            mainText.textContent = 'Keine Liedtexte verfügbar';
            
            const subText = document.createElement('div');
            subText.style.cssText = 'font-size: 0.9em; margin-top: 5px;';
            subText.textContent = 'LRC-Dateien werden automatisch geladen';
            
            placeholderDiv.appendChild(musicIcon);
            placeholderDiv.appendChild(mainText);
            placeholderDiv.appendChild(subText);
            lyricsContent.appendChild(placeholderDiv);
        }
        
        // Display no lyrics message
        function displayNoLyrics() {
            displayStaticLyrics();
        }
        
        // Load saved playlist from localStorage
        function loadPlaylist() {
            try {
                const savedPlaylist = localStorage.getItem('musicPlayerPlaylist');
                if (savedPlaylist) {
                    const parsedPlaylist = JSON.parse(savedPlaylist);
                    if (Array.isArray(parsedPlaylist)) {
                        playlist = parsedPlaylist;
                        updatePlaylistUI();
                        console.log(`✅ Playlist geladen: ${playlist.length} Tracks`);
                    }
                }
                
                // Load current track index
                const savedIndex = localStorage.getItem('currentTrackIndex');
                if (savedIndex !== null) {
                    currentTrackIndex = parseInt(savedIndex, 10) || 0;
                }
                
                // Load player settings
                const savedSettings = localStorage.getItem('playerSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    // Volume ist fest auf 0.7 gesetzt - keine Slider mehr
                    audioPlayer.volume = 0.7;
                    if (settings.isShuffleMode !== undefined) {
                        isShuffleMode = settings.isShuffleMode;
                        document.getElementById('shuffleBtn').classList.toggle('active', isShuffleMode);
                    }
                    if (settings.repeatMode !== undefined) {
                        repeatMode = settings.repeatMode;
                        updateRepeatButton();
                    }
                }
            } catch (error) {
                console.error('❌ Fehler beim Laden der Playlist:', error);
                playlist = [];
            }
        }
        
        // ===== SETTINGS PANEL FUNCTIONS =====
        
        // Backup settings to JSON file
        function backupSettings() {
            try {
                const backupData = {
                    playlist: playlist,
                    currentTrackIndex: currentTrackIndex,
                    playerSettings: {
                        volume: audioPlayer.volume,
                        isShuffleMode: isShuffleMode,
                        repeatMode: repeatMode
                    },
                    equalizerSettings: getEqualizerSettings(),
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `musik-backup-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('✅ Backup erfolgreich erstellt');
            } catch (error) {
                console.error('❌ Fehler beim Erstellen des Backups:', error);
                alert('Fehler beim Erstellen des Backups!');
            }
        }
        
        // Restore settings from JSON file
        function restoreSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validate backup structure
                        if (!backupData.playlist || !Array.isArray(backupData.playlist)) {
                            throw new Error('Ungültiges Backup-Format');
                        }
                        
                        // Restore playlist
                        playlist = backupData.playlist;
                        currentTrackIndex = backupData.currentTrackIndex || 0;
                        
                        // Restore player settings
                        if (backupData.playerSettings) {
                            const settings = backupData.playerSettings;
                            // Volume ist fest auf 0.7 gesetzt - keine Slider mehr
                            audioPlayer.volume = 0.7;
                            if (settings.isShuffleMode !== undefined) {
                                isShuffleMode = settings.isShuffleMode;
                                document.getElementById('shuffleBtn').classList.toggle('active', isShuffleMode);
                            }
                            if (settings.repeatMode !== undefined) {
                                repeatMode = settings.repeatMode;
                                updateRepeatButton();
                            }
                        }
                        
                        // Update UI
                        updatePlaylistUI();
                        savePlaylist();
                        
                        console.log('✅ Backup erfolgreich wiederhergestellt');
                        alert('Backup erfolgreich wiederhergestellt!');
                    } catch (error) {
                        console.error('❌ Fehler beim Wiederherstellen:', error);
                        alert('Fehler beim Wiederherstellen des Backups!');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Export playlist to M3U format
        function exportPlaylist() {
            try {
                if (playlist.length === 0) {
                    alert('Keine Playlist zum Exportieren vorhanden!');
                    return;
                }
                
                let m3uContent = '#EXTM3U\n';
                playlist.forEach(track => {
                    m3uContent += `#EXTINF:${Math.floor(track.duration || 0)},${sanitizeText(track.artist || 'Unknown')} - ${sanitizeText(track.name || 'Unknown')}\n`;
                    m3uContent += `${track.url}\n`;
                });
                
                const blob = new Blob([m3uContent], { type: 'audio/x-mpegurl' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `playlist-${new Date().toISOString().slice(0, 10)}.m3u`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('✅ Playlist erfolgreich exportiert');
            } catch (error) {
                console.error('❌ Fehler beim Exportieren der Playlist:', error);
                alert('Fehler beim Exportieren der Playlist!');
            }
        }
        
        // Import playlist from M3U format
        function importPlaylist() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.m3u,.m3u8';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        const importedTracks = [];
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line.startsWith('#EXTINF:')) {
                                const nextLine = lines[i + 1]?.trim();
                                if (nextLine && !nextLine.startsWith('#')) {
                                    const match = line.match(/#EXTINF:(\d+),(.+)/);
                                    if (match) {
                                        const [, duration, info] = match;
                                        const [artist, title] = info.split(' - ');
                                        importedTracks.push({
                                            name: sanitizeText(title || 'Unknown'),
                                            artist: sanitizeText(artist || 'Unknown'),
                                            url: nextLine,
                                            duration: parseInt(duration) || 0,
                                            isFavorite: false,
                                            playCount: 0
                                        });
                                    }
                                    i++; // Skip URL line
                                }
                            }
                        }
                        
                        if (importedTracks.length > 0) {
                            playlist.push(...importedTracks);
                            updatePlaylistUI();
                            savePlaylist();
                            console.log(`✅ ${importedTracks.length} Tracks importiert`);
                            alert(`${importedTracks.length} Tracks erfolgreich importiert!`);
                        } else {
                            alert('Keine gültigen Tracks in der Playlist gefunden!');
                        }
                    } catch (error) {
                        console.error('❌ Fehler beim Importieren:', error);
                        alert('Fehler beim Importieren der Playlist!');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Show statistics
        function showStats() {
            const totalTracks = playlist.length;
            const totalDuration = playlist.reduce((sum, track) => sum + (track.duration || 0), 0);
            const favoriteCount = playlist.filter(track => track.isFavorite).length;
            const totalPlayCount = playlist.reduce((sum, track) => sum + (track.playCount || 0), 0);
            
            const artists = [...new Set(playlist.map(track => track.artist).filter(Boolean))];
            const albums = [...new Set(playlist.map(track => track.album).filter(Boolean))];
            
            const statsHtml = `
                <div style="background: rgba(0,0,0,0.8); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #2a2a2a; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="color: #4ecdc4; margin-bottom: 20px; text-align: center;">📊 Musik-Statistiken</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: rgba(78, 205, 196, 0.1); border-radius: 10px;">
                                <div style="font-size: 2em; color: #4ecdc4;">${totalTracks}</div>
                                <div style="font-size: 0.9em; color: #888;">Tracks</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(78, 205, 196, 0.1); border-radius: 10px;">
                                <div style="font-size: 2em; color: #4ecdc4;">${Math.floor(totalDuration / 3600)}h ${Math.floor((totalDuration % 3600) / 60)}m</div>
                                <div style="font-size: 0.9em; color: #888;">Gesamtdauer</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 10px;">
                                <div style="font-size: 2em; color: #e74c3c;">${favoriteCount}</div>
                                <div style="font-size: 0.9em; color: #888;">Favoriten</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 10px;">
                                <div style="font-size: 2em; color: #3498db;">${totalPlayCount}</div>
                                <div style="font-size: 0.9em; color: #888;">Wiedergaben</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="margin-bottom: 10px;"><strong>Künstler:</strong> ${artists.length}</div>
                            <div style="margin-bottom: 10px;"><strong>Alben:</strong> ${albums.length}</div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #4ecdc4; color: white; border: none; border-radius: 5px; cursor: pointer;">Schließen</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', statsHtml);
        }
        
        // Clear cache
        function clearCache() {
            if (confirm('Möchten Sie wirklich den gesamten Cache leeren? Dies entfernt alle gespeicherten Daten.')) {
                try {
                    localStorage.clear();
                    playlist = [];
                    currentTrackIndex = 0;
                    updatePlaylistUI();
                    console.log('✅ Cache erfolgreich geleert');
                    alert('Cache erfolgreich geleert!');
                } catch (error) {
                    console.error('❌ Fehler beim Leeren des Caches:', error);
                    alert('Fehler beim Leeren des Caches!');
                }
            }
        }
        
        // Reset to defaults
        function resetToDefaults() {
            if (confirm('Möchten Sie wirklich alle Einstellungen zurücksetzen?')) {
                try {
                    // Reset player settings
                    audioPlayer.volume = 0.7;
                    isShuffleMode = false;
                    repeatMode = 'none';
                    
                    // Reset UI
                    document.getElementById('shuffleBtn').classList.remove('active');
                    updateRepeatButton();
                    
                    // Save settings
                    savePlaylist();
                    
                    console.log('✅ Einstellungen zurückgesetzt');
                    alert('Einstellungen erfolgreich zurückgesetzt!');
                } catch (error) {
                    console.error('❌ Fehler beim Zurücksetzen:', error);
                    alert('Fehler beim Zurücksetzen der Einstellungen!');
                }
            }
        }
        
        // Get equalizer settings helper
        function getEqualizerSettings() {
            const settings = {};
            if (typeof eqFilters !== 'undefined' && eqFilters) {
                eqFilters.forEach((filter, index) => {
                    settings[`eq${index}`] = filter.gain.value;
                });
            }
            return settings;
        }
        
        // Load saved playlist on page load
        loadPlaylist();
        
    </script>
    
    <!-- Settings Panel -->
        <div class="content-panel" id="settings">
            <div class="panel-header">
                <i class="fas fa-cog"></i>
                <h2 class="panel-title">Einstellungen</h2>
            </div>
            
            <div style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Backup & Restore Sektion -->
                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-save"></i>
                        <h3>Backup & Restore</h3>
                    </div>
                    
                    <div class="section-content">
                        <div class="button-grid">
                            <button onclick="backupSettings()" class="action-btn success">
                                <i class="fas fa-download"></i> Backup erstellen
                            </button>
                            
                            <button onclick="restoreSettings()" class="action-btn info">
                                <i class="fas fa-upload"></i> Backup laden
                            </button>
                            
                            <button onclick="exportPlaylist()" class="action-btn warning">
                                <i class="fas fa-file-export"></i> Playlist exportieren
                            </button>
                            
                            <button onclick="importPlaylist()" class="action-btn">
                                <i class="fas fa-file-import"></i> Playlist importieren
                            </button>
                        </div>
                        
                        <div class="info-box">
                            <div class="info-box-title">Backup-Inhalt</div>
                            <div class="info-box-content">
                                Equalizer • Playlists • Favoriten • UI-Einstellungen • Bluetooth-Geräte • Performance-Optionen
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sleep-Timer & Zusatzfunktionen -->
                <div class="settings-section">
                    <div class="section-header">
                        <i class="fas fa-clock"></i>
                        <h3>Sleep-Timer & Zusatzfunktionen</h3>
                    </div>
                    <div class="section-content">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- Sleep Timer -->
                        <div>
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">😴 Sleep-Timer</h4>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="sleepTimerEnabled" style="transform: scale(1.2);">
                                <span style="font-weight: bold;">⏰ Sleep-Timer aktivieren</span>
                            </label>
                            
                            <div id="sleepTimerSettings" style="opacity: 0.5; pointer-events: none;">
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Dauer (Minuten):</label>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <input type="range" id="sleepTimerDuration" min="5" max="120" step="5" value="30" style="flex: 1;">
                                        <span id="sleepTimerDurationValue" style="min-width: 50px; font-size: 0.9em;">30min</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Aktion:</label>
                                    <select id="sleepTimerAction" style="width: 100%; padding: 6px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; font-size: 0.9em;">
                                        <option value="pause" selected>Pausieren</option>
                                        <option value="stop">Stoppen</option>
                                        <option value="fadeOut">Ausblenden</option>
                                    </select>
                                </div>
                                
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="sleepTimerShakeToExtend" style="transform: scale(1.1);">
                                    <span style="font-size: 0.9em;">📱 Schütteln verlängert Timer</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Wecker -->
                        <div>
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">⏰ Musik-Wecker</h4>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="musicAlarmEnabled" style="transform: scale(1.2);">
                                <span style="font-weight: bold;">🎵 Musik-Wecker aktivieren</span>
                            </label>
                            
                            <div id="musicAlarmSettings" style="opacity: 0.5; pointer-events: none;">
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Weckzeit:</label>
                                    <input type="time" id="alarmTime" style="width: 100%; padding: 6px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.9em;">Weck-Playlist:</label>
                                    <select id="alarmPlaylist" style="width: 100%; padding: 6px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; font-size: 0.9em;">
                                        <option value="current">Aktuelle Playlist</option>
                                        <option value="favorites">Favoriten</option>
                                        <option value="random">Zufällig</option>
                                        <option value="custom">Benutzerdefiniert</option>
                                    </select>
                                </div>
                                
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="alarmFadeIn" checked style="transform: scale(1.1);">
                                    <span style="font-size: 0.9em;">📈 Sanft einblenden</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scrobbling -->
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                        <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">📊 Scrobbling & Statistiken</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="lastFmScrobbling" style="transform: scale(1.2);">
                                    <span style="font-weight: bold;">🎵 Last.fm Scrobbling</span>
                                </label>
                                
                                <div id="lastFmSettings" style="opacity: 0.5; pointer-events: none;">
                                    <input type="text" id="lastFmUsername" placeholder="Last.fm Benutzername" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; margin-bottom: 8px; font-size: 0.9em;">
                                    <input type="password" id="lastFmPassword" placeholder="Last.fm Passwort" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; font-size: 0.9em;">
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="localStats" checked style="transform: scale(1.2);">
                                    <span style="font-weight: bold;">📈 Lokale Statistiken</span>
                                </label>
                                
                                <div style="font-size: 0.9em; color: #888; margin-bottom: 10px;">
                                    • Wiedergabe-Anzahl<br>
                                    • Hörzeit pro Track<br>
                                    • Top-Künstler & Alben<br>
                                    • Hörgewohnheiten
                                </div>
                                
                                <button onclick="showStats()" style="background: rgba(78, 205, 196, 0.2); color: #4ecdc4; border: 1px solid #4ecdc4; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                                    📊 Statistiken anzeigen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>    <!-- Bluetooth & System Integration -->
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-bluetooth"></i> Bluetooth & System</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <span style="font-weight: bold;">🎧 Headset-Steuerung aktivieren</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Play/Pause über Bluetooth-Kopfhörer</div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="notificationPlayer" checked style="transform: scale(1.2);">
                                <span style="font-weight: bold;">📱 Mini-Player in Benachrichtigungen</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Steuerung über Notification Bar</div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="lockscreenControl" checked style="transform: scale(1.2);">
                                <span style="font-weight: bold;">🔒 Sperrbildschirm-Steuerung</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Musiksteuerung ohne Entsperren</div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="autoConnect" style="transform: scale(1.2);">
                                <span style="font-weight: bold;">🔄 Auto-Connect Bluetooth</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888;">Automatisch mit bekannten Geräten verbinden</div>
                        </div>
                        
                        <!-- Erweiterte Notification Features -->
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">📱 Erweiterte Benachrichtigungen</h4>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="richNotifications" checked style="transform: scale(1.2);">
                                <span style="font-weight: bold;">🖼️ Rich Notifications</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Albumcover und erweiterte Steuerung</div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="persistentNotification" checked style="transform: scale(1.2);">
                                <span style="font-weight: bold;">📌 Dauerhafte Benachrichtigung</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Bleibt auch bei Pause sichtbar</div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="compactNotification" style="transform: scale(1.2);">
                                <span>📏 Kompakte Ansicht</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Weniger Platz in der Notification Bar</div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 8px;">🎨 Notification-Stil:</label>
                                <select id="notificationStyle" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                    <option value="modern" selected>Modern</option>
                                    <option value="classic">Klassisch</option>
                                    <option value="minimal">Minimal</option>
                                    <option value="custom">Benutzerdefiniert</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Widget Settings -->
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">🏠 Home-Screen Widgets</h4>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="smallWidget" style="transform: scale(1.2);">
                                <span style="font-weight: bold;">📱 Kleines Widget</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Aktueller Track + Play/Pause</div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="largeWidget" style="transform: scale(1.2);">
                                <span style="font-weight: bold;">📺 Großes Widget</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Playlist + Cover + Vollsteuerung</div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 8px;">🎨 Widget-Theme:</label>
                                <select id="widgetTheme" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                    <option value="dark" selected>Dunkel</option>
                                    <option value="light">Hell</option>
                                    <option value="transparent">Transparent</option>
                                    <option value="gradient">Gradient</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance & Erweiterte Einstellungen -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    
                    <!-- UI & Personalisierung -->
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-palette"></i> UI & Personalisierung</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="lyricsDisplay" checked style="transform: scale(1.2);">
                                <span style="font-weight: bold;">📝 Lyrics-Anzeige aktivieren</span>
                            </label>
                            <div style="font-size: 0.9em; color: #888; margin-bottom: 15px;">Zeige Liedtexte wenn verfügbar</div>
                            
                            <label style="display: block; margin-bottom: 8px;">🎨 Layout-Stil:</label>
                            <select id="layoutStyle" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; margin-bottom: 15px;">
                                <option value="compact">Kompakt</option>
                                <option value="standard" selected>Standard</option>
                                <option value="expanded">Erweitert</option>
                                <option value="grid">Grid-Ansicht</option>
                            </select>
                            
                            <label style="display: block; margin-bottom: 8px;">🌈 Farbschema:</label>
                            <select id="colorScheme" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; margin-bottom: 15px;">
                                <option value="dark" selected>Dunkel</option>
                                <option value="light">Hell</option>
                                <option value="auto">Automatisch</option>
                                <option value="custom">Benutzerdefiniert</option>
                            </select>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="animationsEnabled" checked style="transform: scale(1.2);">
                                <span>✨ Animationen aktivieren</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Performance & Fehlerbehandlung -->
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 15px;"><i class="fas fa-tachometer-alt"></i> Performance & Fehlerbehandlung</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">🧠 RAM & CPU Optimierung</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px;">RAM-Optimierung:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="range" id="ramOptimization" min="1" max="5" step="1" value="3" style="flex: 1;">
                                    <span id="ramOptimizationValue" style="min-width: 80px;">Normal</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px;">CPU-Priorität:</label>
                                <select id="cpuPriority" style="width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555;">
                                    <option value="low">Niedrig</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="high">Hoch</option>
                                    <option value="realtime">Echtzeit</option>
                                </select>
                            </div>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px;">
                                <input type="checkbox" id="backgroundOptimization" checked style="transform: scale(1.2);">
                                <span>🔋 Hintergrund-Optimierung</span>
                            </label>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                            <h4 style="color: #4ecdc4; margin-bottom: 10px; font-size: 1.1em;">🐛 Fehlerbehandlung</h4>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="autoErrorRecovery" checked style="transform: scale(1.2);">
                                <span>🔄 Automatische Fehlerkorrektur</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                <input type="checkbox" id="debugMode" style="transform: scale(1.2);">
                                <span>🐛 Debug-Modus aktivieren</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px;">
                                <input type="checkbox" id="errorLogging" style="transform: scale(1.2);">
                                <span>📝 Fehler-Protokollierung</span>
                            </label>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="clearCache()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                                    <i class="fas fa-trash"></i> Cache leeren
                                </button>
                                
                                <button onclick="resetToDefaults()" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                                    <i class="fas fa-undo"></i> Zurücksetzen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Music Library Manager & Integration -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="js/music-library-manager.js"></script>
    <script src="js/musik-integration.js"></script>
    <script src="js/audio-reactive-engine.js"></script>

    <!-- LED-Musik-Control Funktionen (Basic - AudioReactiveEngine in audio-reactive-engine.js) -->
    <script>
        // ✅ NOTIFICATION FUNKTION
        function showNotification(message, type = 'info') {
            // Erstelle temporäre Notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            // Setze Farbe basierend auf Typ
            switch(type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #2ed573, #26a664)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #ff4757, #ee2e45)';
                    break;
                case 'warning':
                    notification.style.background = 'linear-gradient(135deg, #ffa502, #ff7907)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #4ecdc4, #44a08d)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Entferne nach 3 Sekunden
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ✅ CSS ANIMATIONEN FÜR NOTIFICATIONS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            /* PANELS SICHTBAR MACHEN */
            .content-panel {
                display: none;
            }
            .content-panel.active {
                display: block !important;
            }
        `;
        document.head.appendChild(style);
        
        // LED-Musik-Steuerung Variablen
        let ledMusicAudioContext = null;
        let ledMusicAnalyser = null;
        let ledMusicDataArray = null;
        let ledMusicAnimationFrame = null;
        let ledMusicMode = 'spectrum';
        let ledMusicActive = false;

        // LED-Musik-Modus setzen
        function setLEDMusicMode(mode) {
            ledMusicMode = mode;
            console.log('🎵 LED-Musik-Modus:', mode);
            
            // Visuelles Feedback
            const buttons = document.querySelectorAll('.led-music-control-content .preset-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(mode)) {
                    btn.style.transform = 'scale(1.05)';
                    setTimeout(() => btn.style.transform = 'scale(1)', 200);
                }
            });
        }

        // LED-Musik-Analyse starten
        async function startLEDMusicAnalysis() {
            try {
                // Audio Context erstellen falls noch nicht vorhanden
                if (!ledMusicAudioContext) {
                    ledMusicAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Analyser erstellen
                if (!ledMusicAnalyser) {
                    ledMusicAnalyser = ledMusicAudioContext.createAnalyser();
                    ledMusicAnalyser.fftSize = 128;
                    const bufferLength = ledMusicAnalyser.frequencyBinCount;
                    ledMusicDataArray = new Uint8Array(bufferLength);
                }

                // Mit Audio-Element verbinden falls vorhanden
                const audioElement = document.querySelector('audio');
                if (audioElement && ledMusicAudioContext.state !== 'running') {
                    const source = ledMusicAudioContext.createMediaElementSource(audioElement);
                    source.connect(ledMusicAnalyser);
                    ledMusicAnalyser.connect(ledMusicAudioContext.destination);
                }

                ledMusicActive = true;
                ledMusicVisualize();
                console.log('✅ LED-Musik-Analyse gestartet');

            } catch (error) {
                console.error('❌ LED-Musik-Analyse Fehler:', error);
            }
        }

        // LED-Musik-Visualisierung
        async function ledMusicVisualize() {
            if (!ledMusicActive || !ledMusicAnalyser) return;

            ledMusicAnimationFrame = requestAnimationFrame(ledMusicVisualize);
            ledMusicAnalyser.getByteFrequencyData(ledMusicDataArray);

            // Frequenzbänder berechnen (Bass, Mid, Treble)
            const bass = ledMusicDataArray.slice(0, 80).reduce((a, b) => a + b, 0) / 80;
            const mid = ledMusicDataArray.slice(80, 160).reduce((a, b) => a + b, 0) / 80;
            const treble = ledMusicDataArray.slice(160, 256).reduce((a, b) => a + b, 0) / 96;
            
            // Echte Hardware LED-Steuern basierend auf Audio
            if (window.parent.ledDevice && window.parent.ledDevice.isConnected) {
                try {
                    // Konvertiere Audio-Frequenzen zu RGB
                    const r = Math.floor((bass / 255) * 255);
                    const g = Math.floor((mid / 255) * 255);
                    const b = Math.floor((treble / 255) * 255);
                    
                    // Sende echte Hardware-Befehle
                    const command = new Uint8Array([
                        0x7E,  // Start byte
                        0x00,  // Mode
                        0x05,  // Command (set color)
                        r,     // Rot (Bass)
                        g,     // Grün (Mid)
                        b,     // Blau (Treble)
                        0x00,  // White
                        0xEF   // End byte
                    ]);
                    
                    await window.parent.ledDevice.characteristic.writeValue(command);
                    
                } catch (error) {
                    // Fehler stillschweigend ignorieren für Performance
                }
            }

            // UI aktualisieren
            const bassEl = document.getElementById('ledMusicBassValue');
            const midEl = document.getElementById('ledMusicMidValue');
            const trebleEl = document.getElementById('ledMusicTrebleValue');
            
            if (bassEl) bassEl.textContent = Math.round(bass);
            if (midEl) midEl.textContent = Math.round(mid);
            if (trebleEl) trebleEl.textContent = Math.round(treble);

            // Frequenz-Balken zeichnen
            const freqDisplay = document.getElementById('ledMusicFreqDisplay');
            if (freqDisplay && freqDisplay.children.length === 0) {
                // Balken erstellen beim ersten Mal
                for (let i = 0; i < ledMusicDataArray.length; i++) {
                    const bar = document.createElement('div');
                    bar.style.flex = '1';
                    bar.style.background = 'linear-gradient(to top, #4ecdc4, #44a08d)';
                    bar.style.borderRadius = '2px';
                    bar.style.minHeight = '2px';
                    bar.style.transition = 'height 0.05s ease';
                    freqDisplay.appendChild(bar);
                }
            }

            // Balken-Höhen aktualisieren
            if (freqDisplay && freqDisplay.children.length > 0) {
                for (let i = 0; i < ledMusicDataArray.length; i++) {
                    const bar = freqDisplay.children[i];
                    const height = (ledMusicDataArray[i] / 255) * 100;
                    if (bar) bar.style.height = height + '%';
                }
            }

            // Farben an LED senden basierend auf Modus
            if (window.ledController && window.ledController.isConnected) {
                sendMusicToLED(bass, mid, treble);
            }
        }

        // Musik-Daten an LED senden
        function sendMusicToLED(bass, mid, treble) {
            const sensitivity = parseInt(document.getElementById('ledMusicSensitivity')?.value || 5);
            const speed = parseInt(document.getElementById('ledMusicReactionSpeed')?.value || 7);
            
            let r, g, b;

            switch (ledMusicMode) {
                case 'bass':
                    r = Math.min(255, bass * (sensitivity / 5) * 2);
                    g = 0;
                    b = Math.min(255, mid * (sensitivity / 5));
                    break;
                case 'spectrum':
                    r = Math.min(255, bass * (sensitivity / 5));
                    g = Math.min(255, mid * (sensitivity / 5));
                    b = Math.min(255, treble * (sensitivity / 5));
                    break;
                case 'beat':
                    const avg = (bass + mid + treble) / 3;
                    r = g = b = Math.min(255, avg * (sensitivity / 5));
                    break;
                case 'energy':
                    const energy = Math.max(bass, mid, treble);
                    r = Math.min(255, energy * (sensitivity / 5));
                    g = Math.min(255, energy * (sensitivity / 5) * 0.5);
                    b = 0;
                    break;
                default:
                    r = Math.min(255, bass * (sensitivity / 5));
                    g = Math.min(255, mid * (sensitivity / 5));
                    b = Math.min(255, treble * (sensitivity / 5));
            }

            // Farbe an LED senden (Throttled - max 30 FPS)
            if (window.ledController && window.ledController.setColorRGB) {
                window.ledController.setColorRGB(Math.round(r), Math.round(g), Math.round(b));
            }
        }

        // LED-Musik-Analyse stoppen
        function stopLEDMusicAnalysis() {
            ledMusicActive = false;
            if (ledMusicAnimationFrame) {
                cancelAnimationFrame(ledMusicAnimationFrame);
                ledMusicAnimationFrame = null;
            }
            console.log('⏹️ LED-Musik-Analyse gestoppt');
        }

        // Event-Listener
        document.addEventListener('DOMContentLoaded', () => {
            // LED-Musik-Toggle
            const ledMusicToggle = document.getElementById('ledMusicToggle');
            if (ledMusicToggle) {
                ledMusicToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        startLEDMusicAnalysis();
                    } else {
                        stopLEDMusicAnalysis();
                    }
                });
            }

            // Automatisch starten wenn Audio-Element abgespielt wird
            const audioElement = document.querySelector('audio');
            if (audioElement) {
                audioElement.addEventListener('play', () => {
                    const toggle = document.getElementById('ledMusicToggle');
                    if (toggle && toggle.checked) {
                        startLEDMusicAnalysis();
                    }
                });
            }

            // ✅ AUTO-RECONNECT für gespeicherte BLE-Geräte (aus LedMusicControl.html)
            setTimeout(() => {
                try {
                    if (typeof Storage !== 'undefined') {
                        const savedDevices = JSON.parse(localStorage.getItem('led-devices') || '[]');
                        if (Array.isArray(savedDevices)) {
                            for (const device of savedDevices) {
                                if (device && device.autoConnect) {
                                    console.log(`🔄 Auto-Reconnect: Versuche Verbindung zu ${device.name}`);
                                    // Verbindung wird über den globalen BLE-Controller versucht
                                    if (window.parent?.bleController?.connect) {
                                        window.parent.bleController.connect(device.mac, device.protocol)
                                            .then(() => console.log(`✅ Auto-Reconnect erfolgreich: ${device.name}`))
                                            .catch(err => console.warn(`⚠️ Auto-Reconnect fehlgeschlagen: ${device.name}`, err));
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Auto-Reconnect Fehler:', error);
                }
            }, 2000); // 2 Sekunden warten für BLE-Controller Initialisierung
            
            console.log('✅ LED-Musik-Control Funktionen geladen');
        });

        // Cleanup beim Verlassen
        window.addEventListener('beforeunload', () => {
            stopLEDMusicAnalysis();
            if (ledMusicAudioContext) {
                ledMusicAudioContext.close();
            }
        });

        // ===== LED-MUSIK UI FUNKTIONEN =====
        
        // Update Band Tabs basierend auf Band Count
        function updateBandTabs(count) {
            const tabs = document.querySelectorAll('.led-band-tab');
            const bandCount = parseInt(count);
            
            tabs.forEach((tab, index) => {
                // Skip audio-reactive tab (index 0)
                if (index === 0) return;
                
                const bandIndex = index - 1;
                if (bandIndex < bandCount) {
                    tab.style.display = 'block';
                } else {
                    tab.style.display = 'none';
                }
            });
            
            console.log(`✅ ${bandCount} LED-Bänder aktiv`);
        }
        
        // LED Band Tab Switching
        document.addEventListener('DOMContentLoaded', function() {
            const bandTabs = document.querySelectorAll('.led-band-tab');
            
            bandTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetBand = this.getAttribute('data-band');
                    
                    // Update active tab
                    bandTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show/hide content
                    document.querySelectorAll('.led-band-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    const targetContent = document.getElementById(`ledBandContent-${targetBand}`);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                    
                    console.log(`🎛️ LED-Band Tab gewechselt zu: ${targetBand}`);
                    
                    // Initialize audio engine if audio-reactive tab
                    if (targetBand === 'audio-reactive' && !window.audioReactiveEngine) {
                        window.audioReactiveEngine = new AudioReactiveEngine();
                        
                        // ✅ EVENT-LISTENER FÜR MUSIK-ANALYSE (OHNE MIKROFON)
                        const startBtn = document.getElementById('startAudioCapture');
                        const stopBtn = document.getElementById('stopAudioCapture');
                        
                        if (startBtn) {
                            startBtn.addEventListener('click', async () => {
                                const audioElement = document.getElementById('audioPlayer');
                                if (!audioElement) {
                                    alert('❌ Audio-Player nicht gefunden!');
                                    return;
                                }
                                
                                if (!audioElement.src) {
                                    alert('⚠️ Bitte erst einen Song laden!');
                                    return;
                                }
                                
                                try {
                                    // ✅ AUDIO-ELEMENT AN ENGINE ÜBERGEBEN (KEIN MIKROFON)
                                    const success = await window.audioReactiveEngine.startAudioCapture(audioElement);
                                    
                                    if (success) {
                                        startBtn.style.display = 'none';
                                        stopBtn.style.display = 'inline-block';
                                        console.log('🎵 Musik-Analyse gestartet (ohne Mikrofon)');
                                    }
                                } catch (error) {
                                    console.error('❌ Musik-Analyse Fehler:', error);
                                    alert('❌ Musik-Analyse konnte nicht gestartet werden: ' + error.message);
                                }
                            });
                        }
                        
                        if (stopBtn) {
                            stopBtn.addEventListener('click', async () => {
                                await window.audioReactiveEngine.stopAudioCapture();
                                startBtn.style.display = 'inline-block';
                                stopBtn.style.display = 'none';
                                console.log('🎵 Musik-Analyse gestoppt');
                            });
                        }
                    }
                });
            });
            
            // Initialize LED Frequency Display
            const display = document.getElementById('ledFrequencyDisplay');
            if (display) {
                display.innerHTML = '';
                for (let i = 0; i < 64; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'freq-bar';
                    bar.style.cssText = 'flex: 1; background: linear-gradient(to top, #4ecdc4, #44a08d); border-radius: 2px; min-height: 2px; transition: height 0.05s ease;';
                    display.appendChild(bar);
                }
            }
            
            // Initialize with 3 bands
            updateBandTabs(3);
        });
        
        // ✅ FEHLENDE PARTY-MODE FUNKTION
        function activatePartyMode() {
            console.log('🎉 Party-Modus aktiviert');
            // Party-Modus aktivieren
            if (window.ledController && window.ledController.isConnected) {
                // Setze Party-Effekt
                window.ledController.setEffect('party');
                window.ledController.setBrightness(100);
            }
            // Start Audio-Reactive wenn verfügbar
            const ledMusicToggle = document.getElementById('ledMusicToggle');
            if (ledMusicToggle && !ledMusicToggle.checked) {
                ledMusicToggle.checked = true;
                ledMusicToggle.dispatchEvent(new Event('change'));
            }
        }
        
        // Save LED Band Preset
        function saveLEDBandPreset(bandIndex) {
            try {
                const bandContent = document.getElementById(`ledBandContent-${bandIndex}`);
                if (!bandContent) return;
                
                const preset = {
                    enabled: bandContent.querySelector('.band-enabled')?.checked,
                    color: bandContent.querySelector('.band-color')?.value,
                    effect: bandContent.querySelector('.band-effect')?.value,
                    reactTo: bandContent.querySelector('.band-react-to')?.value,
                    freqRange: bandContent.querySelector('.band-freq-range')?.value,
                    sensitivity: bandContent.querySelector('.band-sensitivity')?.value,
                    speed: bandContent.querySelector('.band-speed')?.value,
                    brightness: bandContent.querySelector('.band-brightness')?.value
                };
                
                const presetName = prompt('Preset-Name:', `Band ${bandIndex + 1} Preset`);
                if (!presetName) return;
                
                const presets = JSON.parse(localStorage.getItem('led-band-presets') || '{}');
                presets[presetName] = preset;
                localStorage.setItem('led-band-presets', JSON.stringify(presets));
                
                showNotification(`✅ Preset "${presetName}" gespeichert!`, 'success');
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showNotification('❌ Fehler beim Speichern', 'error');
            }
        }
        
        // Load LED Band Preset
        function loadLEDBandPreset(bandIndex) {
            try {
                const presets = JSON.parse(localStorage.getItem('led-band-presets') || '{}');
                const presetNames = Object.keys(presets);
                
                if (presetNames.length === 0) {
                    showNotification('⚠️ Keine Presets gefunden', 'info');
                    return;
                }
                
                const presetName = prompt('Preset laden (verfügbar: ' + presetNames.join(', ') + '):');
                if (!presetName || !presets[presetName]) return;
                
                const preset = presets[presetName];
                const bandContent = document.getElementById(`ledBandContent-${bandIndex}`);
                if (!bandContent) return;
                
                if (bandContent.querySelector('.band-enabled')) bandContent.querySelector('.band-enabled').checked = preset.enabled;
                if (bandContent.querySelector('.band-color')) bandContent.querySelector('.band-color').value = preset.color;
                if (bandContent.querySelector('.band-effect')) bandContent.querySelector('.band-effect').value = preset.effect;
                if (bandContent.querySelector('.band-react-to')) bandContent.querySelector('.band-react-to').value = preset.reactTo;
                if (bandContent.querySelector('.band-freq-range')) bandContent.querySelector('.band-freq-range').value = preset.freqRange;
                if (bandContent.querySelector('.band-sensitivity')) bandContent.querySelector('.band-sensitivity').value = preset.sensitivity;
                if (bandContent.querySelector('.band-speed')) bandContent.querySelector('.band-speed').value = preset.speed;
                if (bandContent.querySelector('.band-brightness')) bandContent.querySelector('.band-brightness').value = preset.brightness;
                
                showNotification(`✅ Preset "${presetName}" geladen!`, 'success');
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                showNotification('❌ Fehler beim Laden', 'error');
            }
        }
        
        // Reset LED Band to Default Settings
        function resetLEDBandToDefault(bandIndex) {
            if (!confirm('Einstellungen auf Standardwerte zurücksetzen?')) return;
            
            try {
                const bandContent = document.getElementById(`ledBandContent-${bandIndex}`);
                if (!bandContent) return;
                
                // Standardwerte
                if (bandContent.querySelector('.band-enabled')) bandContent.querySelector('.band-enabled').checked = true;
                if (bandContent.querySelector('.band-color')) bandContent.querySelector('.band-color').value = '#4ecdc4';
                if (bandContent.querySelector('.band-effect')) bandContent.querySelector('.band-effect').value = 'pulse';
                if (bandContent.querySelector('.band-react-to')) bandContent.querySelector('.band-react-to').value = 'bass';
                if (bandContent.querySelector('.band-freq-range')) bandContent.querySelector('.band-freq-range').value = 'low';
                if (bandContent.querySelector('.band-sensitivity')) bandContent.querySelector('.band-sensitivity').value = '50';
                if (bandContent.querySelector('.band-speed')) bandContent.querySelector('.band-speed').value = '50';
                if (bandContent.querySelector('.band-brightness')) bandContent.querySelector('.band-brightness').value = '80';
                
                showNotification('✅ Auf Standardwerte zurückgesetzt!', 'success');
            } catch (error) {
                console.error('Fehler beim Zurücksetzen:', error);
                showNotification('❌ Fehler beim Zurücksetzen', 'error');
            }
        }
        
        // Reset Tempo and Pitch to defaults
        function resetTempoAndPitch() {
            try {
                const tempoSlider = document.getElementById('tempoControl');
                const pitchSlider = document.getElementById('pitchControl');
                const audioElement = document.getElementById('audioPlayer');
                
                if (tempoSlider) {
                    tempoSlider.value = 1;
                    document.getElementById('tempoValue').textContent = '1.0x';
                }
                
                if (pitchSlider) {
                    pitchSlider.value = 0;
                    document.getElementById('pitchValue').textContent = '0';
                }
                
                // Reset Audio Playback Rate
                if (audioElement) {
                    audioElement.playbackRate = 1.0;
                }
                
                showNotification('✅ Tempo & Tonhöhe zurückgesetzt!', 'success');
                console.log('🎵 Tempo und Tonhöhe zurückgesetzt');
            } catch (error) {
                console.error('Fehler beim Zurücksetzen von Tempo/Pitch:', error);
                showNotification('❌ Fehler beim Zurücksetzen', 'error');
            }
        }
    </script>
    
    <!-- ✅ GLOBALE FUNKTIONEN (außerhalb DOMContentLoaded) -->
    <script>
    // Copy LED Band Settings to Others
    function copyLEDBandToOthers(bandIndex) {
        if (!confirm('Einstellungen auf alle anderen Bänder kopieren?')) return;
        
        const sourceBand = document.getElementById(`ledBandContent-${bandIndex}`);
        if (!sourceBand) return;
        
        const settings = {
            enabled: sourceBand.querySelector('.band-enabled')?.checked,
            effect: sourceBand.querySelector('.band-effect')?.value,
            reactTo: sourceBand.querySelector('.band-react-to')?.value,
            freqRange: sourceBand.querySelector('.band-freq-range')?.value,
            sensitivity: sourceBand.querySelector('.band-sensitivity')?.value,
            speed: sourceBand.querySelector('.band-speed')?.value,
            brightness: sourceBand.querySelector('.band-brightness')?.value
        };
        
        const bandCount = parseInt(document.getElementById('ledBandCount')?.value || 3);
        
        for (let i = 0; i < bandCount; i++) {
            if (i === bandIndex) continue;
            
            const targetBand = document.getElementById(`ledBandContent-${i}`);
            if (!targetBand) continue;
            
            if (targetBand.querySelector('.band-enabled')) targetBand.querySelector('.band-enabled').checked = settings.enabled;
            if (targetBand.querySelector('.band-effect')) targetBand.querySelector('.band-effect').value = settings.effect;
            if (targetBand.querySelector('.band-react-to')) targetBand.querySelector('.band-react-to').value = settings.reactTo;
            if (targetBand.querySelector('.band-freq-range')) targetBand.querySelector('.band-freq-range').value = settings.freqRange;
            if (targetBand.querySelector('.band-sensitivity')) targetBand.querySelector('.band-sensitivity').value = settings.sensitivity;
            if (targetBand.querySelector('.band-speed')) targetBand.querySelector('.band-speed').value = settings.speed;
            if (targetBand.querySelector('.band-brightness')) targetBand.querySelector('.band-brightness').value = settings.brightness;
        }
        
        showNotification(`✅ Auf ${bandCount - 1} Bänder kopiert!`, 'success');
    }

    </script>

    <!-- 🔧 DEBUG-CODE - NUR ZUM TESTEN -->
    <script>
    // TEST-CODE - NUR ZUM DEBUGGEN
    window.addEventListener('load', function() {
        console.log('=== MUSIK.HTML DEBUG ===');
        console.log('Taskbar Buttons:', document.querySelectorAll('.taskbar-btn').length);
        console.log('Content Panels:', document.querySelectorAll('.content-panel').length);

        // Liste alle Panel-IDs
        document.querySelectorAll('.content-panel').forEach(panel => {
            console.log('Panel gefunden:', panel.id);
        });

        // Teste Event-Listener
        document.querySelectorAll('.taskbar-btn').forEach((btn, index) => {
            console.log(`Button ${index + 1}:`, btn.getAttribute('data-content'));
        });
    });
    </script>

    </body>
</html>
