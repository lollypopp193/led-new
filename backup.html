<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup & Synchronisation - LED Einstellungen</title>
    <!-- Fallback f√ºr offline Nutzung -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.href='css/fontawesome-fallback.css'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" onerror="this.href='css/fonts-fallback.css'">
    <link rel="stylesheet" href="css/shared-styles.css">
    <style>
        body {
            padding: 20px;
            background: var(--bg-primary);
        }

        /* CSS-Konstanten f√ºr Magic Numbers */
        :root {
            --backup-card-min-width: 300px;
            --backup-grid-gap: 20px;
            --backup-grid-margin: 30px;
            --backup-card-padding: 25px;
            --backup-icon-size: 50px;
            --backup-hover-offset: -3px;
            --progress-bar-height: 8px;
            --notification-timeout: 3000;
            --upload-chunk-size: 1024;
        }

        .backup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--backup-card-min-width), 1fr));
            gap: var(--backup-grid-gap);
            margin-bottom: var(--backup-grid-margin);
        }

        .backup-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: var(--backup-card-padding);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }

        .backup-card:hover {
            transform: translateY(var(--backup-hover-offset));
            box-shadow: var(--shadow-glow);
        }

        .backup-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .backup-icon {
            width: var(--backup-icon-size);
            height: var(--backup-icon-size);
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .backup-info h3 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .backup-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .backup-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .backup-list {
            background: var(--bg-card-secondary);
            border-radius: var(--border-radius-small);
            padding: 15px;
            margin: 20px 0;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .backup-item:last-child {
            border-bottom: none;
        }

        .backup-details {
            flex: 1;
        }

        .backup-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .backup-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .backup-size {
            color: var(--accent-color);
            font-weight: 500;
            margin-right: 15px;
        }

        .progress-bar {
            width: 100%;
            height: var(--progress-bar-height);
            background: rgba(255, 255, 255, 0.1);
            border-radius: calc(var(--progress-bar-height) / 2);
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 255, 231, 0.1);
            border-radius: var(--border-radius-small);
            border: 1px solid rgba(0, 255, 231, 0.3);
            margin-bottom: 20px;
        }

        .sync-status.syncing {
            background: rgba(249, 202, 36, 0.1);
            border-color: rgba(249, 202, 36, 0.3);
        }

        .sync-status.error {
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
        }

        .status-icon {
            font-size: 1.2rem;
            color: var(--accent-color);
        }

        .status-icon.syncing {
            color: #f9ca24;
            animation: spin 2s linear infinite;
        }

        .status-icon.error {
            color: #ff6b6b;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--accent-color);
            background: rgba(0, 255, 231, 0.05);
        }

        .drop-icon {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .backup-grid {
                grid-template-columns: 1fr;
            }
            
            .backup-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">
                <i class="fas fa-cloud" aria-hidden="true"></i> Backup & Synchronisation
            </h1>
            <p class="app-subtitle">Sichern und synchronisieren Sie Ihre LED-Einstellungen</p>
        </header>

        <!-- Sync Status -->
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-check-circle status-icon" aria-hidden="true"></i>
            <div>
                <strong>Synchronisation aktiv</strong><br>
                <small>Letzte Synchronisation: vor 2 Minuten</small>
            </div>
        </div>

        <!-- Backup Options -->
        <div class="backup-grid">
            <!-- Automatisches Backup -->
            <div class="backup-card">
                <div class="backup-header">
                    <div class="backup-icon">
                        <i class="fas fa-clock" aria-hidden="true"></i>
                    </div>
                    <div class="backup-info">
                        <h3>Automatisches Backup</h3>
                        <p>Regelm√§√üige Sicherung aller Einstellungen</p>
                    </div>
                </div>
                <div class="backup-actions">
                    <button class="btn btn-secondary" onclick="toggleAutoBackup()" id="autoBackupBtn">
                        <i class="fas fa-play" aria-hidden="true"></i> Aktivieren
                    </button>
                    <button class="btn btn-outline" onclick="configureAutoBackup()">
                        <i class="fas fa-cog" aria-hidden="true"></i> Konfigurieren
                    </button>
                </div>
            </div>

            <!-- Manuelles Backup -->
            <div class="backup-card">
                <div class="backup-header">
                    <div class="backup-icon">
                        <i class="fas fa-download" aria-hidden="true"></i>
                    </div>
                    <div class="backup-info">
                        <h3>Manuelles Backup</h3>
                        <p>Sofortige Sicherung erstellen</p>
                    </div>
                </div>
                <div class="backup-actions">
                    <button class="btn btn-secondary" onclick="createBackup()">
                        <i class="fas fa-save" aria-hidden="true"></i> Backup erstellen
                    </button>
                    <button class="btn btn-outline" onclick="exportSettings()">
                        <i class="fas fa-file-export" aria-hidden="true"></i> Exportieren
                    </button>
                </div>
            </div>

            <!-- Cloud Sync -->
            <div class="backup-card">
                <div class="backup-header">
                    <div class="backup-icon">
                        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    </div>
                    <div class="backup-info">
                        <h3>Cloud-Synchronisation</h3>
                        <p>Ger√§te√ºbergreifende Synchronisation</p>
                    </div>
                </div>
                <div class="backup-actions">
                    <button class="btn btn-secondary" onclick="syncToCloud()">
                        <i class="fas fa-sync" aria-hidden="true"></i> Synchronisieren
                    </button>
                    <button class="btn btn-outline" onclick="configureCloud()">
                        <i class="fas fa-cog" aria-hidden="true"></i> Einrichten
                    </button>
                </div>
            </div>
        </div>

        <!-- Backup List -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Verf√ºgbare Backups</h2>
                <i class="fas fa-history card-icon" aria-hidden="true"></i>
            </div>
            
            <div class="backup-list" id="backupList">
                <div class="backup-item">
                    <div class="backup-details">
                        <div class="backup-name">Vollst√§ndiges Backup</div>
                        <div class="backup-meta">Heute, 14:30 ‚Ä¢ Alle Einstellungen, Szenen, Farben</div>
                    </div>
                    <div class="backup-size">2.4 MB</div>
                    <div class="backup-actions">
                        <button class="btn btn-small" onclick="restoreBackup('full-today')">
                            <i class="fas fa-undo" aria-hidden="true"></i> Wiederherstellen
                        </button>
                        <button class="btn btn-small btn-outline" onclick="downloadBackup('full-today')">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <div class="backup-item">
                    <div class="backup-details">
                        <div class="backup-name">Szenen-Backup</div>
                        <div class="backup-meta">Gestern, 20:15 ‚Ä¢ Nur Lichtszenen und Effekte</div>
                    </div>
                    <div class="backup-size">0.8 MB</div>
                    <div class="backup-actions">
                        <button class="btn btn-small" onclick="restoreBackup('scenes-yesterday')">
                            <i class="fas fa-undo" aria-hidden="true"></i> Wiederherstellen
                        </button>
                        <button class="btn btn-small btn-outline" onclick="downloadBackup('scenes-yesterday')">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <div class="backup-item">
                    <div class="backup-details">
                        <div class="backup-name">Ger√§te-Konfiguration</div>
                        <div class="backup-meta">3 Tage ‚Ä¢ LED-Ger√§te und Bluetooth-Einstellungen</div>
                    </div>
                    <div class="backup-size">0.3 MB</div>
                    <div class="backup-actions">
                        <button class="btn btn-small" onclick="restoreBackup('devices-3days')">
                            <i class="fas fa-undo" aria-hidden="true"></i> Wiederherstellen
                        </button>
                        <button class="btn btn-small btn-outline" onclick="downloadBackup('devices-3days')">
                            <i class="fas fa-download" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h2 class="card-title">Backup importieren</h2>
                <i class="fas fa-upload card-icon" aria-hidden="true"></i>
            </div>
            
            <div class="file-drop-zone" id="dropZone" onclick="selectFile()">
                <i class="fas fa-cloud-upload-alt drop-icon" aria-hidden="true"></i>
                <h3>Backup-Datei hier ablegen</h3>
                <p>oder klicken zum Ausw√§hlen</p>
                <input type="file" id="fileInput" accept=".json,.backup" style="display: none;">
            </div>
            
            <div class="progress-bar" id="uploadProgress" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <script>
        let autoBackupEnabled = false;
        let backups = [
            {
                id: 'full-today',
                name: 'Vollst√§ndiges Backup',
                date: new Date(),
                size: '2.4 MB',
                type: 'full'
            },
            {
                id: 'scenes-yesterday',
                name: 'Szenen-Backup',
                date: new Date(Date.now() - 86400000),
                size: '0.8 MB',
                type: 'scenes'
            }
        ];

        // Auto Backup Toggle
        function toggleAutoBackup() {
            autoBackupEnabled = !autoBackupEnabled;
            const btn = document.getElementById('autoBackupBtn');
            
            if (autoBackupEnabled) {
                btn.innerHTML = '<i class="fas fa-pause" aria-hidden="true"></i> Deaktivieren';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn');
                showNotification('Automatisches Backup aktiviert!', 'success');
                updateSyncStatus('Automatisches Backup l√§uft...', 'syncing');
            } else {
                btn.innerHTML = '<i class="fas fa-play" aria-hidden="true"></i> Aktivieren';
                btn.classList.remove('btn');
                btn.classList.add('btn-secondary');
                showNotification('Automatisches Backup deaktiviert!', 'info');
                updateSyncStatus('Synchronisation aktiv', 'success');
            }
        }

        // Create Manual Backup
        function createBackup() {
            showNotification('Backup wird erstellt...', 'info');
            
            // Echte Backup-Erstellung
            try {
                const settings = {
                    led: JSON.parse(localStorage.getItem('led-app-settings') || '{}'),
                    colors: JSON.parse(localStorage.getItem('savedColors') || '[]'),
                    presets: JSON.parse(localStorage.getItem('led-music-presets') || '{}'),
                    timers: JSON.parse(localStorage.getItem('timers') || '[]'),
                    effects: JSON.parse(localStorage.getItem('favoriteEffects') || '[]'),
                    timestamp: new Date().toISOString(),
                    version: '1.0.0'
                };
                
                const dataStr = JSON.stringify(settings, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const size = (dataBlob.size / 1024).toFixed(1) + ' KB';
                
                const backup = {
                    id: 'manual-' + Date.now(),
                    name: 'Manuelles Backup',
                    date: new Date(),
                    size: size,
                    type: 'full',
                    data: dataStr
                };
                
                // Download backup file
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `led-app-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                backups.unshift(backup);
                updateBackupList();
                showNotification('Backup erfolgreich erstellt und heruntergeladen!', 'success');
            } catch (error) {
                showNotification('Fehler beim Erstellen des Backups: ' + error.message, 'error');
            }
        }

        // Export Settings
        function exportSettings() {
            const settings = {
                scenes: localStorage.getItem('scenes') || '{}',
                colors: localStorage.getItem('colors') || '{}',
                devices: localStorage.getItem('devices') || '{}',
                preferences: localStorage.getItem('preferences') || '{}'
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `led-settings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Einstellungen exportiert!', 'success');
        }

        // Cloud Sync
        function syncToCloud() {
            updateSyncStatus('Synchronisiere mit Cloud...', 'syncing');
            
            setTimeout(() => {
                updateSyncStatus('Cloud-Synchronisation erfolgreich', 'success');
                showNotification('Mit Cloud synchronisiert!', 'success');
            }, 3000);
        }

        // File Import
        function selectFile() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                importBackup(file);
            }
        });

        // Sichere Datei-Import mit vollst√§ndiger Validierung
        async function importBackup(file) {
            try {
                // Input-Validierung
                if (!file) {
                    showNotification('Keine Datei ausgew√§hlt', 'error');
                    return;
                }
                
                const MAX_SIZE = 50 * 1024 * 1024; // 50MB
                if (file.size > MAX_SIZE) {
                    showNotification('Datei zu gro√ü (max. 50MB)', 'error');
                    return;
                }
                
                const allowedTypes = ['.json', '.backup', '.led'];
                const fileName = file.name.toLowerCase();
                const hasValidExtension = allowedTypes.some(ext => fileName.endsWith(ext));
                
                if (!hasValidExtension) {
                    showNotification(`Ung√ºltiger Dateityp. Erlaubt: ${allowedTypes.join(', ')}`, 'error');
                    return;
                }
                
                const progressBar = document.getElementById('uploadProgress');
                const progressFill = document.getElementById('progressFill');
                
                if (progressBar) progressBar.style.display = 'block';
                
                // Sichere Datei-Verarbeitung
                const fileContent = await readFileSecurely(file, (progress) => {
                    if (progressFill) {
                        progressFill.style.width = progress + '%';
                    }
                });
                
                // JSON-Validierung
                let backupData;
                try {
                    backupData = JSON.parse(fileContent);
                } catch (parseError) {
                    throw new Error('Ung√ºltiges Backup-Format');
                }
                
                // Backup-Struktur validieren
                if (!validateBackupStructure(backupData)) {
                    throw new Error('Ung√ºltige Backup-Struktur');
                }
                
                // Daten wiederherstellen
                await restoreBackupData(backupData);
                
                if (progressBar) {
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        showNotification('Backup erfolgreich importiert!', 'success');
                    }, 500);
                }
                
            } catch (error) {
                console.error('Import-Fehler:', error);
                showNotification('Import fehlgeschlagen: ' + error.message, 'error');
                
                const progressBar = document.getElementById('uploadProgress');
                if (progressBar) progressBar.style.display = 'none';
            }
        }
        
        // Sichere Datei-Lese-Funktion
        function readFileSecurely(file, progressCallback) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const content = e.target.result;
                    if (typeof content !== 'string') {
                        reject(new Error('Datei konnte nicht gelesen werden'));
                        return;
                    }
                    resolve(content);
                };
                
                reader.onerror = () => reject(new Error('Fehler beim Lesen der Datei'));
                
                reader.onprogress = (e) => {
                    if (e.lengthComputable && progressCallback) {
                        const progress = (e.loaded / e.total) * 100;
                        progressCallback(progress);
                    }
                };
                
                reader.readAsText(file);
            });
        }
        
        // Vollst√§ndige Backup-Struktur-Validierung mit Sicherheitschecks
        function validateBackupStructure(data) {
            if (!data || typeof data !== 'object') {
                console.error('‚ùå Backup-Daten sind kein Objekt');
                return false;
            }
            
            // 1. Pr√ºfe ob mindestens ein erforderliches Feld vorhanden ist
            const requiredKeys = ['led', 'colors', 'presets', 'timers', 'effects', 'scenes', 'devices'];
            const hasRequiredKey = requiredKeys.some(key => data.hasOwnProperty(key));
            
            if (!hasRequiredKey) {
                console.error('‚ùå Keine erforderlichen Felder gefunden');
                return false;
            }
            
            // 2. Pr√ºfe auf verd√§chtige Schl√ºssel (Prototype Pollution Prevention)
            const dangerousKeys = ['__proto__', 'constructor', 'prototype'];
            for (const key of Object.keys(data)) {
                if (dangerousKeys.includes(key)) {
                    console.error('‚ùå Verd√§chtiger Schl√ºssel gefunden:', key);
                    return false;
                }
            }
            
            // 3. Validiere Feldtypen
            const fieldTypes = {
                led: 'object',
                colors: 'array',
                presets: 'object',
                timers: 'array',
                effects: 'array',
                scenes: 'array',
                devices: 'array',
                settings: 'object',
                metadata: 'object'
            };
            
            for (const [key, expectedType] of Object.entries(fieldTypes)) {
                if (data.hasOwnProperty(key)) {
                    const actualType = Array.isArray(data[key]) ? 'array' : typeof data[key];
                    if (actualType !== expectedType) {
                        console.error(`‚ùå Falscher Typ f√ºr ${key}: erwartet ${expectedType}, erhalten ${actualType}`);
                        return false;
                    }
                }
            }
            
            // 4. Pr√ºfe auf Code-Injection in String-Feldern
            const checkForInjection = (obj) => {
                if (typeof obj === 'string') {
                    const dangerousPatterns = [
                        /<script/i,
                        /javascript:/i,
                        /on\w+\s*=/i,
                        /eval\(/i,
                        /Function\(/i
                    ];
                    return dangerousPatterns.some(pattern => pattern.test(obj));
                }
                if (typeof obj === 'object' && obj !== null) {
                    return Object.values(obj).some(val => checkForInjection(val));
                }
                return false;
            };
            
            if (checkForInjection(data)) {
                console.error('‚ùå Potentieller Code-Injection-Versuch erkannt');
                return false;
            }
            
            console.log('‚úÖ Backup-Struktur ist valide');
            return true;
        }
        
        // Sichere Backup-Wiederherstellung mit SOFORTIGER Hardware-Anwendung!
        async function restoreBackupData(backupData) {
            const storageKeys = {
                led: 'led-app-settings',
                colors: 'savedColors',
                presets: 'led-music-presets',
                timers: 'timers',
                effects: 'favoriteEffects',
                scenes: 'led-scenes',              // NEU
                devices: 'led-devices',            // NEU
                settings: 'app-settings'           // NEU
            };
            
            let restoredCount = 0;
            let errorCount = 0;
            
            for (const [key, storageKey] of Object.entries(storageKeys)) {
                if (backupData.hasOwnProperty(key)) {
                    try {
                        localStorage.setItem(storageKey, JSON.stringify(backupData[key]));
                        restoredCount++;
                        console.log(`‚úÖ ${key} wiederhergestellt`);
                    } catch (error) {
                        errorCount++;
                        console.warn(`‚ùå Fehler beim Wiederherstellen von ${key}:`, error);
                    }
                }
            }
            
            console.log(`‚úÖ Wiederherstellung abgeschlossen: ${restoredCount} erfolgreich, ${errorCount} Fehler`);
            
            // ‚úÖ SOFORT HARDWARE-EINSTELLUNGEN ANWENDEN!
            if (restoredCount > 0) {
                await applyRestoredSettingsToHardware(backupData);
                
                setTimeout(() => {
                    if (confirm('Backup wurde wiederhergestellt und auf LEDs angewendet. Seite neu laden?')) {
                        window.location.reload();
                    }
                }, 1000);
            }
        }
        
        // ‚úÖ NEUE FUNKTION: Wiederhergestellte Einstellungen SOFORT an Hardware senden!
        async function applyRestoredSettingsToHardware(backupData) {
            console.log('üîÑ Wende Backup-Einstellungen auf LEDs an...');
            
            try {
                // Hole den globalen BLE Controller
                let controller = null;
                
                if (window.parent && window.parent !== window && window.parent.bleController) {
                    controller = window.parent.bleController;
                } else if (window.bleController) {
                    controller = window.bleController;
                }
                
                if (!controller || !controller.isConnected) {
                    console.warn('‚ö†Ô∏è Keine Bluetooth-Verbindung - Einstellungen nur gespeichert');
                    showNotification('‚ö†Ô∏è Backup wiederhergestellt (keine LED-Verbindung)', 'warning');
                    return;
                }
                
                // ‚úÖ FARBEN WIEDERHERSTELLEN
                if (backupData.colors && backupData.colors.length > 0) {
                    const lastColor = backupData.colors[backupData.colors.length - 1];
                    if (lastColor && lastColor.rgb) {
                        const [r, g, b] = lastColor.rgb.match(/\d+/g).map(Number);
                        await controller.setColorRGB(r, g, b);
                        console.log(`‚úÖ Farbe wiederhergestellt: RGB(${r},${g},${b})`);
                    }
                }
                
                // ‚úÖ HELLIGKEIT WIEDERHERSTELLEN
                if (backupData.led && backupData.led.brightness) {
                    await controller.setBrightness(backupData.led.brightness);
                    console.log(`‚úÖ Helligkeit wiederhergestellt: ${backupData.led.brightness}%`);
                }
                
                // ‚úÖ EFFEKT WIEDERHERSTELLEN
                if (backupData.effects && backupData.effects.length > 0) {
                    const lastEffect = backupData.effects[backupData.effects.length - 1];
                    if (lastEffect) {
                        await controller.setEffect(lastEffect);
                        console.log(`‚úÖ Effekt wiederhergestellt: ${lastEffect}`);
                    }
                }
                
                // ‚úÖ POWER-STATUS WIEDERHERSTELLEN
                if (backupData.led && typeof backupData.led.powerState === 'boolean') {
                    await controller.setPower(backupData.led.powerState);
                    console.log(`‚úÖ Power-Status wiederhergestellt: ${backupData.led.powerState ? 'Ein' : 'Aus'}`);
                }
                
                showNotification('‚úÖ Backup auf LEDs angewendet!', 'success');
                console.log('‚úÖ Alle Backup-Einstellungen wurden an Hardware gesendet!');
                
            } catch (error) {
                console.error('‚ùå Fehler beim Anwenden auf Hardware:', error);
                showNotification('‚ö†Ô∏è Backup gespeichert, aber Hardware-Anwendung fehlgeschlagen', 'warning');
            }
        }

        // Sichere Backup-Wiederherstellung
        async function restoreBackup(backupId) {
            const backup = backups.find(b => b.id === backupId);
            if (!backup) {
                showNotification('Backup nicht gefunden', 'error');
                return;
            }
            
            const confirmed = confirm(
                'M√∂chten Sie wirklich dieses Backup wiederherstellen?\n\n' +
                'WARNUNG: Alle aktuellen Einstellungen werden √ºberschrieben!\n\n' +
                'Backup: ' + backup.name + '\n' +
                'Datum: ' + formatDate(backup.date)
            );
            
            if (!confirmed) return;
            
            try {
                showNotification('Backup wird wiederhergestellt...', 'info');
                
                // Simuliere Wiederherstellung (hier w√ºrde echte Logik stehen)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showNotification('Backup erfolgreich wiederhergestellt!', 'success');
                updateSyncStatus('Backup wiederhergestellt', 'success');
                
            } catch (error) {
                console.error('Wiederherstellungs-Fehler:', error);
                showNotification('Fehler bei der Wiederherstellung: ' + error.message, 'error');
            }
        }

        // Sichere Backup-Download-Funktion
        async function downloadBackup(backupId) {
            try {
                const backup = backups.find(b => b.id === backupId);
                if (!backup) {
                    showNotification('Backup nicht gefunden', 'error');
                    return;
                }
                
                showNotification('Backup wird vorbereitet...', 'info');
                
                // Backup-Daten sammeln (inkl. Scenes & Devices)
                const backupData = {
                    led: JSON.parse(localStorage.getItem('led-app-settings') || '{}'),
                    colors: JSON.parse(localStorage.getItem('savedColors') || '[]'),
                    presets: JSON.parse(localStorage.getItem('led-music-presets') || '{}'),
                    timers: JSON.parse(localStorage.getItem('timers') || '[]'),
                    effects: JSON.parse(localStorage.getItem('favoriteEffects') || '[]'),
                    scenes: JSON.parse(localStorage.getItem('led-scenes') || '[]'),        // NEU
                    devices: JSON.parse(localStorage.getItem('led-devices') || '[]'),      // NEU
                    settings: JSON.parse(localStorage.getItem('app-settings') || '{}'),    // NEU
                    metadata: {
                        timestamp: new Date().toISOString(),
                        version: '2.0.0',
                        backupId: backupId,
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    }
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // Sicherer Download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'led-backup-' + backupId + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URL nach Download freigeben
                setTimeout(() => URL.revokeObjectURL(link.href), 1000);
                
                showNotification('Download gestartet!', 'success');
                
            } catch (error) {
                console.error('Download-Fehler:', error);
                showNotification('Download fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Update Functions
        function updateSyncStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = statusEl.querySelector('.status-icon');
            const textEl = statusEl.querySelector('strong');
            
            statusEl.className = `sync-status ${type}`;
            textEl.textContent = message;
            
            iconEl.className = `fas status-icon ${type}`;
            if (type === 'syncing') {
                iconEl.className += ' fa-sync-alt';
            } else if (type === 'error') {
                iconEl.className += ' fa-exclamation-triangle';
            } else {
                iconEl.className += ' fa-check-circle';
            }
        }

        // Sichere DOM-Manipulation ohne innerHTML (XSS-Schutz)
        function updateBackupList() {
            const listEl = document.getElementById('backupList');
            if (!listEl) return;
            
            // Liste leeren
            // ‚úÖ SICHERE DOM-MANIPULATION STATT innerHTML
            while (listEl.firstChild) {
                listEl.removeChild(listEl.firstChild);
            }
            
            backups.forEach(backup => {
                const backupItem = createBackupItemElement(backup);
                listEl.appendChild(backupItem);
            });
        }
        
        // Sichere Erstellung von Backup-Elementen
        function createBackupItemElement(backup) {
            const item = document.createElement('div');
            item.className = 'backup-item';
            
            // Details
            const details = document.createElement('div');
            details.className = 'backup-details';
            
            const name = document.createElement('div');
            name.className = 'backup-name';
            name.textContent = sanitizeText(backup.name);
            
            const meta = document.createElement('div');
            meta.className = 'backup-meta';
            const dateStr = formatDate(backup.date);
            const typeStr = backup.type === 'full' ? 'Vollst√§ndig' : 'Teilweise';
            meta.textContent = dateStr + ' ‚Ä¢ ' + typeStr;
            
            details.appendChild(name);
            details.appendChild(meta);
            
            // Gr√∂√üe
            const size = document.createElement('div');
            size.className = 'backup-size';
            size.textContent = sanitizeText(backup.size);
            
            // Aktionen
            const actions = document.createElement('div');
            actions.className = 'backup-actions';
            
            // Wiederherstellen-Button
            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'btn btn-small';
            restoreBtn.setAttribute('data-backup-id', backup.id);
            
            const restoreIcon = document.createElement('i');
            restoreIcon.className = 'fas fa-undo';
            restoreIcon.setAttribute('aria-hidden', 'true');
            
            restoreBtn.appendChild(restoreIcon);
            restoreBtn.appendChild(document.createTextNode(' Wiederherstellen'));
            restoreBtn.addEventListener('click', () => restoreBackup(backup.id));
            
            // Download-Button
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn btn-small btn-outline';
            
            const downloadIcon = document.createElement('i');
            downloadIcon.className = 'fas fa-download';
            downloadIcon.setAttribute('aria-hidden', 'true');
            
            downloadBtn.appendChild(downloadIcon);
            downloadBtn.addEventListener('click', () => downloadBackup(backup.id));
            
            actions.appendChild(restoreBtn);
            actions.appendChild(downloadBtn);
            
            item.appendChild(details);
            item.appendChild(size);
            item.appendChild(actions);
            
            return item;
        }
        
        // Text-Sanitization gegen XSS
        function sanitizeText(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Heute';
            if (days === 1) return 'Gestern';
            return `${days} Tage`;
        }

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                importBackup(files[0]);
            }
        });

        // Notification System
        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            // Sichere DOM-Manipulation ohne innerHTML
            const icon = document.createElement('i');
            icon.className = `fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}`;
            icon.setAttribute('aria-hidden', 'true');
            
            const span = document.createElement('span');
            span.textContent = message;
            
            notification.appendChild(icon);
            notification.appendChild(span);
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateBackupList();
            // Backup-System initialisiert
        });
    </script>
</body>
</html>
